# FE-007-07: 后端API服务

## 元数据
- **功能ID**: FE-007-07
- **来源需求**: REQ-007
- **功能类型**: 功能性
- **优先级**: P0 (关键功能)
- **状态**: 待设计 v2.0 (技术栈更新为Golang)
- **负责平台**: Cloud (云平台端)

## 功能描述

### 核心功能
实现云平台账号系统的完整后端API服务，包括组织管理、用户管理、角色管理、权限验证、登录注册等核心功能。

### API架构设计

#### 技术栈
- **框架**: Golang (Go 1.21+) + Gin
- **数据库**: PostgreSQL 14+
- **ORM**: GORM
- **缓存**: Redis 7.0+ (go-redis/redis-go)
- **认证**: JWT (JSON Web Token) - golang-jwt/jwt
- **API文档**: Swagger/OpenAPI 3.0 (swaggo)
- **日志**: zap / logrus
- **配置管理**: Viper
- **测试**: testify / ginkgo

#### API模块划分
1. **认证模块** (Auth Module)
2. **组织管理模块** (Organization Module)
3. **用户管理模块** (User Module)
4. **角色管理模块** (Role Module)
5. **权限管理模块** (Permission Module)
6. **租户隔离中间件** (Tenant Isolation Middleware)

## 用户故事

**作为前端开发者**
我想要清晰的RESTful API接口
以便于快速集成前端功能

**作为第三方系统**
我想要通过API访问云平台数据
以便于实现系统集成

**作为平台运维**
我想要完整的API文档和监控
以便于维护和问题排查

## 功能分解

### Cloud后端:
- [ ] **认证模块 API**
  - [ ] POST /api/auth/register/new-company - 新企业注册
  - [ ] POST /api/auth/register/join-company - 加入已有企业
  - [ ] POST /api/auth/send-code - 发送验证码
  - [ ] POST /api/auth/verify-code - 验证验证码
  - [ ] POST /api/auth/login - 用户登录
  - [ ] POST /api/auth/logout - 用户登出
  - [ ] POST /api/auth/refresh-token - 刷新Token
  - [ ] GET /api/auth/current-user - 获取当前用户
  - [ ] POST /api/auth/reset-password - 重置密码
  - [ ] PUT /api/auth/change-password - 修改密码

- [ ] **组织管理模块 API**
  - [ ] POST /api/organizations - 创建组织
  - [ ] GET /api/organizations - 获取组织列表
  - [ ] GET /api/organizations/:id - 获取组织详情
  - [ ] PUT /api/organizations/:id - 更新组织
  - [ ] DELETE /api/organizations/:id - 删除组织
  - [ ] GET /api/organizations/:id/users - 获取组织用户
  - [ ] GET /api/organizations/:id/tree - 获取组织树
  - [ ] POST /api/organizations/:id/upgrade-to-integrator - 升级为集成商
  - [ ] POST /api/organizations/:id/downgrade-to-customer - 降级为下游客户

- [ ] **用户管理模块 API**
  - [ ] POST /api/users - 创建用户
  - [ ] GET /api/users - 获取用户列表
  - [ ] GET /api/users/:id - 获取用户详情
  - [ ] PUT /api/users/:id - 更新用户
  - [ ] DELETE /api/users/:id - 删除用户
  - [ ] PUT /api/users/:id/status - 更新用户状态
  - [ ] POST /api/users/:id/roles - 分配角色
  - [ ] DELETE /api/users/:id/roles/:roleId - 移除角色
  - [ ] GET /api/users/:id/roles - 获取用户角色

- [ ] **角色管理模块 API**
  - [ ] POST /api/roles - 创建角色
  - [ ] GET /api/roles - 获取角色列表
  - [ ] GET /api/roles/:id - 获取角色详情
  - [ ] PUT /api/roles/:id - 更新角色
  - [ ] DELETE /api/roles/:id - 删除角色
  - [ ] POST /api/roles/:id/permissions - 配置权限
  - [ ] GET /api/roles/:id/permissions - 获取角色权限
  - [ ] GET /api/roles/:id/users - 获取拥有该角色的用户

- [ ] **权限管理模块 API**
  - [ ] GET /api/permissions/features - 获取功能权限列表
  - [ ] GET /api/permissions/actions - 获取操作权限列表
  - [ ] GET /api/permissions/tree - 获取权限树
  - [ ] GET /api/permissions/user-permissions - 获取用户所有权限
  - [ ] POST /api/permissions/check - 检查权限

- [ ] **中间件系统**
  - [ ] **认证中间件** (Auth Middleware)
    - [ ] 验证JWT Token
    - [ ] 提取用户信息
    - [ ] Token过期自动刷新

  - [ ] **权限中间件** (Permission Middleware)
    - [ ] requirePermission(permissionCode) - 验证功能权限
    - [ ] requireAction(featureCode, actionCode) - 验证操作权限
    - [ ] requireRole(roleCode) - 验证角色
    - [ ] 权限缓存（Redis）

  - [ ] **租户隔离中间件** (Tenant Isolation Middleware)
    - [ ] 自动添加租户过滤条件
    - [ ] 自动设置租户字段
    - [ ] 跨租户操作拦截

  - [ ] **日志中间件** (Logging Middleware)
    - [ ] 记录所有API请求
    - [ ] 记录敏感操作（增删改）
    - [ ] 记录错误和异常

  - [ ] **限流中间件** (Rate Limit Middleware)
    - [ ] 防止暴力破解
    - [ ] 防止DDoS攻击
    - [ ] 基于IP和用户的限流

- [ ] **数据库设计**
  - [ ] **组织表** (organizations)
    - [ ] id, name, type, industry, serial_number, managed_tenant_id, parent_tenant_id
    - [ ] created_at, updated_at, deleted_at, integrator_since

  - [ ] **用户表** (users)
    - [ ] id, username, password, email, phone, organization_id
    - [ ] status, created_at, updated_at, deleted_at

  - [ ] **角色表** (roles)
    - [ ] id, name, description, organization_id, is_system
    - [ ] created_at, updated_at, deleted_at

  - [ ] **功能权限表** (feature_permissions)
    - [ ] id, code, name, description

  - [ ] **操作权限表** (action_permissions)
    - [ ] id, code, name, description

  - [ ] **角色功能权限关联表** (role_feature_permissions)
    - [ ] role_id, feature_permission_id

  - [ ] **功能操作权限关联表** (feature_action_permissions)
    - [ ] feature_permission_id, action_permission_id

  - [ ] **用户角色关联表** (user_roles)
    - [ ] user_id, role_id

  - [ ] **验证码表** (verification_codes)
    - [ ] id, target, code, type, created_at, expired_at

  - [ ] **登录日志表** (login_logs)
    - [ ] id, user_id, ip, user_agent, status, created_at

  - [ ] **审计日志表** (audit_logs)
    - [ ] id, user_id, action, entity_type, entity_id, details, created_at

- [ ] **业务逻辑层**
  - [ ] **服务层** (Service Layer)
    - [ ] AuthService - 认证服务
    - [ ] OrganizationService - 组织服务
    - [ ] UserService - 用户服务
    - [ ] RoleService - 角色服务
    - [ ] PermissionService - 权限服务

  - [ ] **数据访问层** (Repository Layer)
    - [ ] OrganizationRepository
    - [ ] UserRepository
    - [ ] RoleRepository
    - [ ] PermissionRepository

- [ ] **API文档**
  - [ ] Swagger/OpenAPI 3.0文档
  - [ ] 所有接口有详细说明
  - [ ] 提供请求/响应示例
  - [ ] 错误码文档
  - [ ] 接口版本管理 (v1, v2)

- [ ] **测试**
  - [ ] 单元测试 (Jest)
  - [ ] 集成测试 (Supertest)
  - [ ] API测试覆盖率 > 80%
  - [ ] 压力测试 (Artillery)

## 非功能需求

### 性能要求
- API响应时间 P95 < 200ms
- API响应时间 P99 < 500ms
- 支持1000并发请求
- 数据库查询优化（索引、缓存）

### 安全要求
- 所有API需要认证（除登录注册）
- JWT Token签名验证
- 敏感数据加密存储
- SQL注入防护
- XSS防护
- CSRF防护
- API限流（防止暴力破解）

### 可靠性要求
- API可用性 > 99.9%
- 错误处理完善
- 日志记录完整
- 支持优雅降级

### 可维护性要求
- 代码结构清晰（MVC/分层架构）
- 接口版本管理
- 完整的API文档
- 代码注释充分
- 错误码统一管理

## 验收标准

- [ ] **认证模块**
  - [ ] 注册接口正常工作
  - [ ] 登录接口返回JWT Token
  - [ ] Token验证正确
  - [ ] Token刷新正常
  - [ ] 验证码功能正常

- [ ] **组织管理**
  - [ ] CRUD接口正常工作
  - [ ] 租户隔离正确
  - [ ] 组织树查询正确
  - [ ] 升级降级功能正常

- [ ] **用户管理**
  - [ ] CRUD接口正常工作
  - [ ] 角色分配正常
  - [ ] 用户状态管理正常
  - [ ] 租户隔离正确

- [ ] **角色管理**
  - [ ] CRUD接口正常工作
  - [ ] 权限配置正常
  - [ ] 系统角色不可删除
  - [ ] 权限验证正确

- [ ] **权限验证**
  - [ ] 中间件正确拦截无权限请求
  - [ ] 有权限请求正常通过
  - [ ] 权限缓存有效
  - [ ] 权限验证响应时间 < 50ms

- [ ] **API文档**
  - [ ] Swagger文档可访问
  - [ ] 所有接口都有文档
  - [ ] 请求/响应示例完整
  - [ ] 错误码文档完整

- [ ] **测试**
  - [ ] 单元测试覆盖率 > 80%
  - [ ] 集成测试通过
  - [ ] 压力测试通过
  - [ ] 无已知Bug

## 关联文档
- **设计方案**: SOL-007 (待创建)
- **实现计划**: IMP-007 (待创建)
- **测试用例**: TC-007-07 (待创建)
- **API文档**: /api-docs (待部署)

## 依赖关系
- **前置功能**:
  - 无（后端基础功能）
- **后置功能**:
  - 所有前端功能（依赖后端API）
- **并行功能**:
  - FE-007-01 ~ FE-007-06: 可并行开发，先定义API契约

## 变更历史
| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 2026-01-26 | 1.0 | 初始创建 | Claude Code |
| 2026-01-27 | 2.0 | 技术栈更新：后端从Node.js改为Golang，前端升级为React 18 | Claude Code |
