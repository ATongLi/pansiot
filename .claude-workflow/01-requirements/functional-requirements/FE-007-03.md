# FE-007-03: RBAC权限模型

## 元数据
- **功能ID**: FE-007-03
- **来源需求**: REQ-007
- **功能类型**: 功能性
- **优先级**: P0 (关键功能)
- **状态**: 待设计
- **负责平台**: Cloud (云平台端)

## 功能描述

### 核心功能
实现租户级RBAC（基于角色的访问控制）权限模型，支持三级权限架构：系统角色 → 功能权限 → 操作权限。

### 权限架构设计

#### 三级权限架构
```
Level 1: 系统角色（Role）
  ↓ 包含多个
Level 2: 功能权限（Feature Permission）
  ↓ 包含多个
Level 3: 操作权限（Action Permission）
```

#### 1. 系统角色（Role）
**预定义角色**：
- **SYSTEM_ADMIN**（系统管理员）：
  - 不可删除、不可编辑
  - 注册时自动创建
  - 默认拥有所有权限
  - 每个租户独立创建

- **ORGANIZATION_ADMIN**（组织管理员）：
  - 可编辑、可删除
  - 管理组织内部用户和角色

- **NORMAL_USER**（普通用户）：
  - 可编辑、可删除
  - 基础查看权限

**自定义角色**：
- 租户管理员可创建自定义角色
- 基于预定义角色克隆或从零创建
- 可配置任意权限组合

#### 2. 功能权限（Feature Permission）
**功能粒度**：针对功能标签页或功能模块

**预设功能权限**：
- **SYSTEM_CONFIG**（系统配置）：访问系统设置页面
- **ORGANIZATION_MANAGEMENT**（子组织管理）：管理子组织的增删改查
- **USER_MANAGEMENT**（账号管理）：管理用户的增删改查
- **ROLE_MANAGEMENT**（角色管理）：管理角色的增删改查
- **DEVICE_MANAGEMENT**（设备管理）：管理设备的增删改查
- **DATA_VIEW**（数据查看）：查看历史数据和报表
- **ALERT_MANAGEMENT**（告警管理）：查看和处理告警

#### 3. 操作权限（Action Permission）
**操作粒度**：针对功能按钮

**预设操作权限**：
- **VIEW**（查看）：查看数据
- **CREATE**（新增）：创建新数据
- **EDIT**（编辑）：修改已有数据
- **DELETE**（删除）：删除数据
- **EXPORT**（导出）：导出数据
- **IMPORT**（导入）：导入数据

**权限关联示例**：
```
角色: 系统管理员
  └─ 功能权限: USER_MANAGEMENT
      ├─ 操作权限: VIEW
      ├─ 操作权限: CREATE
      ├─ 操作权限: EDIT
      └─ 操作权限: DELETE
```

### 权限配置流程
1. **租户管理员**登录系统
2. 进入"角色管理"页面
3. 创建新角色或选择已有角色
4. 配置角色的功能权限（勾选功能模块）
5. 为每个功能权限配置操作权限（勾选操作类型）
6. 保存角色配置
7. 将角色分配给用户

## 用户故事

**作为一个组织管理员**
我想要创建不同的角色并分配不同的权限
以便于我控制不同员工可以访问的功能

**作为一个系统集成商**
我想要为我的下游客户创建默认的角色模板
以便于快速初始化客户的权限体系

**作为平台开发者**
我想要通过权限中间件验证用户权限
以便于保护API接口不被未授权访问

## 功能分解

### Cloud后端:
- [ ] **数据模型设计**
  - [ ] 创建Role表（id, name, description, organization_id, is_system, is_deleted）
  - [ ] 创建FeaturePermission表（id, code, name, description）
  - [ ] 创建ActionPermission表（id, code, name, description）
  - [ ] 创建RoleFeaturePermission表（role_id, feature_permission_id）
  - [ ] 创建FeatureActionPermission表（feature_permission_id, action_permission_id）
  - [ ] 创建UserRole表（user_id, role_id）

- [ ] **角色管理API**
  - [ ] POST /api/roles - 创建角色
  - [ ] PUT /api/roles/{id} - 更新角色
  - [ ] DELETE /api/roles/{id} - 删除角色（预定义角色不可删除）
  - [ ] GET /api/roles - 获取角色列表
  - [ ] GET /api/roles/{id} - 获取角色详情
  - [ ] POST /api/roles/{id}/permissions - 配置角色权限
  - [ ] GET /api/roles/{id}/permissions - 获取角色权限

- [ ] **权限管理API**
  - [ ] GET /api/permissions/features - 获取所有功能权限
  - [ ] GET /api/permissions/actions - 获取所有操作权限
  - [ ] GET /api/permissions/tree - 获取权限树形结构

- [ ] **用户角色分配API**
  - [ ] POST /api/users/{id}/roles - 为用户分配角色
  - [ ] DELETE /api/users/{id}/roles/{roleId} - 移除用户角色
  - [ ] GET /api/users/{id}/roles - 获取用户的角色列表

- [ ] **权限验证中间件**
  - [ ] requirePermission(permissionCode) - 验证功能权限
  - [ ] requireAction(featureCode, actionCode) - 验证操作权限
  - [ ] requireRole(roleCode) - 验证角色
  - [ ] getUserPermissions(userId) - 获取用户所有权限
  - [ ] hasPermission(userId, permissionCode) - 检查用户是否有权限

- [ ] **业务逻辑**
  - [ ] 创建组织时自动创建SYSTEM_ADMIN角色
  - [ ] SYSTEM_ADMIN角色自动关联所有功能权限和操作权限
  - [ ] 注册用户自动分配SYSTEM_ADMIN角色
  - [ ] 删除角色前检查是否有用户使用
  - [ ] 权限验证缓存（Redis，提升性能）

### Cloud前端:
- [ ] **角色管理页面**
  - [ ] 角色列表（显示角色名、描述、用户数量、系统标识）
  - [ ] 创建角色按钮
  - [ ] 编辑角色按钮（系统管理员角色不可编辑）
  - [ ] 删除角色按钮（系统管理员角色不可删除）
  - [ ] 角色搜索和筛选

- [ ] **角色创建/编辑弹窗**
  - [ ] 角色名称输入
  - [ ] 角色描述输入
  - [ ] 功能权限树形勾选
    - [ ] 第一层：功能权限（复选框）
    - [ ] 第二层：操作权限（复选框）
    - [ ] 支持全选/取消全选
  - [ ] 保存按钮
  - [ ] 取消按钮

- [ ] **用户角色分配**
  - [ ] 在用户详情页面显示当前角色
  - [ ] 添加角色按钮（多选下拉）
  - [ ] 移除角色按钮
  - [ ] 角色显示优先级（系统管理员 > 组织管理员 > 普通用户）

- [ ] **权限配置界面**
  - [ ] 功能模块展示（卡片或表格）
  - [ ] 功能权限勾选
  - [ ] 操作权限勾选（查看、新增、编辑、删除）
  - [ ] 权限预览（显示JSON或表格）
  - [ ] 权限保存

- [ ] **界面权限控制**
  - [ ] 根据用户权限动态显示/隐藏菜单
  - [ ] 根据用户权限动态显示/隐藏按钮
  - [ ] 无权限访问页面时提示"权限不足"
  - [ ] 无权限操作时提示并阻止

## 非功能需求

### 性能要求
- 权限验证响应时间 < 50ms
- 角色列表查询 < 200ms
- 权限树加载 < 300ms
- 支持至少1000个角色/租户

### 安全要求
- 权限验证必须每次请求都验证
- 权限缓存不能长期有效（最多5分钟）
- 系统管理员角色不能被修改或删除
- 敏感操作需要二次权限验证

### 可靠性要求
- 权限验证失败率 < 0.01%
- 权限配置实时生效
- 支持权限回滚

## 验收标准

- [ ] **角色管理**
  - [ ] 可以创建自定义角色
  - [ ] 可以编辑自定义角色
  - [ ] 可以删除自定义角色（无用户使用时）
  - [ ] 系统管理员角色不可编辑、不可删除
  - [ ] 删除角色前检查是否有用户使用

- [ ] **权限配置**
  - [ ] 可以为角色配置功能权限
  - [ ] 可以为角色配置操作权限
  - [ ] 权限配置实时生效
  - [ ] 系统管理员角色拥有所有权限
  - [ ] 权限树正确显示层级关系

- [ ] **用户角色分配**
  - [ ] 可以为用户分配角色
  - [ ] 可以为用户分配多个角色
  - [ ] 可以移除用户的角色
  - [ ] 用户权限是所有角色权限的并集

- [ ] **权限验证**
  - [ ] 有权限的用户可以正常访问功能
  - [ ] 无权限的用户访问功能时提示"权限不足"
  - [ ] 前端根据权限动态显示/隐藏菜单和按钮
  - [ ] 后端API验证权限，无权限返回403
  - [ ] 权限验证响应时间 < 50ms

- [ ] **预设角色**
  - [ ] 注册组织时自动创建系统管理员角色
  - [ ] 系统管理员角色默认拥有所有权限
  - [ ] 注册用户自动分配系统管理员角色
  - [ ] 预设组织管理员和普通用户角色

## 关联文档
- **设计方案**: SOL-007 (待创建)
- **实现计划**: IMP-007 (待创建)
- **测试用例**: TC-007-03 (待创建)
- **API文档**: /api/roles, /api/permissions (待创建)

## 依赖关系
- **前置功能**:
  - FE-007-01: 多租户组织管理（角色关联组织）
  - FE-007-02: 用户注册与登录（用户需要关联角色）
- **后置功能**:
  - 所有其他功能模块（都需要权限验证）
- **并行功能**:
  - FE-007-01, FE-007-02: 可并行开发，使用mock权限

## 变更历史
| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 2026-01-26 | 1.0 | 初始创建 | Claude Code |
