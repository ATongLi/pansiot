# FE-007-01: 多租户组织管理

## 元数据
- **功能ID**: FE-007-01
- **来源需求**: REQ-007
- **功能类型**: 功能性
- **优先级**: P0 (关键功能)
- **状态**: 待设计 v2.1 (根据反馈完善)
- **负责平台**: Cloud (云平台端)

## 功能描述

### 核心功能
实现支持多层租户架构的组织管理系统，支持租户类型区分、多级组织层级、管理租户与父租户的区分。

### 主要特性

#### 1. 租户类型设计
**租户类型字段**：`tenant_type`（必填）
- **TERMINAL**（终端租户）：
  - 最终使用租户，通常是下游客户
  - 必须设置管理租户（managed_tenant_id）
  - 可以创建子组织和用户

- **INTEGRATOR**（集成商租户）：
  - 一级管控主体，可以创建和管理下游租户
  - managed_tenant_id为NULL（由平台直接管理）
  - 可以创建终端租户和其他集成商租户

#### 2. 组织实体设计
**基础属性**：
- `tenant_id`：租户ID（主键）
- `name`：企业名称
- `tenant_type`：租户类型（TERMINAL/INTEGRATOR）
- `industry`：所属行业
- `serial_number`：企业序列号（全局唯一）

**层级关系字段**：
- **`managed_tenant_id`**（管理租户ID）：
  - 标识租户由哪个集成商管理
  - 对于终端租户：指向其管理集成商
  - 对于集成商租户：为NULL
  - 用于数据隔离和权限管控
  - 集成商可以查看所有managed_tenant_id指向自己的下游数据

- **`parent_tenant_id`**（父租户ID）：
  - 标识直接上级组织
  - 支持多级层级（集成商 → 一级下游 → 二级下游 → ...）
  - 用于组织树形结构和权限继承
  - 可能指向集成商或其他下游租户

**元数据**：
- `created_at`：创建时间
- `updated_at`：更新时间
- `deleted_at`：删除时间（软删除）

#### 3. 字段区别说明

**managed_tenant_id vs parent_tenant_id**：

| 维度 | managed_tenant_id | parent_tenant_id |
|------|---------------------|------------------|
| 用途 | 数据隔离和权限管控 | 组织层级展示和继承 |
| 指向对象 | 总是指向集成商租户 | 可能是集成商或其他下游租户 |
| 集成商租户 | NULL | NULL（顶级）或指向其他集成商 |
| 终端租户 | 指向管理集成商 | 指向直接上级（可能是集成商或下游租户） |
| 查询场景 | 集成商查看所有下游数据 | 组织树形结构展示 |

**示例场景**：
```
集成商A (tenant_type=INTEGRATOR, managed_tenant_id=NULL, parent_tenant_id=NULL)
  ├─ 下游客户B (tenant_type=TERMINAL, managed_tenant_id=集成商A, parent_tenant_id=集成商A)
  │   └─ 子组织C (tenant_type=TERMINAL, managed_tenant_id=集成商A, parent_tenant_id=下游客户B)
  └─ 下游客户D (tenant_type=TERMINAL, managed_tenant_id=集成商A, parent_tenant_id=集成商A)
```

在这个示例中：
- 子组织C的managed_tenant_id指向集成商A（数据隔离）
- 子组织C的parent_tenant_id指向下游客户B（层级关系）
- 集成商A可以查看B、C、D的数据（managed_tenant_id=A）
- 组织树：A → B → C（parent_tenant_id关系）

#### 4. 企业序列号生成
- **格式**：`{4位随机字符}{4位自增ID}`
- **示例**：`A3F20001`（总长度8位）
- **特点**：极简长度、全局唯一、不易猜测、生成效率高
- **生成规则**：租户创建时自动生成，不可修改
- **输入界面**：自动格式化为 `XXXX XXXX`（4-4格式）

#### 5. 组织管理功能
- **创建组织**：集成商创建下游租户
- **更新组织信息**：修改企业名称、所属行业等
- **查询组织列表**：支持层级查询、类型筛选
- **删除组织**：级联检查（检查子组织和用户）
- **组织树形结构展示**：基于parent_tenant_id的层级树

## 用户故事

**作为一个系统集成商**
我想要创建和管理我的下游客户组织
以便于我为多个客户提供独立的物联网服务

**作为一个下游客户管理员**
我想要在我的组织下创建子组织
以便于我在内部进行更细粒度的管理

**作为平台超管**
我想要查看所有组织的层级关系
以便于进行平台管理和监控

## 功能分解

### Cloud后端:
- [ ] **数据模型设计**
  - [ ] 创建Tenant表（租户表）
    - [ ] `tenant_id` BIGINT PK
    - [ ] `name` VARCHAR(200) - 企业名称
    - [ ] `tenant_type` ENUM('TERMINAL', 'INTEGRATOR') - 租户类型
    - [ ] `industry` VARCHAR(100) - 所属行业
    - [ ] `serial_number` VARCHAR(8) UNIQUE - 企业序列号
    - [ ] `managed_tenant_id` BIGINT NULL - 管理租户ID（集成商）
    - [ ] `parent_tenant_id` BIGINT NULL - 父租户ID（直接上级）
    - [ ] `created_at` TIMESTAMP
    - [ ] `updated_at` TIMESTAMP
    - [ ] `deleted_at` TIMESTAMP NULL
    - [ ] 索引：`idx_tenant_type`, `idx_managed_tenant_id`, `idx_parent_tenant`, `idx_serial_number`
  - [ ] 创建租户类型枚举（TERMINAL, INTEGRATOR）
  - [ ] 创建企业序列号生成器（全局唯一保证）

- [ ] **组织管理API**
  - [ ] POST /api/tenants - 创建租户
  - [ ] PUT /api/tenants/{id} - 更新租户信息
  - [ ] GET /api/tenants/{id} - 获取租户详情
  - [ ] GET /api/tenants - 查询租户列表（支持tenant_type和parent_tenant_id过滤）
  - [ ] DELETE /api/tenants/{id} - 删除租户（级联检查）
  - [ ] GET /api/tenants/tree - 获取租户树形结构（基于parent_tenant_id）

- [ ] **业务逻辑**
  - [ ] 创建租户时自动生成企业序列号
  - [ ] 验证租户层级深度（防止无限嵌套，最多5级）
  - [ ] 创建租户时自动设置字段：
    - [ ] 如果当前用户是集成商，managed_tenant_id设置为当前租户ID
    - [ ] 如果创建子租户，parent_tenant_id设置为父租户ID
    - [ ] 集成商创建的租户，managed_tenant_id指向集成商
  - [ ] 删除租户前检查是否有子租户或用户
  - [ ] 租户类型验证：
    - [ ] TERMINAL类型必须设置managed_tenant_id
    - [ ] INTEGRATOR类型的managed_tenant_id必须为NULL

- [ ] **权限控制**
  - [ ] 集成商只能创建和查看managed_tenant_id指向自己的下游租户
  - [ ] 终端租户只能查看parent_tenant_id是自己的子租户
  - [ ] 平台超管可以查看所有租户

### Cloud前端:
- [ ] **租户列表页面**
  - [ ] 租户列表表格（显示企业名称、租户类型、序列号、管理租户、父租户、创建时间）
  - [ ] 支持按租户类型筛选（TERMINAL/INTEGRATOR）
  - [ ] 支持搜索企业名称
  - [ ] 显示租户层级关系（面包屑或树形）
  - [ ] 租户类型标签显示（集成商/终端租户）

- [ ] **租户创建/编辑表单**
  - [ ] 企业名称输入（必填）
  - [ ] 租户类型选择（TERMINAL/INTEGRATOR，根据权限显示）
  - [ ] 所属行业下拉选择（预设选项 + "其他"）
  - [ ] 其他行业输入（选择"其他"时显示）
  - [ ] 父租户选择（树形下拉，集成商创建下游时默认为集成商自己）
  - [ ] 管理租户显示（自动设置为当前集成商，不可编辑）
  - [ ] 表单验证（租户类型与管理租户的一致性）
  - [ ] 字段说明提示（管理租户vs父租户的区别）

- [ ] **租户详情页面**
  - [ ] 显示租户基本信息（企业名称、类型、行业）
  - [ ] 显示企业序列号（可复制）
  - [ ] 显示管理租户（集成商）
  - [ ] 显示父租户（直接上级）
  - [ ] 显示租户层级路径
  - [ ] 显示该租户下的用户数量
  - [ ] 显示该租户下的子租户数量
  - [ ] 租户类型说明（当前是集成商还是终端租户）

- [ ] **界面简化逻辑**
  - [ ] 非集成商用户：隐藏"租户类型"选项，默认为TERMINAL
  - [ ] 非集成商用户：隐藏"管理租户"字段
  - [ ] 终端租户用户：隐藏"创建下游租户"按钮

## 非功能需求

### 性能要求
- 组织列表查询响应时间 < 200ms
- 组织树形结构查询 < 500ms
- 企业序列号生成 < 10ms

### 安全要求
- 不同集成商的组织数据严格隔离
- 企业序列号不可猜测（4位随机字符+自增ID）
- 敏感操作需要权限验证

### 可靠性要求
- 企业序列号全局唯一，不能重复
- 组织删除必须级联检查，防止孤儿数据
- 支持至少10万级组织数据

## 验收标准

- [ ] **租户创建**
  - [ ] 集成商可以创建下游租户（tenant_type=TERMINAL）
  - [ ] 创建时自动生成企业序列号（格式正确、全局唯一）
  - [ ] 创建后managed_tenant_id自动设置为集成商ID
  - [ ] 创建后parent_tenant_id正确设置（直接上级）
  - [ ] 终端租户的managed_tenant_id必须指向集成商
  - [ ] 集成商租户的managed_tenant_id为NULL
  - [ ] 终端租户可以创建子租户，层级关系正确

- [ ] **租户查询**
  - [ ] 集成商只能看到managed_tenant_id指向自己的下游租户
  - [ ] 终端租户只能看到parent_tenant_id是自己的子租户
  - [ ] 平台超管可以看到所有租户
  - [ ] 支持按tenant_type筛选租户
  - [ ] 组织树形结构正确显示层级关系（基于parent_tenant_id）

- [ ] **租户编辑**
  - [ ] 可以更新企业名称和所属行业
  - [ ] tenant_type创建后不可修改
  - [ ] managed_tenant_id创建后不可修改
  - [ ] parent_tenant_id可以调整（重新组织层级）

- [ ] **租户删除**
  - [ ] 删除租户前检查是否有子租户
  - [ ] 删除租户前检查是否有关联用户
  - [ ] 有子租户或用户的租户不允许删除

- [ ] **租户类型**
  - [ ] 租户类型正确显示（集成商/终端租户）
  - [ ] TERMINAL类型的managed_tenant_id不为NULL
  - [ ] INTEGRATOR类型的managed_tenant_id为NULL

- [ ] **字段区别**
  - [ ] managed_tenant_id正确指向管理集成商
  - [ ] parent_tenant_id正确指向直接上级
  - [ ] 多级层级关系正确（集成商→一级下游→二级下游）
  - [ ] 集成商可以通过managed_tenant_id查看所有下游数据

- [ ] **界面简化**
  - [ ] 非集成商用户创建租户时隐藏"租户类型"选项
  - [ ] 非集成商用户不显示"管理租户"字段
  - [ ] 终端租户用户不显示"创建下游租户"按钮
  - [ ] 根据租户类型动态显示功能

## 关联文档
- **设计方案**: SOL-007 (待创建)
- **实现计划**: IMP-007 (待创建)
- **测试用例**: TC-007-01 (待创建)
- **API文档**: /api/organizations (待创建)

## 依赖关系
- **前置功能**: 无（基础功能）
- **后置功能**:
  - FE-007-02: 用户注册与登录（需要组织实体）
  - FE-007-03: RBAC权限模型（需要组织关联角色）
  - FE-007-04: 租户数据隔离（需要managed_tenant_id字段）
- **并行功能**:
  - FE-007-02: 可并行开发，使用mock组织

## 变更历史
| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 2026-01-26 | 1.0 | 初始创建 | Claude Code |
| 2026-01-26 | 2.0 | 根据反馈完善：1. 添加tenant_type字段（TERMINAL/INTEGRATOR） 2. 区分managed_tenant_id和parent_tenant_id 3. 统一字段命名（tenant_id, managed_tenant_id） 4. 更新数据模型和验收标准 | Claude Code |
| 2026-01-27 | 2.1 | 企业序列号精简：从20位简化为8位（4位随机字符+4位自增ID） | Claude Code |
