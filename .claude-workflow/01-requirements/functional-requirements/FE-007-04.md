# FE-007-04: 租户数据隔离

## 元数据
- **功能ID**: FE-007-04
- **来源需求**: REQ-007
- **功能类型**: 功能性
- **优先级**: P0 (关键功能)
- **状态**: 待设计
- **负责平台**: Cloud (云平台端)

## 功能描述

### 核心功能
实现多租户数据隔离，通过`tenant_id`（归属租户ID）和`managed_tenant_id`（管理租户ID）字段实现数据单向可视和跨主体严格隔离。

### 数据隔离设计

#### 双字段设计
所有业务表（设备、账号、告警、日志等）包含两个关键字段：

1. **tenant_id**（归属租户ID）：
   - 标识数据的归属主体
   - 数据创建时自动设置为当前用户所属组织ID
   - 下游客户只能看到`tenant_id`等于自己组织ID的数据

2. **managed_tenant_id**（管理租户ID）：
   - 标识数据的管控主体（集成商）
   - 数据创建时自动设置为当前用户所属组织的`managed_tenant_id`
   - 集成商可以看到`managed_tenant_id`等于自己组织ID的所有下游数据

#### 数据隔离规则

**场景1：下游客户查看数据**
```sql
-- 只能看到自己创建的数据
WHERE tenant_id = {current_user_organization_id}
```

**场景2：集成商查看数据**
```sql
-- 可以看到所有下游客户的数据
WHERE managed_tenant_id = {current_integrator_id}
```

**场景3：平台超管查看数据**
```sql
-- 可以看到所有数据（无过滤）
-- 或者查看所有集成商的数据
WHERE managed_tenant_id IN (SELECT id FROM organizations WHERE type = 'INTEGRATOR')
```

**场景4：跨主体隔离**
```sql
-- 集成商A不能看到集成商B的下游数据
WHERE managed_tenant_id = {current_integrator_id}  -- 自动过滤其他集成商
```

### 适用表范围

**必须包含双字段的表**：
- `devices`（设备表）
- `users`（用户表）
- `alerts`（告警表）
- `logs`（日志表）
- `data_points`（数据点表）
- `dashboards`（仪表板表）
- `reports`（报表表）
- `organizations`（组织表，仅managed_tenant_id字段）

**不包含双字段的表**：
- 系统配置表（全局共享）
- 权限定义表（全局共享）
- 字典表（全局共享）

### 数据继承规则

**创建数据时的字段自动填充**：
1. **集成商创建数据**：
   - `tenant_id` = 集成商自己的ID
   - `managed_tenant_id` = NULL（平台超管级别）

2. **下游客户创建数据**：
   - `tenant_id` = 下游客户自己的ID
   - `managed_tenant_id` = 集成商的ID（继承自组织的managed_tenant_id）

3. **下游客户创建子组织数据**：
   - `tenant_id` = 子组织的ID
   - `managed_tenant_id` = 集成商的ID（继承自父组织）

## 用户故事

**作为一个集成商**
我想要查看所有下游客户的设备数据
以便于我进行全局监控和故障排查

**作为一个下游客户**
我想要只能看到自己的数据
以便于保护我的业务隐私和数据安全

**作为平台开发者**
我想要通过统一的查询中间件实现数据隔离
以便于避免手动过滤导致的权限漏洞

## 功能分解

### Cloud后端:
- [ ] **数据模型设计**
  - [ ] 为所有业务表添加`tenant_id`字段（BIGINT, NOT NULL）
  - [ ] 为所有业务表添加`managed_tenant_id`字段（BIGINT, NULL）
  - [ ] 创建索引：`idx_tenant_id`, `idx_managed_tenant_id`
  - [ ] 创建复合索引：`idx_tenant_managed` (tenant_id, managed_tenant_id)

- [ ] **数据隔离中间件**
  - [ ] **TenantQueryFilter** - 查询过滤器
    - [ ] 自动在查询条件中添加`tenant_id`或`managed_tenant_id`
    - [ ] 根据当前用户角色自动选择过滤规则
    - [ ] 支持关闭过滤器（超级管理员）

  - [ ] **TenantDataHook** - 数据钩子
    - [ ] `beforeCreate`: 自动设置`tenant_id`和`managed_tenant_id`
    - [ ] `beforeUpdate`: 阻止跨租户修改
    - [ ] `beforeDelete`: 阻止跨租户删除

  - [ ] **TenantPermissionGuard** - 权限守卫
    - [ ] 验证用户是否有权限访问目标租户数据
    - [ ] 验证用户是否有权限修改目标租户数据
    - [ ] 跨租户操作时抛出权限异常

- [ ] **业务逻辑**
  - [ ] 创建数据时自动填充`tenant_id`和`managed_tenant_id`
  - [ ] 查询数据时自动添加租户过滤条件
  - [ ] 更新/删除数据时验证租户权限
  - [ ] 集成商查询时使用`managed_tenant_id`过滤
  - [ ] 下游客户查询时使用`tenant_id`过滤
  - [ ] 支持租户数据导出（带水印）

- [ ] **API增强**
  - [ ] 所有GET请求自动应用租户过滤
  - [ ] 所有POST请求自动设置租户字段
  - [ ] 所有PUT/DELETE请求验证租户权限
  - [ ] 支持`?all_tenants=true`参数（仅集成商）

- [ ] **数据迁移**
  - [ ] 为现有数据填充`tenant_id`和`managed_tenant_id`
  - [ ] 创建数据完整性检查脚本
  - [ ] 修复孤儿数据（tenant_id为NULL的数据）

### Cloud前端:
- [ ] **数据查询界面**
  - [ ] 集成商视图：显示所有下游数据（按租户分组）
  - [ ] 下游客户视图：仅显示自己的数据
  - [ ] 租户筛选器（仅集成商可见）
  - [ ] 数据归属标签（显示"XX租户的数据"）

- [ ] **数据详情页面**
  - [ ] 显示数据归属组织
  - [ ] 显示数据管理组织
  - [ ] 集成商可以切换租户视角

- [ ] **统计报表**
  - [ ] 集成商：按下游客户分组的统计
  - [ ] 下游客户：仅显示自己的统计
  - [ ] 跨租户对比报表（仅集成商）

- [ ] **界面提示**
  - [ ] 数据隔离提示（"您正在查看XX租户的数据"）
  - [ ] 权限不足提示（"您无权查看其他租户的数据"）

## 非功能需求

### 性能要求
- 查询过滤响应时间 < 100ms
- 数据继承字段自动填充 < 10ms
- 索引优化确保大表查询性能
- 支持100万级数据量

### 安全要求
- 数据隔离无漏洞，不能通过任何方式绕过
- 所有查询必须经过租户过滤
- 所有修改必须验证租户权限
- 定期检查数据完整性

### 可靠性要求
- 数据隔离失败率 < 0.001%
- 支持99.99%的数据隔离正确性
- 孤儿数据自动检测和修复

## 验收标准

- [ ] **数据创建**
  - [ ] 集成商创建数据时，tenant_id设置为自己，managed_tenant_id为NULL
  - [ ] 下游客户创建数据时，tenant_id设置为自己，managed_tenant_id设置为集成商ID
  - [ ] 子组织创建数据时，managed_tenant_id继承父组织的managed_by
  - [ ] 双字段自动填充无错误

- [ ] **数据查询**
  - [ ] 下游客户查询只能看到tenant_id等于自己ID的数据
  - [ ] 集成商查询可以看到managed_tenant_id等于自己ID的所有下游数据
  - [ ] 不同集成商的数据严格隔离（集成商A看不到集成商B的下游数据）
  - [ ] 平台超管可以看到所有数据
  - [ ] 查询性能 < 200ms

- [ ] **数据修改**
  - [ ] 下游客户不能修改其他下游客户的数据
  - [ ] 集成商不能修改其他集成商的下游数据
  - [ ] 跨租户修改抛出权限异常
  - [ ] 权限验证100%触发

- [ ] **数据删除**
  - [ ] 下游客户不能删除其他下游客户的数据
  - [ ] 集成商可以删除下游客户的数据（业务逻辑决定）
  - [ ] 跨租户删除抛出权限异常
  - [ ] 级联删除正确处理

- [ ] **统计报表**
  - [ ] 集成商统计包含所有下游数据
  - [ ] 下游客户统计仅包含自己的数据
  - [ ] 租户筛选器仅对集成商显示
  - [ ] 跨租户对比报表正确计算

- [ ] **数据完整性**
  - [ ] 所有业务数据都有正确的tenant_id
  - [ ] 下游客户的数据都有正确的managed_tenant_id
  - [ ] 没有孤儿数据（tenant_id为NULL）
  - [ ] 数据继承关系正确

## 关联文档
- **设计方案**: SOL-007 (待创建)
- **实现计划**: IMP-007 (待创建)
- **测试用例**: TC-007-04 (待创建)
- **数据模型**: database-schema.sql (待创建)

## 依赖关系
- **前置功能**:
  - FE-007-01: 多租户组织管理（需要managed_tenant_id字段）
- **后置功能**:
  - 所有业务功能（都需要数据隔离）
- **并行功能**:
  - FE-007-01, FE-007-02, FE-007-03: 可并行开发，先预留字段

## 变更历史
| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 2026-01-26 | 1.0 | 初始创建 | Claude Code |
