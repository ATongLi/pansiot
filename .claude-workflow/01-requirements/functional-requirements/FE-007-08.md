# FE-007-08: 功能模块与配额管理

## 元数据
- **功能ID**: FE-007-08
- **来源需求**: REQ-007 (场景8)
- **功能类型**: 功能性
- **优先级**: P0 (关键功能)
- **状态**: 待设计
- **负责平台**: Cloud (云平台端)

## 功能描述

### 核心功能
实现平台功能模块的分级开通管理和配额分配系统，支持平台超管→集成商→下游客户的三级配额分配和管控。

### 功能模块管理

#### 系统默认功能 vs 可选功能

**系统默认功能**（所有租户自动拥有）：
1. **system_config**（系统配置）
   - 基础系统设置
   - 无配额限制
   - 前端始终显示

2. **user_management**（用户管理）
   - 租户内用户创建和管理
   - 无配额限制
   - 前端始终显示

3. **role_management**（角色管理）
   - 角色和权限配置
   - 无配额限制
   - 前端始终显示

**可选功能**（需要开通，有配额限制）：
1. **device_management**（设备管理）
   - 设备接入和管理
   - 配额单位：设备数量

2. **web_editor**（Web工程编辑器）
   - Web可视化工程编辑
   - 配额单位：工程数量

3. **data_dashboard**（数据看板）
   - 数据可视化看板
   - 配额单位：看板数量

4. **alert_service**（告警服务）
   - 告警规则和通知
   - 配额单位：告警规则数量

5. **data_storage**（数据存储）
   - 历史数据存储
   - 配额单位：存储空间（GB）

6. **api_access**（API访问）
   - API调用次数
   - 配额单位：调用次数（次/月）

### 配额管理模型

#### 配额分配流程
```
平台超管
  └─ 分配配额给集成商
      ├─ 集成商自己使用（used_quota）
      ├─ 分配给下游客户A（allocated_quota的一部分）
      ├─ 分配给下游客户B（allocated_quota的一部分）
      └─ 剩余可用（total - used - allocated）
```

#### 配额计算规则
- **终端租户**：
  - `remaining_quota` = `total_quota` - `used_quota`
  - `allocated_quota` = NULL

- **集成商租户**：
  - `available_quota` = `total_quota` - `used_quota` - `allocated_quota`
  - `remaining_quota` = `total_quota` - `used_quota`（用于显示）
  - `allocated_quota` = Σ(所有下游租户的配额)

### 业务场景

#### 场景1：平台超管开通功能给集成商
1. 平台超管进入"租户管理" → 选择集成商 → "功能开通"
2. 系统显示功能模块列表（区分系统默认和可选）
3. 勾选要开通的可选模块（如：device_management, web_editor）
4. 为每个模块设置配额：
   - device_management: 1000台设备
   - web_editor: 50个工程
   - data_storage: 100GB
5. 保存后，集成商可以查看和使用这些功能

#### 场景2：集成商分配配额给下游客户
1. 集成商进入"子组织管理" → 选择下游客户A → "功能开通"
2. 系统显示集成商拥有的功能列表
3. 勾选要给客户A开通的功能
4. 为每个模块分配配额（不能超过集成商自己的剩余配额）：
   - device_management: 集成商剩余500 → 分配给客户A 200
   - web_editor: 集成商剩余25 → 分配给客户A 10
5. 保存后，客户A可以使用这些功能

#### 场景3：租户使用配额
- 创建设备时：检查 device_management 配额是否充足
- 创建Web工程时：检查 web_editor 配额是否充足
- 存储数据时：检查 data_storage 配额是否充足
- API调用时：检查 api_access 配额是否充足

#### 场景4：前端动态显示
- 已开通的功能：在导航菜单和页面中显示
- 未开通的功能：完全隐藏，用户看不到入口
- 系统默认功能：始终显示，无法隐藏

## 用户故事

**作为平台超管**
我想要为租户开通功能模块并分配配额
以便于控制资源使用和进行计费管理

**作为集成商**
我想要为下游客户分配功能配额
以便于我的客户可以使用相关功能

**作为下游客户**
我想要查看自己的配额使用情况
以便于合理使用资源并及时申请增加配额

**作为系统**
我想要在配额不足时阻止资源创建
以便于保证系统稳定性和资源可控性

## 功能分解

### Cloud后端:
- [ ] **数据模型设计**
  - [ ] **tenant_quota_usage** 表
    - [ ] id, tenant_id, module_code
    - [ ] total_quota, used_quota, remaining_quota, allocated_quota
    - [ ] updated_at
    - [ ] 索引：idx_tenant_module, idx_remaining

  - [ ] **tenant_features** 表（租户功能开通记录）
    - [ ] id, tenant_id, module_code
    - [ ] is_active, granted_by（谁开通的）
    - [ ] granted_at, expires_at
    - [ ] 索引：idx_tenant_module, idx_active

  - [ ] **feature_modules** 表（功能模块定义）
    - [ ] id, code, name, description
    - [ ] is_system_default（是否系统默认）
    - [ ] default_quota（默认配额）
    - [ ] quota_unit（配额单位：count, gb, times_per_month）

- [ ] **配额管理API**
  - [ ] GET /api/features/modules - 获取所有功能模块列表
  - [ ] POST /api/tenants/{id}/features - 为租户开通功能
  - [ ] PUT /api/tenants/{id}/features/{module} - 更新租户配额
  - [ ] DELETE /api/tenants/{id}/features/{module} - 停用租户功能
  - [ ] GET /api/tenants/{id}/features - 获取租户已开通功能
  - [ ] GET /api/tenants/{id}/quota/{module} - 获取配额使用情况

- [ ] **配额检查中间件**
  - [ ] quotaCheck(moduleCode, quotaUnit) - 配额检查
  - [ ] quotaUsed(moduleCode, quantity) - 配额消耗
  - [ ] quotaReleased(moduleCode, quantity) - 配额释放
  - [ ] 实时配额验证（创建资源前）
  - [ ] 配额不足时抛出 QuotaExceededError

- [ ] **业务逻辑**
  - [ ] 开通功能时验证层级关系（集成商只能开通自己拥有的功能）
  - [ ] 分配配额时验证剩余配额是否充足
  - [ ] 创建资源时自动检查配额
  - [ ] 删除资源时自动释放配额
  - [ ] 配额继承计算（集成商的allocated_quota = Σ下游配额）

- [ ] **配额统计**
  - [ ] 实时配额使用统计
  - [ ] 按模块统计配额使用率
  - [ ] 按下游租户统计配额分配
  - [ ] 配额告警（达到80%、90%、100%）

### Cloud前端:
- [ ] **平台超管界面**
  - [ ] 功能模块管理页面
    - [ ] 模块列表展示（系统默认/可选）
    - [ ] 全局默认配额设置
    - [ ] 模块启用/禁用

  - [ ] 租户功能开通页面
    - [ ] 选择租户
    - [ ] 显示已开通功能
    - [ ] 开通新功能（勾选模块）
    - [ ] 设置租户配额
    - [ ] 保存开通记录

- [ ] **集成商界面**
  - [ ] 下游客户功能开通页面
    - [ ] 选择下游客户
    - [ ] 显示集成商拥有的功能
    - [ ] 勾选要给客户开通的功能
    - [ ] 分调配额（显示剩余可用配额）
    - [ ] 保存分配记录

  - [ ] 我的配额页面
    - [ ] 按模块显示配额使用情况（已用/总共/剩余）
    - [ ] 显示已分配给下游的配额
    - [ ] 显示剩余可用配额
    - [ ] 配额使用率图表

- [ ] **终端租户界面**
  - [ ] 我的配额页面（简化版）
    - [ ] 按模块显示配额使用情况
    - [ ] 不显示配额分配功能
    - [ ] 显示配额不足提示

- [ ] **动态菜单系统**
  - [ ] 根据功能开通情况显示/隐藏菜单项
    - [ ] 已开通：显示菜单和页面
    - [ ] 未开通：完全隐藏入口
    - [ ] 系统默认：始终显示
  - [ ] 菜单权限验证（前端+后端双重验证）

- [ ] **配额提示组件**
  - [ ] 创建资源时显示配额剩余
  - [ ] 配额不足时阻止创建并提示
  - [ ] 显示配额使用率进度条
  - [ ] 联系管理员申请增加配额

### 数据库:
- [ ] 创建 tenant_quota_usage 表
- [ ] 创建 tenant_features 表
- [ ] 创建 feature_modules 表
- [ ] 创建索引优化查询性能
- [ ] 创建配额检查触发器（可选）

## 非功能需求

### 性能要求
- 配额检查响应时间 < 50ms
- 配额统计查询 < 200ms
- 支持10万级租户并发配额检查
- 数据库索引优化，确保高频查询性能

### 安全要求
- 配额检查必须100%触发，不能绕过
- 租户不能修改自己的配额
- 集成商不能分配超过自己剩余的配额
- 配额操作需要审计日志记录

### 可靠性要求
- 配额检查准确率 100%（不能超售）
- 配额消耗和释放必须原子操作
- 支持配额事务回滚
- 配额数据定期一致性检查

### 可扩展性要求
- 支持快速添加新的功能模块
- 支持自定义配额单位
- 支持配额周期管理（月度/年度）
- 支持配额包升级（购买额外配额）

## 验收标准

- [ ] **功能模块管理**
  - [ ] 平台超管可以查看所有功能模块
  - [ ] 可以区分系统默认和可选功能
  - [ ] 可以设置全局默认配额
  - [ ] 可以启用/禁用功能模块

- [ ] **功能开通**
  - [ ] 平台超管可以为集成商开通功能
  - [ ] 集成商可以为下游客户开通自己拥有的功能
  - [ ] 不能开通自己没有的功能
  - [ ] 可以修改租户配额
  - [ ] 可以停用租户功能

- [ ] **配额分配**
  - [ ] 平台超管可以为集成商分配配额
  - [ ] 集成商可以为下游客户分配配额
  - [ ] 分配配额时验证剩余配额是否充足
  - [ ] 分配后集成商剩余配额正确计算
  - [ ] 集成商的allocated_quota = Σ下游配额

- [ ] **配额检查**
  - [ ] 创建资源时自动检查配额
  - [ ] 配额不足时阻止创建
  - [ ] 删除资源时自动释放配额
  - [ ] 配额检查响应时间 < 50ms
  - [ ] 配额检查准确率 100%

- [ ] **前端动态显示**
  - [ ] 已开通的功能正确显示
  - [ ] 未开通的功能完全隐藏
  - [ ] 系统默认功能始终显示
  - [ ] 菜单和页面根据开通情况动态调整

- [ ] **配额统计与展示**
  - [ ] 租户可以查看自己的配额使用情况
  - [ ] 集成商可以查看已分配给下游的配额
  - [ ] 显示配额使用率（已用/总共/剩余）
  - [ ] 配额不足时显示提示
  - [ ] 配额统计数据准确

- [ ] **配额告警**
  - [ ] 配额使用率达到80%时告警
  - [ ] 配额使用率达到90%时强烈告警
  - [ ] 配额使用率达到100%时阻止创建
  - [ ] 告警通知发送到租户管理员

## 关联文档
- **设计方案**: SOL-007 (待创建)
- **实现计划**: IMP-007 (待创建)
- **测试用例**: TC-007-08 (待创建)
- **API文档**: /api/features, /api/tenants/{id}/features (待创建)

## 依赖关系
- **前置功能**:
  - FE-007-01: 多租户组织管理（需要租户ID）
  - FE-007-03: RBAC权限模型（权限验证）
- **后置功能**:
  - 所有使用配额的业务功能（device_management, web_editor等）
- **并行功能**:
  - FE-007-01 ~ FE-007-07: 可并行开发，先预留配额检查接口

## 变更历史
| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 2026-01-27 | 1.0 | 初始创建 | Claude Code |
