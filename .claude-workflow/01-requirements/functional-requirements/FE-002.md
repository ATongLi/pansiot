# FE-002: Scada工程管理功能

## 功能需求信息

**需求ID**: FE-002
**需求标题**: Scada工程管理功能
**来源需求**: REQ-002
**创建日期**: 2026-01-21
**目标平台**: Scada (前端 + 后端)
**状态**: ⏳ 待实施

## 功能需求分解

### FE-002-1: 新建工程对话框 (NewProjectDialog)

**描述**: 前端对话框组件，用于收集工程信息并创建新工程

**功能点**:
1. 对话框UI组件
   - 模态对话框显示
   - 标题: "新建工程"
   - 取消/确定按钮
2. 表单字段
   - 工程名称 (文本输入，必填，最大50字符)
   - 工程作者 (文本输入，可选，最大30字符)
   - 工程描述 (多行文本，可选，最大500字符)
   - 工程分类 (下拉选择，必选)
     - 预设分类: 分类1、分类2
     - 支持"新建分类..."选项快速创建自定义分类
   - **运行平台 (下拉选择，必选)**
     - **从后端API获取已配置的硬件平台列表**
     - 用户只能选择，不可新增自定义平台
     - 示例平台: BOX1、HMI01、TBOX1
     - 平台配置由系统管理员维护
   - 保存位置 (文件夹选择器，必选)
   - 工程加密 (复选框，可选)
3. 表单验证
   - 必填字段验证
   - 字符长度限制
   - 文件夹路径有效性
   - 实时验证反馈
4. 确认创建
   - 调用后端API创建工程
   - 显示进度指示
   - 成功后打开工程

**验收标准**:
- [ ] 对话框可以通过"新建工程"按钮打开
- [ ] 所有表单字段正确显示
- [ ] 表单验证规则生效
- [ ] 必填字段为空时显示错误提示
- [ ] 可以选择文件夹路径
- [ ] **可以从后端获取运行平台列表**
- [ ] **运行平台下拉框显示后端返回的平台选项**
- [ ] **运行平台用户不可新增，只能选择**
- [ ] 可以选择硬件平台和工程分类
- [ ] 工程分类支持快速创建自定义分类
- [ ] 勾选"工程加密"后显示密码输入框
- [ ] 点击确定后调用后端API
- [ ] 创建成功后自动打开工程进入编辑器
- [ ] 支持键盘操作（ESC关闭，Enter确认）

**实现文件**:
- `src/components/project/NewProjectDialog.tsx`
- `src/components/project/NewProjectDialog.css`
- `src/types/project.ts` - 工程类型定义
- `src/store/projectStore.ts` - MobX工程状态管理

---

### FE-002-2: 打开工程功能 (OpenProject)

**描述**: 前端功能，从本地文件系统打开已保存的工程

**功能点**:
1. 文件选择器
   - 使用Electron dialog API
   - 过滤文件类型（.pant）
   - 记住上次打开位置
2. 工程加载
   - 调用后端API读取工程文件
   - 显示加载进度
   - 验证工程文件完整性
3. 安全验证
   - 如果工程加密，弹出密码输入对话框
   - 验证密码正确性
   - 如果设备绑定，验证设备ID
4. 错误处理
   - 文件不存在
   - 文件格式错误
   - 密码错误
   - 签名验证失败

**验收标准**:
- [ ] 点击"从文件打开"弹出文件选择器
- [ ] 只显示.pant文件
- [ ] 选择文件后调用后端API
- [ ] 加载工程时显示进度指示
- [ ] 加载成功后进入编辑器
- [ ] 加密工程弹出密码对话框
- [ ] 密码错误显示友好提示
- [ ] 错误情况有明确提示

**实现文件**:
- `src/components/project/OpenProjectDialog.tsx`
- `src/components/project/PasswordDialog.tsx`
- `src/utils/fileHandler.ts`
- `src/api/projectApi.ts`

---

### FE-002-3: 最近工程列表 (RecentProjects)

**描述**: 前端组件，以列表形式显示最近打开的工程，支持快速检索和分类筛选

**功能点**:
1. 列表视图显示
   - 使用列表布局（而非网格卡片）
   - 显示最近打开的工程（最多50个）
   - 每个列表项显示：
     * 工程名称（主文本）
     * 工程分类标签（彩色标签）
     * 最后打开时间（相对时间，如"2小时前"）
     * 工程保存路径（次要文字，灰色）
     * 加密状态图标（如果工程已加密）
2. 快速检索和筛选
   - 分类筛选：
     * 顶部显示分类标签栏（横向滚动）
     * 显示"全部"和各分类选项
     * 每个分类标签显示该分类下的工程数量
     * 点击分类标签，列表立即过滤显示该分类的工程
   - 搜索功能：
     * 顶部搜索框（实时搜索）
     * 支持按工程名称搜索
     * 输入时立即过滤列表（防抖100ms）
   - 排序功能：
     * 默认按最后打开时间倒序
     * 支持按工程名称排序（A-Z / Z-A）
     * 支持按创建时间排序
3. 交互操作
   - 点击列表项打开工程
   - 右键菜单：
     * 打开工程
     * 在文件管理器中显示
     * 从列表中移除
     * 复制工程路径
   - 悬停高亮效果
   - 键盘导航（上下箭头选择，Enter打开）
4. 数据持久化
   - 保存到localStorage
   - 记录每个工程的元数据（名称、路径、分类、最后打开时间）
   - 自动更新最后打开时间
   - 限制最多50个记录（FIFO淘汰）
5. 性能优化
   - 虚拟滚动（react-window）
   - 延迟加载工程详细信息
   - 搜索防抖

**验收标准**:
- [ ] 以列表形式显示最近工程
- [ ] 列表项显示所有必需信息
- [ ] 顶部显示分类标签筛选器
- [ ] 点击分类标签正确过滤列表
- [ ] 搜索框实时搜索工程名称
- [ ] 支持多种排序方式
- [ ] 点击列表项打开工程
- [ ] 右键菜单功能正常
- [ ] 键盘导航流畅
- [ ] 列表性能良好（50个工程无卡顿）
- [ ] 刷新页面后数据保持

**实现文件**:
- `src/components/workspace/RecentProjectsList.tsx` (新建，替换原有卡片组件)
- `src/components/workspace/RecentProjectsList.css`
- `src/components/workspace/ProjectListItem.tsx` (列表项组件)
- `src/components/workspace/CategoryFilter.tsx` (分类筛选组件)
- `src/components/workspace/SearchBox.tsx` (搜索框组件)
- `src/utils/recentProjectsManager.ts`
- `src/types/project.ts`

---

### FE-002-4: 工程数据模型 (ProjectModel)

**描述**: TypeScript类型定义和MobX状态管理，定义工程数据结构

**功能点**:
1. TypeScript类型
   - Project: 工程主数据结构
   - ProjectMetadata: 工程元数据
   - ProjectSecurity: 工程安全配置
   - ProjectCategory: 工程分类枚举
   - HardwarePlatform: 硬件平台枚举
2. MobX Store
   - observable工程数据
   - 加载/保存工程方法
   - 工程状态管理（新建、打开、已修改、已保存）
   - 自动保存（可选）
3. 工程序列化
   - 序列化为JSON格式
   - 从JSON反序列化
   - 版本兼容性处理

**验收标准**:
- [ ] 所有类型定义完整
- [ ] MobX Store正常工作
- [ ] 工程数据变化触发响应式更新
- [ ] 序列化/反序列化正确
- [ ] 支持版本迁移

**实现文件**:
- `src/types/project.ts`
- `src/store/projectStore.ts`
- `src/utils/projectSerializer.ts`

---

### FE-002-5: 工程API客户端 (ProjectApiClient)

**描述**: 前端API客户端，与Scada后端通信

**功能点**:
1. API方法
   - createProject(data): 创建新工程
   - openProject(path): 打开工程
   - saveProject(project): 保存工程
   - validatePassword(path, password): 验证密码
   - getRecentProjects(): 获取最近工程列表
2. 错误处理
   - 网络错误处理
   - API错误码映射
   - 友好错误提示
3. 进度指示
   - 上传/下载进度回调
   - 大文件分块传输

**验收标准**:
- [ ] 所有API方法正常工作
- [ ] 错误处理完善
- [ ] 支持进度指示
- [ ] API调用有loading状态

**实现文件**:
- `src/api/projectApi.ts`
- `src/types/api.ts`

---

### FE-002-6: 后端工程管理API (ProjectManagementApi)

**描述**: Scada后端Golang API，提供工程CRUD操作

**功能点**:
1. HTTP API端点
   - POST /api/projects/create - 创建新工程
   - POST /api/projects/open - 打开工程文件
   - POST /api/projects/save - 保存工程
   - POST /api/projects/validate-password - 验证密码
   - GET /api/projects/recent - 获取最近工程
2. 工程文件操作
   - 读取.pant文件
   - 写入.pant文件
   - 验证文件签名
   - 加密/解密文件
3. 安全策略
   - 密码验证
   - 设备ID验证
   - 文件完整性检查

**验收标准**:
- [ ] 所有API端点正常工作
- [ ] 支持工程文件读写
- [ ] 加密/解密功能正常
- [ ] 文件签名验证通过
- [ ] API响应格式统一
- [ ] 错误码定义清晰

**实现文件**:
- `platforms/scada/backend/internal/api/project_api.go`
- `platforms/scada/backend/internal/service/project_service.go`
- `platforms/scada/backend/internal/model/project.go`
- `platforms/scada/backend/internal/security/crypto.go`

---

### FE-002-7: 工程加密模块 (EncryptionModule)

**描述**: 后端加密/解密模块，保护工程文件安全

**功能点**:
1. 加密算法
   - AES-256-GCM加密
   - 密钥派生（PBKDF2）
   - 随机IV生成
2. 文件签名
   - HMAC-SHA256签名
   - 防篡改验证
3. 设备指纹
   - 生成Machine ID
   - 跨平台一致性
   - 设备绑定验证

**验收标准**:
- [ ] 加密/解密功能正常
- [ ] 文件签名验证有效
- [ ] Machine ID在相同设备上一致
- [ ] 不同设备的Machine ID不同
- [ ] 性能满足要求（加密<100ms）

**实现文件**:
- `platforms/scada/backend/internal/security/aes_gcm.go`
- `platforms/scada/backend/internal/security/hmac.go`
- `platforms/scada/backend/internal/security/machine_id.go`
- `platforms/scada/backend/internal/security/encryption.go`

---

### FE-002-8: 硬件平台配置API (HardwarePlatformApi)

**描述**: 后端API接口，提供已配置的硬件平台列表供前端选择

**业务背景**:
运行平台（硬件型号）是系统级配置，由管理员预先配置好，用户在创建工程时只能选择，不能新增。这确保了工程只能在支持的硬件上运行，避免兼容性问题。

**功能点**:
1. **获取平台列表API**
   - 端点: `GET /api/platforms`
   - 返回所有已配置的硬件平台
   - 每个平台包含:
     * 平台ID (唯一标识)
     * 平台名称 (显示名称，如"BOX1")
     * 平台类型 (HMI/网关/BOX)
     * 屏幕分辨率
     * 其他技术参数
   - 按平台名称字母顺序排列

2. **平台数据管理** (管理员功能)
   - 添加新平台: `POST /api/platforms`
   - 更新平台: `PUT /api/platforms/:id`
   - 删除平台: `DELETE /api/platforms/:id`
   - 平台启用/禁用: `PUT /api/platforms/:id/toggle`

3. **模拟数据** (当前实现)
   - BOX1: 标准BOX型号
   - HMI01: HMI触摸屏
   - TBOX1: 网关盒子

**API设计**:

```http
GET /api/platforms

Response 200:
{
  "success": true,
  "data": [
    {
      "id": "box1",
      "name": "BOX1",
      "type": "box",
      "resolution": "1920x1080",
      "enabled": true
    },
    {
      "id": "hmi01",
      "name": "HMI01",
      "type": "hmi",
      "resolution": "1280x800",
      "enabled": true
    },
    {
      "id": "tbox1",
      "name": "TBOX1",
      "type": "gateway",
      "resolution": "1024x600",
      "enabled": true
    }
  ]
}
```

**前端集成**:
- 组件挂载时调用 `GET /api/platforms`
- 将返回的数据填充到运行平台下拉框
- 处理API错误（网络错误、服务错误）
- 显示加载状态

**数据模型**:
```typescript
interface HardwarePlatform {
  id: string          // 平台唯一标识
  name: string        // 平台显示名称
  type: PlatformType  // 平台类型
  resolution?: string // 屏幕分辨率
  enabled: boolean    // 是否启用
}

enum PlatformType {
  BOX = 'box',
  HMI = 'hmi',
  GATEWAY = 'gateway'
}
```

**验收标准**:
- [ ] 后端提供 `GET /api/platforms` 接口
- [ ] 返回平台列表包含BOX1、HMI01、TBOX1
- [ ] 前端对话框加载时自动调用API
- [ ] 运行平台下拉框正确显示后端数据
- [ ] 用户无法在运行平台字段中新增选项
- [ ] API错误有友好提示
- [ ] 支持平台启用/禁用过滤

**实现文件**:
- `platforms/scada/backend/internal/api/platform_api.go`
- `platforms/scada/backend/internal/model/platform.go`
- `platforms/scada/backend/internal/service/platform_service.go`
- `src/api/platformApi.ts` (前端)
- `src/types/platform.ts`

---

### FE-002-9: 官方密码解锁工具 (PasswordRecoveryTool)

**描述**: 独立的官方工具，用于帮助用户解锁忘记密码的工程文件

**业务场景**:
用户忘记工程密码，但能够证明工程所有权（如提供购买凭证、注册邮箱、机器信息等），需要官方工具帮助移除或重置密码。

**功能点**:
1. **双重加密机制** (工程文件层面)
   - 工程使用数据加密密钥(DEK)加密内容
   - DEK使用用户密码加密(用户可访问)
   - DEK同时使用官方主密钥(KEK)加密备份(仅官方工具可访问)

2. **所有权验证**
   - 用户需要提供以下至少2项证明：
     * 购买凭证(订单号、License Key)
     * 注册邮箱(接收验证码)
     * 机器指纹(Machine ID)
     * 工程创建时间范围
     * 工程保存路径历史
   - 官方客服或自动化系统验证信息

3. **密码移除功能**
   - 使用官方KEK解密DEK备份
   - 重新加密工程内容(移除密码保护)
   - 更新工程元数据标记为"已重置"
   - 记录重置操作日志(时间、操作人、原因)

4. **密码重置功能** (可选)
   - 使用官方KEK解密DEK
   - 设置新用户密码
   - 重新加密DEK
   - 更新工程文件

5. **审计日志**
   - 记录所有解锁操作
   - 包含：时间戳、操作人、工程ID、原因、结果
   - 日志保存到官方数据库

**安全设计**:
1. **密钥托管策略**
   - KEK(密钥加密密钥)由官方持有
   - KEK使用硬件安全模块(HSM)保护
   - KEK定期轮换(每年一次)
   - KEK访问需要多重授权(2人以上)

2. **工程文件结构**
   ```json
   {
     "version": "1.0.0",
     "projectId": "uuid",
     "metadata": { ... },
     "security": {
       "encrypted": true,
       "passwordHash": "bcrypt-hash",
       "dek": {
         "userEncrypted": "base64-encoded-dek-encrypted-by-user-password",
         "officialEncrypted": "base64-encoded-dek-encrypted-by-kek",
         "kekVersion": "2024-01"
       }
     },
     "encryptedContent": "base64-encoded-content-encrypted-by-dek"
   }
   ```

3. **解密流程**
   ```
   1. 用户提交解锁请求 + 所有权证明
   2. 官方验证所有权
   3. 验证通过，使用KEK解密dek.officialEncrypted → DEK
   4. 使用DEK解密encryptedContent → 明文内容
   5. 可选：设置新密码或移除加密
   6. 重新保存工程文件
   7. 记录审计日志
   ```

**验收标准**:
- [ ] 工程文件支持双重加密(DEK机制)
- [ ] 官方KEK安全存储和管理
- [ ] 解锁工具能验证用户所有权
- [ ] 解锁工具能移除工程密码
- [ ] 解锁工具能重置工程密码
- [ ] 所有解锁操作有审计日志
- [ ] KEK泄露有应急响应机制

**实现文件**:
- `tools/password-recovery-tool/main.go` - 解锁工具主程序
- `platforms/scada/backend/internal/security/key_encryption.go` - 密钥加密逻辑
- `platforms/scada/backend/internal/security/kek_manager.go` - KEK管理
- `platforms/scada/backend/internal/model/audit_log.go` - 审计日志模型

**使用场景示例**:
```bash
# 场景1: 移除密码
./password-recovery-tool remove-password \
  --project-file "encrypted.pant" \
  --proof purchase-order:PO123456 \
  --proof email:user@example.com \
  --reason "用户忘记密码，能提供购买凭证"

# 场景2: 重置密码
./password-recovery-tool reset-password \
  --project-file "encrypted.pant" \
  --new-password "new-password-123" \
  --proof license-key:XXXX-YYYY-ZZZZ \
  --reason "用户忘记密码，通过License验证"

# 场景3: 批量处理(客服端)
./password-recovery-tool batch \
  --input-file "requests.csv" \
  --output-file "results.csv"
```

**风险与限制**:
- KEK泄露可能导致所有加密工程不安全
- 需要严格的KEK访问控制
- 所有权验证可能被绕过(社会工程学攻击)
- 建议每年提醒用户备份密码

---

## 设计规范

### 前端UI设计

**对话框样式**:
- 宽度: 600px
- 最大高度: 80vh
- 圆角: 8px
- 阴影: 0 8px 32px rgba(0,0,0,0.2)

**表单样式**:
- 标签字号: 13px
- 输入框字号: 14px
- 必填标记: 红色星号
- 错误提示: 红色文字，12px
- 间距: 12px

**按钮样式**:
- 主要按钮: 工业蓝背景 #2196F3
- 次要按钮: 灰色边框
- 按钮高度: 36px
- 按钮间距: 12px

### 数据模型设计

**Project结构**:
```typescript
interface Project {
  version: string           // 文件格式版本
  projectId: string         // UUID v4
  metadata: ProjectMetadata
  security: ProjectSecurity
  canvas: CanvasConfig
  components: Component[]
}

interface ProjectMetadata {
  name: string              // 工程名称
  author?: string           // 工程作者
  description?: string      // 工程描述
  category: ProjectCategory // 工程分类
  platform: HardwarePlatform // 硬件平台
  createdAt: string         // ISO 8601
  updatedAt: string         // ISO 8601
}

interface ProjectSecurity {
  encrypted: boolean        // 是否加密
  passwordHash?: string     // 密码哈希（bcrypt）
  deviceBinding?: string    // 设备指纹
  fileSignature: string     // HMAC-SHA256签名
}

enum ProjectCategory {
  INDUSTRIAL_MONITORING = '工业监控',
  DATA_ACQUISITION = '数据采集',
  DEVICE_CONTROL = '设备控制',
  ENERGY_MANAGEMENT = '能源管理',
  OTHER = '其他'
}

enum HardwarePlatform {
  BOX1 = 'BOX1',           // 标准BOX型号
  HMI01 = 'HMI01',         // HMI触摸屏
  TBOX1 = 'TBOX1',         // 网关盒子
  // 未来可能添加的平台
  // BOX2 = 'BOX2',
  // HMI02 = 'HMI02',
}
```

### API设计

**创建工程**:
```http
POST /api/projects/create
Content-Type: application/json

{
  "metadata": {
    "name": "示例工程",
    "author": "张三",
    "description": "这是一个示例工程",
    "category": "工业监控",
    "platform": "Windows"
  },
  "security": {
    "encrypted": true,
    "password": "userpassword"
  },
  "savePath": "C:\\Projects\\example.pant"
}

Response 200:
{
  "success": true,
  "data": {
    "projectId": "uuid-v4",
    "filePath": "C:\\Projects\\example.pant"
  }
}
```

**打开工程**:
```http
POST /api/projects/open
Content-Type: application/json

{
  "filePath": "C:\\Projects\\example.pant",
  "password": "userpassword"  // 如果工程加密
}

Response 200:
{
  "success": true,
  "data": {
    "project": { ... }  // 完整工程数据
  }
}

Response 401:
{
  "success": false,
  "error": "INVALID_PASSWORD",
  "message": "密码错误"
}
```

## 可追溯性

**关联文档**:
- 原始需求: REQ-002
- 用户故事: US-002 (待创建)
- 技术方案: SOL-002 (待创建)
- 实施计划: IMP-002 (待创建)

## 测试状态

- [ ] 单元测试
- [ ] 集成测试
- [ ] E2E测试
- [ ] 安全测试
