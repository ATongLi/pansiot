# FE-007-02: 用户注册与登录

## 元数据
- **功能ID**: FE-007-02
- **来源需求**: REQ-007
- **功能类型**: 功能性
- **优先级**: P0 (关键功能)
- **状态**: 待设计 v2.1 (根据反馈完善)
- **负责平台**: Cloud (云平台端)

## 功能描述

### 核心功能
实现支持三种用户创建方式的用户注册登录系统：新企业注册、加入已有企业、租户内创建用户。

### 主要特性

#### 方式1：新企业注册（创建新租户）
**适用场景**：首次使用平台的用户，创建新的企业租户

**注册信息**：
- **必填项**：
  - 企业名称
  - 所属行业（预设选项 + "其他"支持自填）
  - 注册方式（手机号/邮箱）
  - 手机号/邮箱地址
  - 验证码（需要验证）
  - 密码
  - 确认密码

**系统自动处理**：
1. 创建新的Tenant实体（tenant_type=TERMINAL）
2. 生成企业序列号（格式：`{4位随机字符}{4位自增ID}`，总长度8位，示例：`A3F20001`）
3. 创建不可删除的"系统管理员"角色
4. 创建用户账号，关联到新租户（tenant_id）
5. 将用户添加到系统管理员角色
6. 系统管理员角色默认拥有所有权限

#### 方式2：加入已有企业（加入已有租户）
**适用场景**：用户已有一个企业租户，通过企业序列号加入

**加入信息**：
- **必填项**：
  - 企业序列号（输入框，8位字符）
  - 注册方式（手机号/邮箱）
  - 手机号/邮箱地址
  - 验证码（需要验证）
  - 密码
  - 确认密码

**系统自动处理**：
1. 验证企业序列号有效性（查询租户表）
2. 创建用户账号，关联到已有租户（tenant_id）
3. 分配默认角色（普通用户）
4. 普通用户角色权限由租户管理员配置

#### 方式3：租户内创建用户（仅租户管理员）
**适用场景**：租户管理员在租户下创建子用户账号

**创建流程**：
1. 租户管理员进入"用户管理"页面
2. 点击"创建用户"按钮
3. 填写用户基本信息：
   - 用户名（必填，租户内唯一）
   - 真实姓名（必填）
   - 手机号或邮箱（必填，二选一）
   - 所属角色（必填，可多选）
4. 发送验证码：
   - 选择手机号注册：发送短信验证码
   - 选择邮箱注册：发送邮件验证码
5. 验证码验证通过后创建用户
6. 设置初始密码：
   - 方式A：管理员设置临时密码，用户首次登录时修改
   - 方式B：系统生成随机密码，通过短信/邮件发送给用户
7. 创建用户自动关联到当前租户（tenant_id）
8. 自动分配选定的角色

**批量创建用户**：
- 支持CSV文件批量导入用户
- CSV格式：用户名, 真实姓名, 手机号, 邮箱, 角色
- 批量导入时需要管理员二次确认
- 导入结果反馈（成功数量、失败原因）

**验证要求**：
- **必须验证手机号或邮箱验证码**
- 验证码6位数字，有效期5分钟
- 同一手机号/邮箱1分钟内只能发送1次
- 验证码验证后失效

#### 3. 登录功能
**登录方式**：
- 手机号/邮箱 + 密码
- 支持记住密码
- 支持自动登录（可选）

**登录后处理**：
1. 验证用户状态（是否被禁用）
2. 加载用户所属组织信息
3. 加载用户角色和权限
4. 生成JWT Token
5. 根据租户类型跳转到对应首页

#### 4. 验证码功能
**实现策略**：
- **初期**: 使用固定验证码或mock通过
- **预留接口**: 真实短信/邮件服务集成

**验证规则**：
- 验证码6位数字
- 有效期5分钟
- 同一手机号/邮箱1分钟内只能发送1次
- 验证码验证后失效

## 用户故事

**作为一个企业负责人**
我想要通过注册创建我的企业组织
以便于我开始使用物联网平台服务

**作为一个企业员工**
我想要通过企业序列号加入我所在的公司
以便于我使用公司分配的物联网平台账号

**作为系统集成商**
我想要帮助我的下游客户注册账号
以便于他们快速开始使用平台

## 功能分解

### Cloud后端:
- [ ] **数据模型设计**
  - [ ] 创建User表（username, password, email, phone, organization_id, status）
  - [ ] 创建PasswordHistory表（支持密码历史记录）
  - [ ] 创建LoginLog表（记录登录历史）
  - [ ] 创建VerificationCode表（存储验证码）

- [ ] **用户注册API**
  - [ ] POST /api/auth/register/new-company - 新企业注册
  - [ ] POST /api/auth/register/join-company - 加入已有企业
  - [ ] POST /api/auth/send-code - 发送验证码
  - [ ] POST /api/auth/verify-code - 验证验证码

- [ ] **用户登录API**
  - [ ] POST /api/auth/login - 用户登录
  - [ ] POST /api/auth/logout - 用户登出
  - [ ] POST /api/auth/refresh-token - 刷新Token
  - [ ] GET /api/auth/current-user - 获取当前登录用户信息

- [ ] **业务逻辑**
  - [ ] 新企业注册时自动创建组织和系统管理员角色
  - [ ] 验证企业序列号唯一性和有效性
  - [ ] 密码强度验证（至少8位，包含字母和数字）
  - [ ] 手机号/邮箱格式验证
  - [ ] 国际区号支持（+86, +1, +44等）
  - [ ] 验证码生成和验证（支持mock模式）
  - [ ] JWT Token生成和验证
  - [ ] 登录失败次数限制（5次失败锁定30分钟）

- [ ] **安全措施**
  - [ ] 密码使用bcrypt加密（salt rounds: 10）
  - [ ] JWT Token有效期7天
  - [ ] 敏感操作记录审计日志
  - [ ] 防止暴力破解（频率限制）

### Cloud前端:
- [ ] **注册页面**
  - [ ] 注册类型选择（新企业 / 加入已有企业）Tab切换
  - [ ] 新企业注册表单
    - [ ] 企业名称输入（必填，最多100字符）
    - [ ] 所属行业下拉选择（预设选项 + "其他"）
    - [ ] 其他行业输入（选择"其他"时显示）
    - [ ] 注册方式切换（手机号 / 邮箱）
    - [ ] 国际区号选择（默认+86，支持搜索）
    - [ ] 手机号/邮箱输入
    - [ ] 验证码输入 + 发送按钮（60秒倒计时）
    - [ ] 密码输入 + 强度提示
    - [ ] 确认密码输入
    - [ ] 注册按钮
  - [ ] 加入已有企业表单
    - [ ] 企业序列号输入（8位，自动格式化）
    - [ ] 注册方式切换（手机号 / 邮箱）
    - [ ] 手机号/邮箱输入
    - [ ] 验证码输入 + 发送按钮
    - [ ] 密码输入 + 强度提示
    - [ ] 确认密码输入
    - [ ] 注册按钮
  - [ ] 表单验证和错误提示
  - [ ] 注册成功提示 + 跳转到登录页

- [ ] **登录页面**
  - [ ] 手机号/邮箱输入（自动识别）
  - [ ] 密码输入 + 显示/隐藏切换
  - [ ] 记住密码复选框
  - [ ] 自动登录复选框
  - [ ] 忘记密码链接
  - [ ] 注册账号链接
  - [ ] 登录按钮
  - [ ] 登录失败提示

- [ ] **交互优化**
  - [ ] 输入框实时验证
  - [ ] 密码强度实时显示
  - [ ] 企业序列号自动格式化（每4位加空格）
  - [ ] 手机号根据国际区号自动格式化
  - [ ] 验证码发送按钮倒计时
  - [ ] Loading状态提示

## 非功能需求

### 性能要求
- 注册请求响应时间 < 500ms
- 登录请求响应时间 < 300ms
- 验证码发送 < 3秒（mock模式 < 100ms）

### 安全要求
- 密码必须使用bcrypt加密
- JWT Token必须签名验证
- 验证码必须有时效性
- 防止暴力破解和DDoS攻击
- 敏感信息（密码）不在日志中输出

### 可用性要求
- 注册流程不超过5步
- 页面加载时间 < 2秒
- 支持1000并发注册请求
- 表单验证清晰，错误提示友好

## 验收标准

- [ ] **新企业注册**
  - [ ] 填写完整信息后可以成功注册
  - [ ] 注册后自动创建组织（组织名称正确）
  - [ ] 注册后自动生成企业序列号（格式正确、全局唯一）
  - [ ] 注册后自动创建"系统管理员"角色
  - [ ] 注册用户自动添加到系统管理员角色
  - [ ] 系统管理员角色拥有所有权限
  - [ ] 注册成功后可以登录

- [ ] **加入已有企业**
  - [ ] 输入正确的企业序列号可以加入
  - [ ] 输入错误的序列号提示错误
  - [ ] 加入后用户关联到正确的组织
  - [ ] 加入后用户分配"普通用户"角色
  - [ ] 加入成功后可以登录

- [ ] **验证码功能**
  - [ ] 点击发送按钮可以发送验证码（mock模式）
  - [ ] 发送后按钮进入60秒倒计时
  - [ ] 输入正确验证码可以验证通过
  - [ ] 输入错误验证码提示错误
  - [ ] 验证码5分钟后过期

- [ ] **登录功能**
  - [ ] 输入正确账号密码可以登录
  - [ ] 登录后跳转到对应租户类型的首页
  - [ ] 记住密码功能正常工作
  - [ ] 自动登录功能正常工作
  - [ ] 登录失败提示错误信息
  - [ ] 账号被禁用时提示并阻止登录
  - [ ] 5次失败后锁定30分钟

- [ ] **国际区号支持**
  - [ ] 支持选择中国（+86）
  - [ ] 支持选择美国（+1）
  - [ ] 支持选择英国（+44）
  - [ ] 至少支持10个主要国家

- [ ] **密码强度**
  - [ ] 少于8位提示"密码过短"
  - [ ] 纯数字提示"建议添加字母"
  - [ ] 纯字母提示"建议添加数字"
  - [ ] 强密码提示"密码强度：高"

## 关联文档
- **设计方案**: SOL-007 (待创建)
- **实现计划**: IMP-007 (待创建)
- **测试用例**: TC-007-02 (待创建)
- **API文档**: /api/auth/* (待创建)

## 依赖关系
- **前置功能**:
  - FE-007-01: 多租户组织管理（需要Organization实体）
- **后置功能**:
  - FE-007-03: RBAC权限模型（用户需要关联角色）
- **并行功能**:
  - FE-007-01: 可并行开发，注册时使用mock组织

## 变更历史
| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 2026-01-26 | 1.0 | 初始创建 | Claude Code |
| 2026-01-27 | 2.1 | 企业序列号精简：从15位简化为8位（4位随机字符+4位自增ID） | Claude Code |
