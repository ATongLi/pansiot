# FE-007-09: 系统审计日志

## 元数据
- **功能ID**: FE-007-09
- **来源需求**: REQ-007 (场景9)
- **功能类型**: 功能性
- **优先级**: P0 (关键功能)
- **状态**: 待设计
- **负责平台**: Cloud (云平台端)

## 功能描述

### 核心功能
实现全平台的审计日志系统，记录所有关键业务操作，支持快速扩展到新模块，满足安全和审计合规要求。

### 设计原则

1. **灵活扩展**：支持快速添加新的日志类型，无需修改核心日志逻辑
2. **统一规范**：所有模块遵循相同的日志记录规范
3. **性能优先**：日志记录不影响业务性能
4. **审计合规**：满足安全和审计要求

### 日志记录范围

#### 必须记录的操作（关键业务）
- ✅ 所有增删改操作（CREATE, UPDATE, DELETE）
- ✅ 登录登出操作（LOGIN, LOGOUT）
- ✅ 权限变更操作（角色分配、权限修改）
- ✅ 配额分配操作（ALLOCATE）
- ✅ 功能开通操作（ACTIVATE, DEACTIVATE）
- ✅ 敏感配置修改（系统配置、安全设置）

#### 可选记录的操作（根据业务需求）
- ⭕ 查询操作（READ）- 可配置是否记录
- ⭕ 导入导出（IMPORT, EXPORT）- 建议记录
- ⭕ API调用 - 可通过中间件统一记录

#### 不记录的操作
- ❌ 健康检查、心跳检测
- ❌ 定时任务、系统调度
- ❌ 统计分析、报表生成

### 操作类型定义

| 操作类型 | 代码 | 说明 | 示例 |
|---------|------|------|------|
| 创建 | CREATE | 创建新对象 | 创建设备、创建用户 |
| 查询 | READ | 查询对象 | 查看设备详情（可选记录） |
| 更新 | UPDATE | 修改对象 | 修改设备名称、更新用户信息 |
| 删除 | DELETE | 删除对象 | 删除设备、删除用户 |
| 登录 | LOGIN | 用户登录 | 用户登录成功 |
| 登出 | LOGOUT | 用户登出 | 用户主动登出 |
| 导出 | EXPORT | 导出数据 | 导出设备列表 |
| 导入 | IMPORT | 导入数据 | 批量导入用户 |
| 分配 | ALLOCATE | 分配配额 | 分配配额给下游租户 |
| 开通 | ACTIVATE | 开通功能 | 为租户开通功能模块 |
| 停用 | DEACTIVATE | 停用功能 | 停用租户功能模块 |

### 操作详情（action_detail）设计

采用JSON格式，记录字段级变更：

**示例1：创建设备**
```json
{
  "before": null,
  "after": {
    "device_id": 12345,
    "device_name": "温度传感器01",
    "device_type": "sensor",
    "tenant_id": 1001,
    "managed_tenant_id": 1
  },
  "changes": null
}
```

**示例2：更新设备**
```json
{
  "before": {
    "device_name": "温度传感器01",
    "status": "offline"
  },
  "after": {
    "device_name": "温度传感器01-已更新",
    "status": "online"
  },
  "changes": [
    {"field": "device_name", "old": "温度传感器01", "new": "温度传感器01-已更新"},
    {"field": "status", "old": "offline", "new": "online"}
  ]
}
```

**示例3：删除设备**
```json
{
  "before": {
    "device_id": 12345,
    "device_name": "温度传感器01",
    "device_type": "sensor"
  },
  "after": null,
  "changes": null
}
```

## 用户故事

**作为平台超管**
我想要查看所有租户的操作日志
以便于进行安全审计和问题排查

**作为集成商**
我想要查看我管理的下游租户的操作日志
以便于监控业务运营和异常行为

**作为租户管理员**
我想要查看本租户的操作日志
以便于了解操作历史和责任人

**作为系统开发者**
我想要快速为新模块添加日志记录
以便于不修改核心日志逻辑

**作为安全审计员**
我想要导出特定时间段的操作日志
以便于进行合规审计

## 功能分解

### Cloud后端:
- [ ] **数据模型设计**
  - [ ] **audit_logs** 表
    - [ ] id (BIGINT PK)
    - [ ] tenant_id (BIGINT NOT NULL)
    - [ ] module_code (VARCHAR(50))
    - [ ] action_type (VARCHAR(20))
    - [ ] entity_type (VARCHAR(50))
    - [ ] entity_id (BIGINT)
    - [ ] action_detail (JSON) - 操作详情（字段级变更记录）
    - [ ] operator_id (BIGINT NOT NULL)
    - [ ] operator_name (VARCHAR(100)) - 冗余字段，便于查询
    - [ ] ip_address (VARCHAR(45))
    - [ ] user_agent (VARCHAR(500))
    - [ ] status (VARCHAR(20)) - SUCCESS, FAILED, PARTIAL
    - [ ] error_message (TEXT)
    - [ ] created_at (TIMESTAMP NOT NULL)
    - [ ] 索引：idx_tenant_module, idx_entity, idx_operator, idx_created_at, idx_action

- [ ] **日志中间件设计**
  - [ ] **auditLogMiddleware** - 自动记录中间件
    - [ ] 拦截所有API请求
    - [ ] 自动提取操作信息
    - [ ] 自动捕获before/after数据
    - [ ] 自动计算changes差异
    - [ ] 异步写入日志（不影响性能）
    - [ ] 错误处理（日志失败不影响业务）

  - [ ] **setModuleContext** - 模块上下文设置
    - [ ] 从路由中提取module_code
    - [ ] 从路由中提取entity_type
    - [ ] 设置请求上下文

  - [ ] **configurableLog** - 配置化日志记录
    - [ ] 读取配置文件
    - [ ] 根据配置决定是否记录
    - [ ] 支持模块级别开关
    - [ ] 支持操作类型开关

- [ ] **配置文件设计**
  - [ ] **audit_log_config.yml**
    ```yaml
    modules:
      device:
        enabled: true
        log_read: false      # 不记录查询操作
        log_write: true     # 记录增删改
      user:
        enabled: true
        log_read: false
        log_write: true
        log_login: true     # 记录登录登出
      alert:
        enabled: true
        log_read: false
        log_write: true
      system_config:
        enabled: true
        log_read: true      # 系统配置所有操作都记录
        log_write: true
    ```

- [ ] **日志记录API**
  - [ ] POST /api/audit/logs - 手动记录日志（特殊场景）
  - [ ] GET /api/audit/logs - 查询日志列表
  - [ ] GET /api/audit/logs/:id - 获取日志详情
  - [ ] GET /api/audit/logs/export - 导出日志
  - [ ] DELETE /api/audit/logs/:id - 删除日志（仅平台超管）

- [ ] **业务逻辑**
  - [ ] 自动记录CREATE操作（before=null, after=新数据）
  - [ ] 自动记录UPDATE操作（before=旧数据, after=新数据, changes=差异）
  - [ ] 自动记录DELETE操作（before=旧数据, after=null）
  - [ ] 自动记录LOGIN/LOGOUT操作
  - [ ] 字段级变更计算（自动对比before和after）
  - [ ] 敏感信息脱敏（密码、密钥等）
  - [ ] 日志数据验证（JSON格式验证）

- [ ] **快速扩展机制**
  - [ ] 3步添加新模块日志：
    1. 在配置文件中添加模块配置
    2. 在路由中指定模块代码和实体类型
    3. 无需修改日志表结构

- [ ] **日志清理与归档**
  - [ ] 定时任务清理超过6个月的在线日志
  - [ ] 归档日志压缩存储
  - [ ] 审计日志永久保留（独立存储）
  - [ ] 日志恢复接口（查询归档日志）

### Cloud前端:
- [ ] **日志查询页面**
  - [ ] 按模块筛选（设备、用户、告警等）
  - [ ] 按操作类型筛选（创建、更新、删除等）
  - [ ] 按时间范围筛选（今天、最近7天、最近30天、自定义）
  - [ ] 按操作人筛选
  - [ ] 按关键字搜索（实体名称、操作详情）
  - [ ] 分页显示日志列表

- [ ] **日志详情页面**
  - [ ] 显示操作时间
  - [ ] 显示操作人信息
  - [ ] 显示操作类型
  - [ ] 显示实体类型和ID
  - [ ] 显示操作详情（JSON格式，支持高亮显示变更）
  - [ ] 显示IP地址和设备信息
  - [ ] 显示操作状态（成功/失败）

- [ ] **变更对比视图**
  - [ ] before/after 并排显示
  - [ ] changes 差异高亮显示
  - [ ] 字段级别变更标记
  - [ ] 支持展开/收起JSON

- [ ] **日志导出功能**
  - [ ] 导出为Excel/CSV
  - [ ] 支持按筛选条件导出
  - [ ] 敏感信息脱敏
  - [ ] 导出进度提示

- [ ] **日志统计图表**
  - [ ] 操作类型分布图
  - [ ] 操作趋势图（按天/周/月）
  - [ ] 操作人活跃度排行
  - [ ] 失败操作统计

- [ ] **实时日志监控**（可选）
  - [ ] WebSocket推送实时日志
  - [ ] 实时显示关键操作
  - [ ] 异常操作告警

### 数据库:
- [ ] 创建 audit_logs 表
- [ ] 创建复合索引优化查询性能
- [ ] JSON字段验证（action_detail）
- [ ] 定时清理任务（保留6个月在线日志）

## 非功能需求

### 性能要求
- 日志记录响应时间 < 100ms（异步）
- 日志查询响应时间 < 500ms
- 支持千万级日志数据存储
- 日志记录不影响业务性能（<5ms额外开销）

### 安全要求
- 日志数据不可篡改（除平台超管外）
- 敏感信息自动脱敏（密码、token等）
- 日志查询权限验证（租户只能查看自己的日志）
- 日志导出需要审计

### 可靠性要求
- 日志记录成功率 > 99.9%
- 日志数据不丢失（异步队列+持久化）
- 支持日志系统故障降级（日志失败不影响业务）

### 可扩展性要求
- 快速添加新模块日志（3步流程）
- 无需修改日志表结构
- 支持自定义日志字段（通过JSON）
- 支持分布式日志收集

### 可维护性要求
- 日志配置文件化（audit_log_config.yml）
- 日志中间件可插拔
- 日志格式统一规范
- 完整的日志查询界面

## 验收标准

- [ ] **日志记录**
  - [ ] 所有增删改操作自动记录
  - [ ] 登录登出操作自动记录
  - [ ] 权限变更操作自动记录
  - [ ] 配额分配操作自动记录
  - [ ] 功能开通操作自动记录
  - [ ] 日志记录不影响业务性能
  - [ ] 日志记录成功率 > 99.9%

- [ ] **操作详情（action_detail）**
  - [ ] CREATE操作正确记录after数据
  - [ ] UPDATE操作正确记录before/after/change
  - [ ] DELETE操作正确记录before数据
  - [ ] 字段级变更自动计算
  - [ ] JSON格式正确

- [ ] **配置化日志**
  - [ ] 读取配置文件决定是否记录
  - [ ] 支持模块级别开关
  - [ ] 支持操作类型开关
  - [ ] 配置修改后实时生效

- [ ] **快速扩展**
  - [ ] 3步添加新模块日志
  - [ ] 无需修改日志表结构
  - [ ] 无需修改核心日志逻辑
  - [ ] 配置文件添加模块配置即可

- [ ] **日志查询**
  - [ ] 支持多条件组合查询
  - [ ] 查询响应时间 < 500ms
  - [ ] 支持分页显示
  - [ ] 支持关键字搜索

- [ ] **日志详情展示**
  - [ ] 显示完整操作信息
  - [ ] JSON格式正确显示
  - [ ] 变更高亮显示
  - [ ] before/after对比视图

- [ ] **日志导出**
  - [ ] 支持导出为Excel/CSV
  - [ ] 支持按筛选条件导出
  - [ ] 敏感信息脱敏
  - [ ] 导出数据完整

- [ ] **日志保留与归档**
  - [ ] 在线日志保留6个月
  - [ ] 超过6个月的日志自动归档
  - [ ] 重要审计日志永久保留
  - [ ] 支持查询归档日志

- [ ] **权限控制**
  - [ ] 租户只能查看自己的日志
  - [ ] 集成商可以查看下游租户的日志
  - [ ] 平台超管可以查看所有日志
  - [ ] 日志不可篡改（除平台超管）

## 关联文档
- **设计方案**: SOL-007 (待创建)
- **实现计划**: IMP-007 (待创建)
- **测试用例**: TC-007-09 (待创建)
- **API文档**: /api/audit/logs (待创建)
- **配置文档**: audit_log_config.yml (待创建)

## 依赖关系
- **前置功能**:
  - FE-007-01: 多租户组织管理（需要租户ID）
  - FE-007-02: 用户注册与登录（记录登录日志）
  - FE-007-03: RBAC权限模型（记录权限变更）
- **后置功能**:
  - 所有业务功能（都需要记录日志）
- **并行功能**:
  - FE-007-01 ~ FE-007-08: 可并行开发，先预留日志记录接口

## 变更历史
| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 2026-01-27 | 1.0 | 初始创建 | Claude Code |
