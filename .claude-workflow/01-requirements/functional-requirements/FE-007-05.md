# FE-007-05: 租户角色切换

## 元数据
- **功能ID**: FE-007-05
- **来源需求**: REQ-007
- **功能类型**: 功能性
- **优先级**: P1 (重要功能)
- **状态**: 待设计
- **负责平台**: Cloud (云平台端)

## 功能描述

### 核心功能
实现租户角色切换功能，允许下游终端用户通过"开通集成商功能"升级为集成商角色，从而获得创建和管理下游客户的能力。

### 业务场景

#### 场景1：下游客户升级为集成商
**初始状态**：
- 用户注册时默认是"下游终端用户"角色
- 组织类型是`DOWNSTREAM_CUSTOMER`
- 只能查看和管理自己的数据

**升级流程**：
1. 用户在"系统设置"中点击"开通集成商功能"
2. 系统提示集成商功能说明和权限
3. 用户确认开通
4. 系统更新组织类型为`INTEGRATOR`
5. 系统为用户创建"集成商管理"权限
6. 界面显示"子组织管理"等集成商功能

**升级后的能力**：
- 可以创建下游客户组织
- 可以查看所有下游客户的数据
- 可以为下游客户分配管理员账号
- 可以管理下游客户的设备

#### 场景2：集成商降级为下游用户
**触发条件**：
- 集成商主动申请降级
- 平台超管强制降级
- 集成商账户违规被处罚

**降级流程**：
1. 平台超管或集成商发起降级
2. 系统检查是否有下游客户
3. 如果有下游客户，提示"需要先迁移或删除下游客户"
4. 如果没有下游客户，执行降级
5. 组织类型恢复为`DOWNSTREAM_CUSTOMER`
6. 移除集成商相关权限

#### 场景3：权限临时切换
**场景**：集成商管理员需要以某个下游客户的身份登录

**实现方式**：
1. 集成商在下游客户列表中点击"模拟登录"
2. 系统切换为下游客户的权限视图
3. 界面显示"模拟登录中 - XX公司"
4. 操作完成后点击"退出模拟"
5. 恢复为集成商权限视图

## 用户故事

**作为一个下游客户**
我想要开通集成商功能
以便于我可以为我的客户提供物联网服务

**作为一个集成商**
我想要临时以下游客户的身份登录
以便于我帮助客户排查问题

**作为平台超管**
我想要管理集成商的开通和降级
以便于控制平台上的集成商数量和质量

## 功能分解

### Cloud后端:
- [ ] **数据模型设计**
  - [ ] Organization表添加`integrator_since`字段（开通集成商功能的时间）
  - [ ] Organization表添加`integrator_status`字段（PENDING/APPROVED/SUSPENDED）
  - [ ] 创建IntegratorApplication表（开通申请记录）
  - [ ] 创建RoleSwitchAudit表（角色切换审计日志）

- [ ] **租户升级API**
  - [ ] POST /api/organizations/{id}/upgrade-to-integrator - 申请升级为集成商
  - [ ] PUT /api/organizations/{id}/integrator-status - 更新集成商状态
  - [ ] GET /api/organizations/{id}/integrator-info - 获取集成商信息

- [ ] **租户降级API**
  - [ ] POST /api/organizations/{id}/downgrade-to-customer - 申请降级为下游客户
  - [ ] GET /api/organizations/{id}/downgrade-check - 检查是否可以降级
  - [ ] DELETE /api/organizations/{id}/integrator - 强制降级（仅平台超管）

- [ ] **模拟登录API**
  - [ ] POST /api/auth/impersonate - 模拟登录（仅集成商）
  - [ ] POST /api/auth/exit-impersonate - 退出模拟
  - [ ] GET /api/auth/impersonate-status - 获取模拟登录状态

- [ ] **业务逻辑**
  - [ ] 升级时验证组织状态（必须是下游客户）
  - [ ] 升级时检查是否有下游客户（如果有则阻止）
  - [ ] 升级后自动更新组织类型为INTEGRATOR
  - [ ] 升级后自动添加集成商权限
  - [ ] 降级时验证是否有下游客户
  - [ ] 降级后移除集成商权限
  - [ ] 模拟登录时生成临时Token（包含原始用户ID）
  - [ ] 退出模拟时恢复原始Token
  - [ ] 记录所有角色切换操作到审计日志

### Cloud前端:
- [ ] **系统设置页面**
  - [ ] 组织基本信息卡片
  - [ ] 当前角色显示（下游客户 / 集成商）
  - [ ] 开通集成商功能按钮（仅下游客户显示）
  - [ ] 集成商信息卡片（开通后显示）

- [ ] **开通集成商功能弹窗**
  - [ ] 集成商功能说明（能做什么、有什么权限）
  - [ ] 集成商责任说明（需要管理下游客户）
  - [ ] 注意事项提示（一旦开通不可随意降级）
  - [ ] 确认开通按钮
  - [ ] 取消按钮

- [ ] **集成商管理界面**
  - [ ] 子组织管理入口（升级后显示）
  - [ ] 下游客户列表
  - [ ] 模拟登录按钮
  - [ ] 集成商统计数据（下游客户数量、设备数量）

- [ ] **模拟登录界面**
  - [ ] 模拟登录提示条（顶部固定显示）
  - [ ] "当前模拟登录：XX公司"
  - [ ] 退出模拟按钮
  - [ ] 模拟登录期间限制操作（不能删除数据）

- [ ] **降级功能界面**
  - [ ] 降级申请入口（仅集成商）
  - [ ] 降级检查提示（是否有下游客户）
  - [ ] 降级确认弹窗
  - [ ] 降级后果说明

## 非功能需求

### 性能要求
- 升级/降级操作响应时间 < 1s
- 模拟登录切换时间 < 200ms
- 权限更新实时生效

### 安全要求
- 升级/降级操作需要二次确认
- 模拟登录需要记录详细审计日志
- 模拟登录期间的操作需要标注"由集成商模拟"
- 平台超管可以强制降级违规集成商

### 可靠性要求
- 升级/降级操作不能失败
- 模拟登录不能导致权限混乱
- 审计日志100%记录

## 验收标准

- [ ] **下游客户升级**
  - [ ] 下游客户可以申请升级为集成商
  - [ ] 升级前显示功能说明和注意事项
  - [ ] 升级后组织类型更新为INTEGRATOR
  - [ ] 升级后显示"子组织管理"功能
  - [ ] 升级后可以创建下游客户组织
  - [ ] 升级后可以查看所有下游数据

- [ ] **集成商降级**
  - [ ] 集成商可以申请降级
  - [ ] 降级前检查是否有下游客户
  - [ ] 有下游客户时提示无法降级
  - [ ] 无下游客户时可以降级
  - [ ] 降级后组织类型恢复为DOWNSTREAM_CUSTOMER
  - [ ] 降级后移除集成商权限
  - [ ] 降级后隐藏"子组织管理"功能

- [ ] **模拟登录**
  - [ ] 集成商可以模拟登录下游客户
  - [ ] 模拟登录后界面显示下游客户的数据
  - [ ] 模拟登录期间顶部显示提示条
  - [ ] 退出模拟后恢复集成商权限
  - [ ] 模拟登录操作记录到审计日志

- [ ] **权限更新**
  - [ ] 升级后权限立即生效
  - [ ] 降级后权限立即失效
  - [ ] 权限切换无需重新登录
  - [ ] 前端界面实时更新

## 关联文档
- **设计方案**: SOL-007 (待创建)
- **实现计划**: IMP-007 (待创建)
- **测试用例**: TC-007-05 (待创建)
- **API文档**: /api/organizations/* (待创建)

## 依赖关系
- **前置功能**:
  - FE-007-01: 多租户组织管理（需要组织类型字段）
  - FE-007-03: RBAC权限模型（需要权限切换）
- **后置功能**:
  - 无（独立功能）
- **并行功能**:
  - FE-007-01, FE-007-02, FE-007-03: 可并行开发

## 变更历史
| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 2026-01-26 | 1.0 | 初始创建 | Claude Code |
