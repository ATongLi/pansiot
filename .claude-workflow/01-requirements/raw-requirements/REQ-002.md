# REQ-002: Scada工程管理功能

## 需求信息

**需求ID**: REQ-002
**需求标题**: Scada工程管理功能
**创建日期**: 2026-01-21
**需求来源**: 用户需求
**目标平台**: Scada
**优先级**: P0 (高优先级)
**状态**: ✅ 已批准

## 需求描述

### 业务背景

Scada作为HMI工程的可视化编辑器，需要提供完整的工程管理能力，包括：
- 工程的创建、打开、保存
- 工程元数据管理
- 工程文件的安全存储
- 未来支持云端同步和协作

### 核心功能

#### 1. 新建工程功能

用户可以创建新的HMI工程，需要填写以下信息：

**基本信息**:
- **工程名称** (必填): 工程的显示名称
- **工程作者** (可选): 创建者的名称
- **工程描述** (可选): 工程的详细说明
- **工程分类** (可选): 用于工程分组管理
  - 预设分类: 分类1、分类2
  - 界面上支持用户快速创建自定义分类

**技术配置**:
- **运行平台** (必选): 工程运行的目标硬件型号
  - 从后端读取已配置的硬件平台列表
  - 用户只能选择，不可新增自定义平台
  - 示例平台: BOX1、HMI01、TBOX1
  - 平台配置由管理员在系统设置中维护
- **工程保存位置** (必选): 本地文件系统路径

**安全配置**:
- **工程加密** (可选): 是否启用工程文件加密
  - 不加密: 明文存储
  - 密码保护: 需要密码才能打开

**系统生成**:
- **工程唯一标识号** (UUID): 系统自动生成，全局唯一
- **创建时间**: 自动记录
- **修改时间**: 自动更新

#### 2. 打开工程功能

用户可以从本地文件系统打开已保存的工程：

**打开方式**:
- 通过"从文件打开"浏览文件系统
- 通过"最近工程"列表快速打开

**安全验证**:
- 如果工程已加密，需要提供正确的密码
- 如果工程绑定设备，验证当前设备是否匹配
- 验证工程文件完整性（防篡改）

#### 3. 工程文件管理

**文件格式**:
- 格式: JSON
- 扩展名: `.pant` (PanTools Project)
- 编码: UTF-8

**文件结构**:
```json
{
  "version": "1.0.0",
  "projectId": "uuid-v4",
  "metadata": {
    "name": "工程名称",
    "author": "作者",
    "description": "描述",
    "category": "分类",
    "platform": "Windows",
    "createdAt": "2026-01-21T10:00:00Z",
    "updatedAt": "2026-01-21T10:00:00Z"
  },
  "security": {
    "encrypted": false,
  },
  "canvas": { ... },
  "components": [ ... ]
}
```

**安全策略**:
1. **加密算法**: AES-256-GCM
2. **文件签名**: HMAC-SHA256
3. **防篡改**: 文件修改后签名验证失败

#### 4. 工程分类管理

**目的**: 帮助用户管理大量工程文件

**功能**:
- 按分类筛选工程
- 自定义分类名称
- 分类统计（每个分类下有多少工程）
- 最近使用的分类优先显示

#### 5. 未来扩展 - 云端同步

**设计考虑**:
- 工程UUID作为云端和本地的同步键
- 支持工程上传到云端
- 支持从云端下载工程
- 支持多设备协作编辑
- 云端版本与本地版本冲突解决

#### 6. 最近工程列表

**显示方式**:
- **列表视图**: 使用列表形式展示最近打开的工程（而非卡片网格）
- **列表项信息**: 每个列表项显示：
  - 工程名称
  - 工程分类标签
  - 最后打开时间（相对时间，如"2小时前"）
  - 工程保存路径
  - 加密状态图标（如果工程已加密）

**快速检索和排列**:
- **分类筛选**:
  - 提供分类筛选下拉菜单或标签栏
  - 点击分类后，列表只显示该分类下的工程
  - 支持"全部"选项显示所有工程
  - 分类列表中显示每个分类的工程数量
- **搜索功能**:
  - 提供搜索框，支持按工程名称搜索
  - 实时过滤列表（输入时立即更新）
- **排序功能**:
  - 默认按最后打开时间倒序排列（最近打开在前）
  - 支持按工程名称排序（A-Z / Z-A）
  - 支持按创建时间排序

**交互操作**:
- **点击打开**: 点击列表项直接打开工程
- **右键菜单**:
  - 打开工程
  - 在文件管理器中显示
  - 从列表中移除
  - 复制工程路径
- **悬停效果**: 鼠标悬停时高亮列表项，显示更多操作按钮

**数据持久化**:
- 保存最近打开的工程列表到本地
- 最多保留50个工程记录
- 记录每个工程的最后打开时间
- 自动更新打开时间（每次打开工程时）

**性能优化**:
- 列表虚拟滚动（如果工程数量超过20个）
- 延迟加载工程详细信息
- 缓存搜索和筛选结果

#### 7. 密码找回机制

**业务背景**:
用户可能忘记工程密码，需要官方提供密码找回/重置服务。这是一个合理的工程管理需求，需要在设计阶段考虑。

**设计原则**:
1. **安全性优先**: 密码找回机制不应成为安全漏洞
2. **可验证性**: 用户必须能够证明工程所有权
3. **审计性**: 所有密码找回操作必须记录在案
4. **透明性**: 用户应该清楚知道密码找回的流程和风险

**技术方案**:

1. **双重加密机制**
   - 工程内容使用数据加密密钥(DEK)加密
   - DEK使用用户密码加密一份（用户可访问）
   - DEK使用官方主密钥(KEK)加密备份一份（仅官方可访问）
   - 官方解锁工具持有KEK，可以解密DEK备份

2. **密钥管理**
   - KEK由官方持有，存储在硬件安全模块(HSM)中
   - KEK定期轮换（每年一次）
   - KEK访问需要多重授权（2人以上）
   - KEK泄露应急响应机制

3. **所有权验证**
   用户需要提供至少2项证明：
   - 购买凭证（订单号、License Key）
   - 注册邮箱（可接收验证码）
   - 机器指纹（Machine ID）
   - 工程创建时间范围
   - 工程保存路径历史

4. **解锁流程**
   ```
   用户提交请求 → 所有权验证 → 验证通过 →
   官方使用KEK解密DEK → 使用DEK解密工程 →
   移除/重置密码 → 重新保存工程 → 记录审计日志
   ```

5. **官方解锁工具**
   - 独立的命令行工具
   - 不集成在PanTool中
   - 仅官方客服人员可使用
   - 支持单次处理和批量处理

6. **审计日志**
   - 记录所有解锁操作
   - 包含：时间戳、操作人、工程ID、用户信息、原因、结果
   - 日志不可删除，仅可追加
   - 定期审计和监控

**工程文件格式（支持密码找回）**:
```json
{
  "version": "1.0.0",
  "projectId": "uuid",
  "metadata": { ... },
  "security": {
    "encrypted": true,
    "passwordHash": "bcrypt-hash",
    "kekVersion": "2024-01",
    "dek": {
      "userEncrypted": "base64-encoded-dek-encrypted-by-user-password",
      "officialEncrypted": "base64-encoded-dek-encrypted-by-kek"
    }
  },
  "encryptedContent": "base64-encoded-content-encrypted-by-dek"
}
```

**用户体验**:
1. 密码错误3次后，显示"忘记密码？"链接
2. 点击链接打开密码找回指南页面
3. 指南详细说明所需材料和流程
4. 用户联系官方客服，提交证明材料
5. 客服验证后处理解锁请求
6. 处理完成后，用户收到新工程文件
7. 用户收到安全提醒和密码管理建议

**风险控制**:
- KEK泄露是最高风险，需要最严格的安全措施
- 所有权验证需要人工审核，避免自动化攻击
- 定期审计解锁记录，发现异常行为
- 建议用户定期备份密码，减少找回需求

## 验收标准

### 功能验收

- [ ] 可以创建新工程并填写所有必填字段
- [ ] 可以选择硬件平台和工程分类
- [ ] 可选择是否启用工程加密
- [ ] 工程文件保存为`.pant`格式
- [ ] 每个工程有唯一UUID
- [ ] 可以从文件系统打开工程
- [ ] 最近工程列表显示最近打开的工程
- [ ] 加密工程需要密码才能打开
- [ ] 工程文件签名验证通过
- [ ] 可以按分类筛选工程
- [ ] 工程支持双重加密机制（DEK + KEK）
- [ ] 官方可使用解锁工具移除工程密码
- [ ] 官方可使用解锁工具重置工程密码
- [ ] 所有权验证流程有效
- [ ] 所有解锁操作有审计日志

### 技术验收

- [ ] 后端提供工程CRUD API
- [ ] 前端提供工程管理UI界面
- [ ] 工程文件格式正确
- [ ] 加密/解密功能正常
- [ ] 文件签名验证有效
- [ ] 错误处理完善
- [ ] 性能满足要求（打开工程<2秒）

## 非功能需求

### 性能要求
- 工程文件大小: < 10MB (1000个组件)
- 打开工程时间: < 2秒
- 保存工程时间: < 1秒

### 安全要求
- 工程文件防篡改
- 加密工程无法被其他工具打开
- 密码使用安全算法存储

### 可用性要求
- 界面简洁直观
- 表单验证提示清晰
- 错误信息友好

### 兼容性要求
- Windows 10/11
- Linux (Ubuntu 20.04+)
- 未来支持云端Web版本

## 依赖关系

### 前置依赖
- FE-001: Scada主页面布局功能 ✅ 已完成

### 弱依赖
- IMP-001: Scada平台基础框架

### 未来依赖
- 云平台工程管理API
- 云端存储服务

## 风险与限制

### 技术风险
- 加密算法选择需要考虑性能和安全性

### 业务限制
- 工程文件格式需要向后兼容
- 云端同步功能需要网络连接

### 实施限制
- 需要在Electron环境中使用文件系统API
- 加密操作可能影响打开工程的性能

## 相关文档

- 功能需求: FE-002 (待创建)
- 用户故事: US-002 (待创建)
- 技术方案: SOL-002 (待创建)
- 架构决策: ADR-002 (待创建)

## 变更历史

| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 2026-01-21 | 1.0 | 初始版本 | User |
