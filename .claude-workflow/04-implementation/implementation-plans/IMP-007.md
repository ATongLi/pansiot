# IMP-007: 云平台账号系统 - 多租户组织管理与RBAC权限控制实施计划

## 元数据
- **实现ID**: IMP-007
- **关联方案**: SOL-007
- **关联功能**: FE-007-01 ~ FE-007-09
- **实现状态**: 待开始
- **开始日期**: 2026-01-27（预计）
- **预计完成**: 2026-04-27（预计12周）
- **负责人**: Claude Code

## 实现概述

实现云平台账号系统的完整功能，包括多租户组织管理、RBAC权限模型、用户认证注册、前端动态界面、功能模块与配额管理、系统审计日志等9个核心功能模块。采用Golang + PostgreSQL + React 18 + MobX技术栈，分为后端API服务和前端用户界面两部分。

## 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **后端** | | |
| Golang | 1.21+ | 后端开发语言 |
| Gin | latest | Web框架 |
| GORM | 1.25+ | ORM框架 |
| PostgreSQL | 14+ | 主数据库 |
| Redis | 7.0+ | 缓存和会话 |
| JWT | golang-jwt/jwt | 认证Token |
| zap | 1.24+ | 结构化日志 |
| Viper | 1.15+ | 配置管理 |
| testify | latest | 单元测试 |
| swaggo | latest | API文档生成 |
| **前端** | | |
| React | 18+ | 前端框架 |
| TypeScript | 5.0+ | 类型系统 |
| MobX | 6.9+ | 状态管理 |
| Ant Design | 5.10+ | UI组件库 |
| React Router | 6.20+ | 路由管理 |
| Axios | 1.5+ | HTTP客户端 |
| Vite | 5.0+ | 构建工具 |
| Vitest | latest | 单元测试 |

## 任务分解

### Phase 1: 基础架构搭建（2周）

**目标**: 搭建项目基础框架，配置开发环境

#### 1.1 后端项目初始化（3天）
- [ ] Task 1.1.1: 创建Go项目结构 - 预估: 2h
- [ ] Task 1.1.2: 配置go.mod依赖管理 - 预估: 1h
- [ ] Task 1.1.3: 创建基础目录和文件 - 预估: 2h
- [ ] Task 1.1.4: 配置Gin路由和中间件 - 预估: 3h
- [ ] Task 1.1.5: 配置Viper配置管理 - 预估: 2h
- [ ] Task 1.1.6: 配置zap日志系统 - 预估: 2h

#### 1.2 数据库设计与迁移（2天）
- [ ] Task 1.2.1: 设计数据库表结构（13张表） - 预估: 4h
- [ ] Task 1.2.2: 创建PostgreSQL迁移脚本 - 预估: 3h
- [ ] Task 1.2.3: 配置GORM连接和Hook - 预估: 2h
- [ ] Task 1.2.4: 实现租户隔离Hook - 预估: 3h
- [ ] Task 1.2.5: 实现软删除Hook - 预估: 1h

#### 1.3 基础中间件实现（3天）
- [ ] Task 1.3.1: JWT认证中间件 - 预估: 4h
- [ ] Task 1.3.2: 权限验证中间件 - 预估: 4h
- [ ] Task 1.3.3: 租户隔离中间件 - 预估: 3h
- [ ] Task 1.3.4: 审计日志中间件 - 预估: 4h
- [ ] Task 1.3.5: 配额检查中间件 - 预估: 3h
- [ ] Task 1.3.6: 限流中间件 - 预估: 2h
- [ ] Task 1.3.7: 错误处理中间件 - 预估: 2h

#### 1.4 前端项目初始化（2天）
- [ ] Task 1.4.1: 创建React+Vite项目 - 预估: 2h
- [ ] Task 1.4.2: 配置TypeScript和路径别名 - 预估: 1h
- [ ] Task 1.4.3: 配置Ant Design主题 - 预估: 2h
- [ ] Task 1.4.4: 配置React Router - 预估: 2h
- [ ] Task 1.4.5: 配置Axios和API客户端 - 预估: 2h
- [ ] Task 1.4.6: 创建MobX Store基础架构 - 预估: 3h

#### 1.5 CI/CD配置（1天）
- [ ] Task 1.5.1: 配置Docker开发环境 - 预估: 3h
- [ ] Task 1.5.2: 编写docker-compose.yml - 预估: 2h
- [ ] Task 1.5.3: 配置GitHub Actions CI - 预估: 2h

### Phase 2: 认证与用户管理（3周）

**目标**: 实现用户注册、登录、认证功能

#### 2.1 用户注册功能（5天）
- [ ] Task 2.1.1: 实现新企业注册接口 - 预估: 8h
  - FE-007-02: 新企业注册
  - 生成企业序列号
  - 自动创建组织
  - 自动创建系统管理员角色
- [ ] Task 2.1.2: 实现加入已有企业接口 - 预估: 6h
  - 验证企业序列号
  - 加入已有组织
- [ ] Task 2.1.3: 实现验证码发送接口 - 预估: 3h
  - 支持邮箱和手机号
  - Redis存储验证码
- [ ] Task 2.1.4: 实现验证码验证逻辑 - 预估: 2h
- [ ] Task 2.1.5: 实现密码强度验证 - 预估: 2h
- [ ] Task 2.1.6: 前端注册页面 - 预估: 8h
  - 注册表单组件
  - 表单验证
  - 验证码输入
  - 错误提示

#### 2.2 用户登录功能（4天）
- [ ] Task 2.2.1: 实现登录接口 - 预估: 6h
  - JWT Token生成
  - 密码验证（bcrypt）
  - 加载用户权限
- [ ] Task 2.2.2: 实现Token刷新接口 - 预估: 3h
- [ ] Task 2.2.3: 实现登出接口 - 预估: 2h
  - 清除Redis缓存
  - Token黑名单
- [ ] Task 2.2.4: 实现获取当前用户接口 - 预估: 2h
- [ ] Task 2.2.5: 实现密码重置接口 - 预估: 3h
- [ ] Task 2.2.6: 实现修改密码接口 - 预估: 2h
- [ ] Task 2.2.7: 前端登录页面 - 预估: 6h
  - 登录表单
  - Token存储
  - 自动登录
  - 忘记密码

#### 2.3 组织管理功能（6天）
- [ ] Task 2.3.1: 实现组织CRUD接口 - 预估: 8h
  - FE-007-01: 组织创建、查询、更新、删除
  - 企业序列号生成
  - 组织类型管理
- [ ] Task 2.3.2: 实现组织树查询接口 - 预估: 4h
  - 递归查询子组织
  - 组织层级展示
- [ ] Task 2.3.3: 实现租户类型升级接口 - 预估: 4h
  - 下游客户升级为集成商
  - 集成商降级为下游客户
- [ ] Task 2.3.4: 实现组织用户查询接口 - 预估: 2h
- [ ] Task 2.3.5: 前端组织管理页面 - 预估: 10h
  - 组织列表
  - 创建/编辑组织表单
  - 组织树展示
  - 升级降级操作

#### 2.4 用户管理功能（5天）
- [ ] Task 2.4.1: 实现用户CRUD接口 - 预估: 8h
  - FE-007-02: 用户创建、查询、更新、删除
  - 用户状态管理
- [ ] Task 2.4.2: 实现用户角色分配接口 - 预估: 4h
  - 分配角色
  - 移除角色
  - 查询用户角色
- [ ] Task 2.4.3: 实现批量操作接口 - 预估: 3h
- [ ] Task 2.4.4: 前端用户管理页面 - 预估: 10h
  - 用户列表（支持租户过滤）
  - 创建/编辑用户表单
  - 角色分配
  - 批量操作

### Phase 3: RBAC权限模型（2周）

**目标**: 实现三级权限架构

#### 3.1 角色管理功能（5天）
- [ ] Task 3.1.1: 实现角色CRUD接口 - 预估: 6h
  - FE-007-03: 角色创建、查询、更新、删除
  - 预定义角色（系统管理员、组织管理员、普通用户）
  - 自定义角色
- [ ] Task 3.1.2: 实现角色权限配置接口 - 预估: 6h
  - 配置功能权限
  - 配置操作权限
  - 权限批量配置
- [ ] Task 3.1.3: 实现权限缓存（Redis） - 预估: 4h
- [ ] Task 3.1.4: 实现权限检查接口 - 预估: 3h
- [ ] Task 3.1.5: 前端角色管理页面 - 预估: 10h
  - 角色列表
  - 创建/编辑角色表单
  - 权限配置界面（功能×操作矩阵）
  - 权限预览

#### 3.2 权限验证机制（3天）
- [ ] Task 3.2.1: 实现权限验证中间件 - 预估: 6h
  - requirePermission中间件
  - requireAction中间件
  - requireRole中间件
- [ ] Task 3.2.2: 实现前端权限SDK（MobX） - 预估: 6h
  - PermissionStore
  - hasPermission computed
  - usePermission hook
- [ ] Task 3.2.3: 实现前端权限组件 - 预估: 4h
  - PermissionWrapper（权限包裹组件）
  - RoleAwareButton（角色感知按钮）
  - 权限提示（hover提示）

#### 3.3 功能权限定义（2天）
- [ ] Task 3.3.1: 定义9个功能模块权限 - 预估: 2h
  - SYSTEM_CONFIG
  - ORGANIZATION_MANAGEMENT
  - USER_MANAGEMENT
  - ROLE_MANAGEMENT
  - DEVICE_MANAGEMENT
  - DATA_VIEW
  - ALERT_MANAGEMENT
  - QUOTA_MANAGEMENT
  - AUDIT_LOG_VIEW
- [ ] Task 3.3.2: 定义操作权限 - 预估: 2h
  - VIEW, CREATE, EDIT, DELETE, EXPORT, IMPORT
- [ ] Task 3.3.3: 初始化预定义角色权限数据 - 预估: 2h

### Phase 4: 高级功能开发（3周）

**目标**: 实现动态界面、配额管理、审计日志

#### 4.1 前端动态界面（6天）
- [ ] Task 4.1.1: 实现动态菜单系统 - 预估: 6h
  - FE-007-06: 根据租户类型动态显示菜单
  - 菜单配置（JSON）
  - 权限验证
- [ ] Task 4.1.2: 实现动态表单系统 - 预估: 6h
  - 根据租户类型显示/隐藏字段
  - 自动填充字段
  - 表单验证动态调整
- [ ] Task 4.1.3: 实现动态按钮系统 - 预估: 4h
  - 根据操作权限显示/隐藏按钮
  - 按钮禁用状态
  - 权限提示
- [ ] Task 4.1.4: 实现动态表格系统 - 预估: 4h
  - 根据租户类型显示/隐藏列
  - 根据权限显示/隐藏操作列
- [ ] Task 4.1.5: 实现动态统计图表 - 预估: 4h
  - 集成商视图：多租户统计
  - 下游客户视图：单租户统计
- [ ] Task 4.1.6: 实现界面简化规则 - 预估: 4h
  - 下游客户界面简化（菜单项减少50%）
  - 集成商界面完整（包含所有管理功能）

#### 4.2 功能模块与配额管理（6天）
- [ ] Task 4.2.1: 实现功能模块管理接口 - 预估: 6h
  - FE-007-08: 功能模块定义（9个模块）
  - 平台超管为租户开通功能
  - 租户功能查询
- [ ] Task 4.2.2: 实现配额分配接口 - 预估: 6h
  - 集成商为下游分配配额
  - 配额使用统计
  - 配额检查中间件
- [ ] Task 4.2.3: 实现配额使用统计接口 - 预估: 4h
  - total, used, remaining, allocated
  - 统计报表
- [ ] Task 4.2.4: 实现前端功能管理页面 - 预估: 8h
  - 功能模块列表
  - 开通功能表单
  - 配额分配界面
  - 配额使用统计图表

#### 4.3 审计日志系统（6天）
- [ ] Task 4.3.1: 实现审计日志中间件 - 预估: 8h
  - FE-007-09: 自动记录CRUD操作
  - JSON格式action_detail
  - before/after/changes计算
  - 异步写入（不阻塞业务）
- [ ] Task 4.3.2: 实现审计日志查询接口 - 预估: 6h
  - 多条件查询（模块、操作类型、时间范围）
  - 分页显示
- [ ] Task 4.3.3: 实现审计日志导出接口 - 预估: 4h
  - 导出为Excel/CSV
  - 敏感信息脱敏
- [ ] Task 4.3.4: 实现日志归档和清理 - 预估: 4h
  - 定时任务清理超过6个月的日志
  - 归档压缩存储
- [ ] Task 4.3.5: 实现前端审计日志页面 - 预估: 10h
  - 日志列表（多条件筛选）
  - 日志详情（JSON高亮显示）
  - before/after对比视图
  - 变更高亮显示
  - 日志导出功能

### Phase 5: 数据隔离实现（1周）

**目标**: 实现双字段数据隔离

#### 5.1 租户隔离机制（3天）
- [ ] Task 5.1.1: 实现GORM Hook自动填充 - 预估: 4h
  - FE-007-04: tenant_id自动填充
  - managed_tenant_id自动填充
  - BeforeCreate Hook
- [ ] Task 5.1.2: 实现租户隔离Scope - 预估: 4h
  - TenantScope（下游租户查询）
  - ManagedTenantScope（集成商查询）
  - 自动应用Scope
- [ ] Task 5.1.3: 实现租户隔离中间件 - 预估: 3h
  - 集成商/下游客户自动判断
  - 自动应用查询Scope
- [ ] Task 5.1.4: 单元测试：数据隔离 - 预估: 3h
  - 下游客户只能看到自己的数据
  - 集成商可以看到所有下游数据
  - 跨租户严格隔离

#### 5.2 组织层级管理（2天）
- [ ] Task 5.2.1: 实现parent_tenant_id层级查询 - 预估: 3h
  - 递归CTE查询
  - 组织树展示
- [ ] Task 5.2.2: 实现层级权限继承 - 预估: 3h
  - 父组织权限继承
  - 可配置继承规则

### Phase 6: 测试与优化（2周）

**目标**: 完整测试、性能优化、Bug修复

#### 6.1 单元测试（5天）
- [ ] Task 6.1.1: 后端Service层单元测试 - 预估: 12h
  - AuthService
  - OrganizationService
  - UserService
  - RoleService
  - PermissionService
  - QuotaService
  - AuditLogService
  - 目标覆盖率: >80%
- [ ] Task 6.1.2: 后端Repository层单元测试 - 预估: 8h
  - TenantRepository
  - UserRepository
  - RoleRepository
  - PermissionRepository
  - 目标覆盖率: >80%
- [ ] Task 6.1.3: 前端MobX Store单元测试 - 预估: 8h
  - AuthStore
  - PermissionStore
  - TenantStore
  - UIStore
  - 目标覆盖率: >80%
- [ ] Task 6.1.4: 前端组件单元测试 - 预估: 8h
  - 关键业务组件
  - 使用React Testing Library
  - 目标覆盖率: >70%

#### 6.2 集成测试（3天）
- [ ] Task 6.2.1: 后端API集成测试 - 预估: 8h
  - 认证流程测试
  - 权限验证测试
  - 数据隔离测试
  - 使用testcontainers
- [ ] Task 6.2.2: 前端E2E测试 - 预估: 6h
  - 关键用户流程
  - 使用Playwright
- [ ] Task 6.2.3: 前后端集成测试 - 预估: 4h
  - 完整业务流程测试

#### 6.3 性能测试（2天）
- [ ] Task 6.3.1: API性能测试 - 预估: 4h
  - 使用k6工具
  - 1000并发登录测试
  - 5000并发查询测试
  - 目标: P95 < 200ms
- [ ] Task 6.3.2: 数据库性能优化 - 预估: 4h
  - 索引优化
  - 查询优化
  - 分区表（audit_logs）
- [ ] Task 6.3.3: 前端性能优化 - 预估: 4h
  - 代码分割
  - 组件懒加载
  - 虚拟列表

#### 6.4 安全测试（2天）
- [ ] Task 6.4.1: 安全扫描 - 预估: 4h
  - 使用gosec扫描Go代码
  - 使用npm audit扫描前端依赖
- [ ] Task 6.4.2: 渗透测试 - 预估: 4h
  - SQL注入测试
  - XSS测试
  - CSRF测试
  - 权限绕过测试

#### 6.5 Bug修复（4天）
- [ ] Task 6.5.1: 修复测试发现的问题 - 预估: 16h
  - 按优先级修复
  - 回归测试

### Phase 7: 部署与文档（1周）

**目标**: 部署上线、文档完善

#### 7.1 部署准备（2天）
- [ ] Task 7.1.1: 配置生产环境数据库 - 预估: 2h
  - PostgreSQL 14+
  - Redis 7.0+
- [ ] Task 7.1.2: 配置Nginx反向代理 - 预估: 2h
- [ ] Task 7.1.3: 配置SSL证书（HTTPS） - 预估: 2h
- [ ] Task 7.1.4: 配置Docker生产镜像 - 预估: 3h
- [ ] Task 7.1.5: 编写docker-compose.prod.yml - 预估: 2h

#### 7.2 部署上线（1天）
- [ ] Task 7.2.1: 数据库迁移 - 预估: 1h
- [ ] Task 7.2.2: 后端服务部署 - 预估: 2h
- [ ] Task 7.2.3: 前端应用部署 - 预估: 1h
- [ ] Task 7.2.4: 健康检查配置 - 预估: 1h

#### 7.3 文档编写（2天）
- [ ] Task 7.3.1: 生成Swagger API文档 - 预估: 2h
  - 使用swaggo自动生成
  - 所有接口有详细说明
- [ ] Task 7.3.2: 编写运维文档 - 预估: 4h
  - 部署文档
  - 配置说明
  - 故障排查
- [ ] Task 7.3.3: 编写用户手册 - 预估: 4h
  - 用户注册指南
  - 组织管理指南
  - 角色权限配置指南
  - 常见问题

## 技术实现要点

### 后端文件结构

```
platforms/cloud/backend/
├── cmd/
│   └── server/
│       └── main.go                    # 入口文件
├── internal/
│   ├── auth/
│   │   ├── middleware.go             # JWT认证中间件
│   │   ├── service.go                # AuthService
│   │   └── repository.go             # AuthRepository
│   ├── tenant/
│   │   ├── model.go                 # Tenant模型
│   │   ├── service.go                # TenantService
│   │   └── repository.go             # TenantRepository
│   ├── user/
│   │   ├── model.go                 # User模型
│   │   ├── service.go                # UserService
│   │   └── repository.go             # UserRepository
│   ├── role/
│   │   ├── model.go                 # Role模型
│   │   ├── service.go                # RoleService
│   │   └── repository.go             # RoleRepository
│   ├── permission/
│   │   ├── model.go                 # Permission模型
│   │   ├── service.go                # PermissionService
│   │   └── repository.go             # PermissionRepository
│   ├── quota/
│   │   ├── model.go                 # Quota模型
│   │   ├── service.go                # QuotaService
│   │   └── repository.go             # QuotaRepository
│   ├── audit/
│   │   ├── model.go                 # AuditLog模型
│   │   ├── middleware.go             # 审计日志中间件
│   │   ├── service.go                # AuditLogService
│   │   └── repository.go             # AuditLogRepository
│   ├── api/
│   │   ├── router.go                 # 路由配置
│   │   ├── handler/
│   │   │   ├── auth.go               # 认证Handler
│   │   │   ├── tenant.go             # 组织Handler
│   │   │   ├── user.go               # 用户Handler
│   │   │   ├── role.go               # 角色Handler
│   │   │   ├── permission.go         # 权限Handler
│   │   │   ├── quota.go              # 配额Handler
│   │   │   └── audit.go              # 审计日志Handler
│   │   └── middleware/
│   │       ├── cors.go                # CORS中间件
│   │       ├── logging.go             # 日志中间件
│   │       ├── recovery.go            # 错误恢复中间件
│   │       └── tenant_isolation.go    # 租户隔离中间件
│   ├── pkg/
│   │   ├── database/
│   │   │   ├── postgres.go            # PostgreSQL连接
│   │   │   ├── hooks.go               # GORM Hooks
│   │   │   └── migrations.go          # 数据库迁移
│   │   ├── redis/
│   │   │   └── client.go               # Redis客户端
│   │   ├── jwt/
│   │   │   └── token.go               # JWT工具
│   │   ├── validator/
│   │   │   └── validator.go           # 验证器
│   │   └── utils/
│   │       ├── serial_number.go      # 企业序列号生成
│   │       └── password.go            # 密码工具
│   └── config/
│       └── config.go                 # 配置管理
├── migrations/                         # 数据库迁移文件
├── tests/                             # 测试文件
│   ├── unit/
│   ├── integration/
│   └── performance/
├── go.mod
├── go.sum
└── Dockerfile
```

### 前端文件结构

```
platforms/cloud/frontend/
├── src/
│   ├── api/
│   │   ├── auth.ts                   # 认证API
│   │   ├── tenant.ts                # 组织API
│   │   ├── user.ts                  # 用户API
│   │   ├── role.ts                  # 角色API
│   │   ├── permission.ts            # 权限API
│   │   ├── quota.ts                 # 配额API
│   │   └── audit.ts                 # 审计日志API
│   ├── stores/
│   │   ├── AuthStore.ts             # 认证状态管理
│   │   ├── PermissionStore.ts       # 权限状态管理
│   │   ├── TenantStore.ts           # 租户状态管理
│   │   └── UIStore.ts               # UI状态管理
│   ├── components/
│   │   ├── auth/
│   │   │   ├── LoginForm.tsx         # 登录表单
│   │   │   ├── RegisterForm.tsx      # 注册表单
│   │   │   └── ForgotPasswordForm.tsx
│   │   ├── tenant/
│   │   │   ├── TenantList.tsx        # 组织列表
│   │   │   ├── TenantForm.tsx        # 组织表单
│   │   │   └── TenantTree.tsx        # 组织树
│   │   ├── user/
│   │   │   ├── UserList.tsx          # 用户列表
│   │   │   ├── UserForm.tsx          # 用户表单
│   │   │   └── AssignRoleModal.tsx    # 角色分配
│   │   ├── role/
│   │   │   ├── RoleList.tsx          # 角色列表
│   │   │   ├── RoleForm.tsx          # 角色表单
│   │   │   └── PermissionMatrix.tsx   # 权限配置
│   │   ├── audit/
│   │   │   ├── AuditLogList.tsx      # 审计日志列表
│   │   │   ├── AuditLogDetail.tsx    # 日志详情
│   │   │   └── ChangeHighlight.tsx   # 变更高亮
│   │   ├── common/
│   │   │   ├── PermissionWrapper.tsx  # 权限包裹组件
│   │   │   ├── RoleAwareButton.tsx    # 角色感知按钮
│   │   │   └── AutoFillField.tsx     # 自动填充字段
│   │   └── layout/
│   │       ├── MainLayout.tsx         # 主布局
│   │       ├── Header.tsx             # 顶部导航
│   │       ├── Sidebar.tsx            # 侧边栏
│   │       └── Footer.tsx            # 底部
│   ├── pages/
│   │   ├── Login.tsx                 # 登录页
│   │   ├── Dashboard.tsx             # 仪表板
│   │   ├── organizations/
│   │   │   ├── List.tsx              # 组织列表页
│   │   │   └── Detail.tsx            # 组织详情页
│   │   ├── users/
│   │   │   ├── List.tsx              # 用户列表页
│   │   │   └── Detail.tsx            # 用户详情页
│   │   ├── roles/
│   │   │   ├── List.tsx              # 角色列表页
│   │   │   └── Detail.tsx            # 角色详情页
│   │   ├── audit-logs/
│   │   │   └── List.tsx              # 审计日志页
│   │   └── settings/
│   │       └── Profile.tsx           # 个人设置页
│   ├── router/
│   │   └── index.tsx                 # 路由配置
│   ├── types/
│   │   ├── auth.ts                   # 认证类型
│   │   ├── tenant.ts                 # 组织类型
│   │   ├── user.ts                   # 用户类型
│   │   ├── role.ts                   # 角色类型
│   │   └── permission.ts             # 权限类型
│   ├── utils/
│   │   ├── request.ts                # Axios封装
│   │   ├── storage.ts                # LocalStorage封装
│   │   └── validator.ts              # 验证器
│   ├── App.tsx
│   └── main.tsx
├── public/
├── index.html
├── vite.config.ts
├── tsconfig.json
└── package.json
```

### 核心类/组件

#### 后端核心类

| 类名 | 职责 | 文件路径 | 关键方法 |
|------|------|---------|---------|
| **AuthService** | 用户认证服务 | internal/auth/service.go | Register(), Login(), Logout(), RefreshToken() |
| **TenantService** | 组织管理服务 | internal/tenant/service.go | Create(), Update(), Delete(), UpgradeToIntegrator() |
| **UserService** | 用户管理服务 | internal/user/service.go | Create(), Update(), Delete(), AssignRole() |
| **RoleService** | 角色管理服务 | internal/role/service.go | Create(), Update(), Delete(), ConfigurePermissions() |
| **PermissionService** | 权限服务 | internal/permission/service.go | Check(), LoadUserPermissions(), CachePermissions() |
| **QuotaService** | 配额服务 | internal/quota/service.go | Allocate(), Check(), GetStatistics() |
| **AuditLogService** | 审计日志服务 | internal/audit/service.go | Record(), Query(), Export() |

#### 前端核心组件

| 组件名 | 职责 | 文件路径 | 说明 |
|--------|------|---------|------|
| **AuthStore** | 认证状态管理 | src/stores/AuthStore.ts | 管理用户、租户、Token |
| **PermissionStore** | 权限状态管理 | src/stores/PermissionStore.ts | 权限检查、权限缓存 |
| **TenantStore** | 租户状态管理 | src/stores/TenantStore.ts | 租户信息、功能模块 |
| **PermissionWrapper** | 权限包裹组件 | src/components/common/PermissionWrapper.tsx | 根据权限显示/隐藏内容 |
| **LoginForm** | 登录表单 | src/components/auth/LoginForm.tsx | 用户登录界面 |
| **RegisterForm** | 注册表单 | src/components/auth/RegisterForm.tsx | 用户注册界面 |
| **PermissionMatrix** | 权限配置矩阵 | src/components/role/PermissionMatrix.tsx | 功能×操作权限配置 |

## 代码实现映射表

| 功能ID | 功能点 | 文件路径 | 类/组件 | 函数/方法 | 行号范围 | 状态 |
|--------|--------|---------|---------|----------|---------|------|
| **FE-007-01** | 组织管理 | internal/tenant/ | TenantService | Create() | 待定 | ⏳ |
| **FE-007-01** | 组织管理 | internal/tenant/ | TenantService | UpgradeToIntegrator() | 待定 | ⏳ |
| **FE-007-01** | 组织管理 | internal/tenant/ | TenantService | GetTree() | 待定 | ⏳ |
| **FE-007-02** | 用户注册 | internal/auth/ | AuthService | RegisterNewCompany() | 待定 | ⏳ |
| **FE-007-02** | 用户登录 | internal/auth/ | AuthService | Login() | 待定 | ⏳ |
| **FE-007-02** | JWT认证 | internal/auth/ | middleware.go | ValidateToken() | 待定 | ⏳ |
| **FE-007-03** | 角色管理 | internal/role/ | RoleService | Create() | 待定 | ⏳ |
| **FE-007-03** | 权限配置 | internal/role/ | RoleService | ConfigurePermissions() | 待定 | ⏳ |
| **FE-007-03** | 权限验证 | internal/permission/ | PermissionService | Check() | 待定 | ⏳ |
| **FE-007-04** | 租户隔离 | internal/api/middleware/ | tenant_isolation.go | TenantIsolation() | 待定 | ⏳ |
| **FE-007-05** | 角色切换 | internal/tenant/ | TenantService | UpgradeToIntegrator() | 待定 | ⏳ |
| **FE-007-06** | 动态菜单 | src/components/layout/ | Sidebar.tsx | generateMenuConfig() | 待定 | ⏳ |
| **FE-007-06** | 动态表单 | src/components/tenant/ | TenantForm.tsx | render() | 待定 | ⏳ |
| **FE-007-06** | 权限包裹 | src/components/common/ | PermissionWrapper.tsx | render() | 待定 | ⏳ |
| **FE-007-07** | API路由 | internal/api/ | router.go | SetupRouter() | 待定 | ⏳ |
| **FE-007-08** | 配额分配 | internal/quota/ | QuotaService | Allocate() | 待定 | ⏳ |
| **FE-007-08** | 配额检查 | internal/api/middleware/ | quota.go | QuotaCheck() | 待定 | ⏳ |
| **FE-007-09** | 审计日志 | internal/audit/ | middleware.go | AuditLogMiddleware() | 待定 | ⏳ |
| **FE-007-09** | 日志查询 | src/components/audit/ | AuditLogList.tsx | fetchLogs() | 待定 | ⏳ |

## 依赖项

### 前置依赖

**无**（云平台独立功能，可独立开发）

### 内部依赖

| 功能 | 依赖关系 | 说明 |
|------|---------|------|
| FE-007-02 | 依赖 FE-007-01 | 用户注册需要组织实体 |
| FE-007-03 | 依赖 FE-007-01, FE-007-02 | 权限需要组织和用户 |
| FE-007-04 | 依赖 FE-007-01 | 数据隔离需要managed_tenant_id字段 |
| FE-007-05 | 依赖 FE-007-01, FE-007-03 | 角色切换需要组织和权限 |
| FE-007-06 | 依赖 FE-007-01, FE-007-03 | 动态界面需要租户类型和权限 |
| FE-007-08 | 依赖 FE-007-01, FE-007-03 | 配额管理需要租户和权限 |
| FE-007-09 | 依赖 FE-007-01 | 日志需要租户ID |

### 外部依赖

| 依赖名 | 版本 | 用途 | 许可证 |
|--------|------|------|--------|
| **后端** | | | |
| gin | latest | Web框架 | MIT |
| gorm | 1.25+ | ORM | MIT |
| golang-jwt/jwt | 3.2+ | JWT | MIT |
| go-redis/redis | 8.0+ | Redis客户端 | BSD-2-Clause |
| zap | 1.24+ | 日志 | MIT |
| viper | 1.15+ | 配置管理 | MIT |
| testify | latest | 测试 | MIT |
| swaggo | latest | API文档 | MIT |
| **前端** | | | |
| react | 18.2+ | UI框架 | MIT |
| mobx | 6.9+ | 状态管理 | MIT |
| antd | 5.10+ | UI组件 | MIT |
| react-router-dom | 6.20+ | 路由 | MIT |
| axios | 1.5+ | HTTP客户端 | MIT |
| vite | 5.0+ | 构建工具 | MIT |

### 后置依赖

**所有云平台业务功能**（都需要账号、权限、数据隔离）

## 测试策略

### 单元测试

**后端覆盖率目标**: > 80%

**测试框架**: testify / ginkgo

**关键测试用例**:
- 企业序列号生成（唯一性测试）
- 密码验证（强度、hash）
- JWT Token生成和验证
- 权限检查逻辑
- 租户隔离逻辑
- 配额分配和检查
- 审计日志记录（before/after/changes）

**前端覆盖率目标**: > 70%

**测试框架**: Vitest + React Testing Library

**关键测试用例**:
- MobX Store状态更新
- 权限检查逻辑
- 动态表单渲染
- 动态菜单生成

### 集成测试

**测试场景**:
- **注册登录流程**:
  1. 新企业注册 → 自动创建组织和管理员
  2. 登录 → JWT Token生成
  3. 权限加载 → Redis缓存
  4. 跳转到仪表板

- **组织管理流程**:
  1. 集成商创建下游租户
  2. 分配初始配额
  3. 创建用户并分配角色
  4. 下游租户登录使用

- **权限验证流程**:
  1. 系统管理员创建自定义角色
  2. 配置权限（功能+操作）
  3. 分配给用户
  4. 用户登录验证权限

- **数据隔离流程**:
  1. 集成商创建设备（归属下游）
  2. 下下游客户登录
  3. 验证：只能看到自己的数据
  4. 集成商登录
  5. 验证：可以看到所有下游数据

### 性能测试

**测试工具**: k6

**测试场景**:
1. **登录接口**: 1000并发，P95 < 500ms
2. **查询接口**: 5000并发，P95 < 200ms
3. **数据隔离查询**: 1000并发，P95 < 100ms

### 安全测试

**测试工具**: gosec, npm audit

**测试项**:
- SQL注入防护
- XSS防护
- CSRF防护
- 权限绕过
- 暴力破解防护（限流）

## 依赖忽略记录

**无依赖忽略**（所有依赖已明确，无Mock需求）

## 实施日志

### 2026-01-27

**初始状态**: 实施计划创建完成

**待启动任务**:
- ⏳ Phase 1: 基础架构搭建（2周）
- ⏳ Phase 2: 认证与用户管理（3周）
- ⏳ Phase 3: RBAC权限模型（2周）
- ⏳ Phase 4: 高级功能开发（3周）
- ⏳ Phase 5: 数据隔离实现（1周）
- ⏳ Phase 6: 测试与优化（2周）
- ⏳ Phase 7: 部署与文档（1周）

## 问题记录

| 日期 | 问题描述 | 严重程度 | 解决方案 | 状态 | 责任人 |
|------|---------|---------|---------|------|--------|
| - | - | - | - | - | - |

## 代码审查

### 审查清单
- [ ] 代码符合项目规范
- [ ] 充分的注释和文档
- [ ] 错误处理完善
- [ ] 单元测试覆盖
- [ ] 性能考虑充分
- [ ] 安全检查通过

### 审查意见
| 审查人 | 日期 | 意见 | 状态 |
|--------|------|------|------|
| - | - | - | - |

## 验证记录

### 测试结果
- **单元测试**: ⏳ 待测试
- **集成测试**: ⏳ 待测试
- **性能测试**: ⏳ 待测试
- **安全扫描**: ⏳ 待扫描

### 测试报告
⏳ 待生成

## 部署计划

### 部署环境
- **开发环境**: ⏳ 待部署
- **测试环境**: ⏳ 待部署
- **预生产环境**: ⏳ 待部署
- **生产环境**: ⏳ 待部署

### 部署步骤
1. 配置数据库（PostgreSQL + Redis）
2. 部署后端服务（Docker）
3. 部署前端应用（Nginx）
4. 配置SSL证书
5. 健康检查

### 回滚计划
- 保留旧版本1个月
- 数据库备份（每天）
- 快速回滚脚本（5分钟内）

## 文档更新

- [ ] 技术文档已更新
- [ ] API文档已更新（Swagger）
- [ ] 用户手册已更新
- [ ] 运维文档已更新

## 实施指标

| 指标 | 目标 | 当前 | 状态 |
|------|------|------|------|
| 任务完成度 | 100% | 0% | 0% |
| 代码覆盖率 | >80% | 0% | 0% |
| 测试通过率 | 100% | 0% | 0% |
| 文档完整性 | 100% | 100% | ✅ |

## 变更历史

| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 2026-01-27 | 1.0 | 初始创建实施计划 | Claude Code |

---

## 附录

### 相关文档
- **技术方案**: SOL-007
- **功能需求**: FE-007-01 ~ FE-007-09
- **架构决策**: ADR-001 ~ ADR-007
- **数据库设计**: cloud-table-design-specs.md
