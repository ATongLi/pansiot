# SOL-008: 移动端 UniApp 项目架构方案

## 元数据
- **方案ID**: SOL-008
- **关联功能**: FE-008
- **方案类型**: 架构
- **状态**: 草案
- **设计人**: Claude Code
- **评审人**: 待评审
- **创建日期**: 2026-01-28

## 背景和目标

### 背景
工业物联网移动端应用需要支持设备管理、工程管理、消息推送等核心功能。采用 UniApp 框架实现 iOS/Android/小程序多端兼容,需要建立清晰的项目架构以支持未来功能扩展。

### 目标
1. 建立模块化、可扩展的项目架构
2. 实现高效的开发流程和代码组织
3. 确保多端兼容性和性能优化
4. 提供完整的开发规范和工具链
5. 实现第一个可运行的页面验证架构可行性

## 问题陈述

### 核心问题
1. **项目结构**: 如何设计清晰的目录结构支持模块化开发?
2. **状态管理**: 如何管理全局状态和模块状态?
3. **组件复用**: 如何设计和组织可复用组件库?
4. **API 封装**: 如何封装网络请求和对接云平台 API?
5. **多端兼容**: 如何处理不同平台的差异和兼容性问题?
6. **工程化**: 如何配置开发工具和代码规范?

## 方案概述

本方案采用 **模块化 + 分层架构**,将项目划分为核心模块、业务模块、通用组件和工具层。使用 **Pinia** 进行状态管理,**TypeScript** 保证类型安全,**Vite** 作为构建工具。通过统一的 API 封装层对接云平台,实现前后端分离。项目采用 **UniApp** 框架实现一次开发,多端运行。

## 技术选型

| 技术领域 | 选型方案 | 理由 | 替代方案 | 对比分析 |
|---------|---------|------|---------|---------|
| **框架** | UniApp (Vue 3) | 官方维护、多端支持、生态完善 | Taro、原生开发 | Taro 语法接近 React,团队熟悉 Vue;原生开发成本高 |
| **语言** | TypeScript | 类型安全、IDE 支持、减少错误 | JavaScript | 缺少类型检查,易出错 |
| **状态管理** | Pinia | Vue 3 官方推荐、轻量、TypeScript 友好 | Vuex | Pinia 更简洁,TypeScript 支持更好 |
| **UI 组件库** | uView UI | 组件丰富、文档完善、维护活跃 | UniUI | uView 组件更丰富,设计更现代 |
| **构建工具** | Vite | 快速热更新、构建速度快 | Webpack | Vite 速度更快,开发体验更好 |
| **HTTP 客户端** | uni.request 封装 | UniApp 内置、多端兼容 | Axios | Axios 在小程序端有兼容问题 |
| **代码规范** | ESLint + Prettier | 业界标准、自动化格式化 | - | 必选工具 |
| **表单验证** | Validator.js | 轻量、灵活 | VeeValidate | 更轻量,更易用 |

## 架构设计

### 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                       Presentation Layer                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │  Pages   │  │Components│  │  Layouts │  │ Plugins │ │
│  │ (页面)   │  │ (组件)   │  │  (布局)  │  │ (插件)  │ │
│  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                      Business Layer                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │  Auth    │  │ Device   │  │Workspace │  │Message  │ │
│  │ Module   │  │ Module   │  │  Module  │  │ Module  │ │
│  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                        Data Layer                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │    API   │  │  Store   │  │  Cache   │  │ Storage │ │
│  │ Service  │  │ (Pinia)  │  │  Manager │  │ Manager │ │
│  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                      Foundation Layer                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │  Utils   │  │Directives│  │   Hooks  │  │Filters  │ │
│  │ (工具)   │  │ (指令)   │  │  (钩子)  │  │ (过滤器) │ │
│  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │
└─────────────────────────────────────────────────────────┘
                            ↓
                    ┌───────────────┐
                    │  Cloud API    │
                    │  (云平台接口) │
                    └───────────────┘
```

### 目录结构设计

```
pansiot-app/
├── src/                         # 源代码目录
│   ├── components/              # 通用组件
│   │   ├── common/              # 通用组件
│   │   │   ├── AppNavBar.vue    # 自定义导航栏
│   │   │   ├── PageContainer.vue # 页面容器
│   │   │   ├── Loading.vue      # 加载指示器
│   │   │   ├── EmptyState.vue   # 空状态
│   │   │   ├── NetworkError.vue # 网络异常
│   │   │   ├── Refresh.vue      # 下拉刷新
│   │   │   └── LoadMore.vue     # 上拉加载
│   │   └── business/            # 业务组件
│   │       ├── DeviceCard.vue   # 设备卡片
│   │       ├── MessageItem.vue  # 消息项
│   │       └── ChartPanel.vue   # 图表面板
│   │
│   ├── modules/                 # 业务模块
│   │   ├── auth/                # 认证模块
│   │   │   ├── pages/           # 模块页面
│   │   │   │   ├── login.vue    # 登录页
│   │   │   │   └── register.vue # 注册页
│   │   │   ├── components/      # 模块组件
│   │   │   ├── services/        # 模块服务
│   │   │   │   └── auth.service.ts
│   │   │   ├── stores/          # 模块状态
│   │   │   │   └── auth.store.ts
│   │   │   └── types/           # 模块类型
│   │   │       └── auth.types.ts
│   │   │
│   │   ├── device/              # 设备模块
│   │   │   ├── pages/
│   │   │   │   ├── list.vue     # 设备列表
│   │   │   │   └── detail.vue   # 设备详情
│   │   │   ├── components/
│   │   │   ├── services/
│   │   │   │   └── device.service.ts
│   │   │   ├── stores/
│   │   │   │   └── device.store.ts
│   │   │   └── types/
│   │   │       └── device.types.ts
│   │   │
│   │   ├── workspace/           # 工作台模块
│   │   │   ├── pages/
│   │   │   │   └── index.vue
│   │   │   ├── components/
│   │   │   ├── services/
│   │   │   ├── stores/
│   │   │   │   └── workspace.store.ts
│   │   │   └── types/
│   │   │
│   │   ├── dashboard/           # 看板模块
│   │   │   ├── pages/
│   │   │   │   └── index.vue
│   │   │   ├── components/
│   │   │   ├── services/
│   │   │   ├── stores/
│   │   │   │   └── dashboard.store.ts
│   │   │   └── types/
│   │   │
│   │   ├── message/             # 消息模块
│   │   │   ├── pages/
│   │   │   │   ├── list.vue
│   │   │   │   └── detail.vue
│   │   │   ├── components/
│   │   │   ├── services/
│   │   │   │   └── message.service.ts
│   │   │   ├── stores/
│   │   │   │   └── message.store.ts
│   │   │   └── types/
│   │   │
│   │   └── profile/             # 我的模块
│   │       ├── pages/
│   │       │   ├── index.vue    # 个人中心
│   │       │   └── settings.vue # 设置
│   │       ├── components/
│   │       ├── services/
│   │       ├── stores/
│   │       │   └── profile.store.ts
│   │       └── types/
│   │
│   ├── pages/                   # 全局页面
│   │   ├── index/               # 启动页/欢迎页
│   │   │   └── index.vue
│   │   └── tabbar/              # TabBar 页面
│   │       ├── workspace.vue    # 工作台
│   │       ├── device.vue       # 设备
│   │       ├── dashboard.vue    # 看板
│   │       ├── message.vue      # 消息
│   │       └── profile.vue      # 我的
│   │
│   ├── api/                     # API 封装层
│   │   ├── client/              # HTTP 客户端
│   │   │   ├── request.ts       # 请求封装
│   │   │   ├── interceptors.ts  # 拦截器
│   │   │   └── config.ts        # 配置
│   │   ├── modules/             # API 模块
│   │   │   ├── auth.api.ts      # 认证 API
│   │   │   ├── device.api.ts    # 设备 API
│   │   │   ├── workspace.api.ts # 工作台 API
│   │   │   ├── dashboard.api.ts # 看板 API
│   │   │   ├── message.api.ts   # 消息 API
│   │   │   └── profile.api.ts   # 我的 API
│   │   └── types/               # API 类型
│   │       └── api.types.ts
│   │
│   ├── stores/                  # 全局状态
│   │   ├── app.store.ts         # 应用状态
│   │   ├── user.store.ts        # 用户状态
│   │   └── tenant.store.ts      # 租户状态
│   │
│   ├── utils/                   # 工具函数
│   │   ├── validator.ts         # 表单验证
│   │   ├── format.ts            # 格式化
│   │   ├── storage.ts           # 存储封装
│   │   ├── cache.ts             # 缓存管理
│   │   ├── permission.ts        # 权限控制
│   │   ├── date.ts              # 日期处理
│   │   └── device.ts            # 设备相关
│   │
│   ├── hooks/                   # 组合式函数
│   │   ├── useRequest.ts        # 请求钩子
│   │   ├── useAuth.ts           # 认证钩子
│   │   ├── useUpload.ts         # 上传钩子
│   │   └── useDevice.ts         # 设备钩子
│   │
│   ├── directives/              # 自定义指令
│   │   ├── permission.ts        # 权限指令
│   │   └── loading.ts           # 加载指令
│   │
│   ├── filters/                 # 过滤器
│   │   ├── date.ts              # 日期过滤
│   │   └── number.ts            # 数字过滤
│   │
│   ├── styles/                  # 样式文件
│   │   ├── variables.scss       # SCSS 变量
│   │   ├── mixins.scss          # SCSS 混入
│   │   ├── common.scss          # 通用样式
│   │   └── reset.scss           # 重置样式
│   │
│   ├── config/                  # 配置文件
│   │   ├── index.ts             # 主配置
│   │   ├── env.ts               # 环境配置
│   │   └── constants.ts         # 常量配置
│   │
│   ├── types/                   # 全局类型
│   │   ├── global.d.ts          # 全局类型声明
│   │   ├── vue-shim.d.ts        # Vue 类型声明
│   │   └── uniapp.d.ts          # UniApp 类型声明
│   │
│   ├── App.vue                  # 应用主入口
│   ├── main.ts                  # 主入口文件
│   ├── pages.json               # 页面配置
│   ├── manifest.json            # 应用配置
│   └── uni.scss                 # UniApp 样式变量
│
├── static/                      # 静态资源
│   ├── images/                  # 图片
│   ├── icons/                   # 图标
│   └── fonts/                   # 字体
│
├── uni_modules/                 # UniApp 插件模块
│   └── uview-ui/                # uView UI 组件库
│
├── .env.development             # 开发环境变量
├── .env.production              # 生产环境变量
├── .eslintrc.js                 # ESLint 配置
├── .prettierrc                  # Prettier 配置
├── tsconfig.json                # TypeScript 配置
├── vite.config.ts               # Vite 配置
├── package.json                 # 项目依赖
└── README.md                    # 项目说明
```

### 组件设计

#### 1. 通用组件 (Common Components)

| 组件名 | 职责 | Props | Events | 插槽 |
|--------|------|-------|--------|------|
| **AppNavBar** | 自定义导航栏 | title, showBack, backgroundColor | @back, @clickRight | title, right |
| **PageContainer** | 页面容器 | padding, backgroundColor | - | default |
| **Loading** | 加载指示器 | visible, text, type | - | - |
| **EmptyState** | 空状态 | icon, text, description | @retry | - |
| **NetworkError** | 网络异常 | visible | @retry | - |
| **Refresh** | 下拉刷新 | disabled | @refresh | - |
| **LoadMore** | 上拉加载 | loading, finished, hasMore | @load | - |

#### 2. 业务组件 (Business Components)

| 组件名 | 职责 | Props | Events | 所属模块 |
|--------|------|-------|--------|---------|
| **DeviceCard** | 设备卡片 | device, showStatus | @click, @toggle | Device |
| **MessageItem** | 消息项 | message, showUnread | @click | Message |
| **ChartPanel** | 图表面板 | type, data, options | - | Dashboard |
| **QuickAction** | 快捷操作 | actions | @action | Workspace |
| **DeviceFilter** | 设备筛选 | filters | @filter | Device |
| **MessageTabs** | 消息标签页 | tabs, activeTab | @change | Message |

### 数据流设计

```
┌──────────────┐
│    Page      │
│  (Vue Page)  │
└──────┬───────┘
       │
       ↓ useStore()
┌──────────────┐
│  Pinia Store │ ←→ Local State (模块状态)
└──────┬───────┘
       │
       ↓ API Service
┌──────────────┐
│ API Client   │ ←→ Cache Manager
└──────┬───────┘
       │
       ↓ HTTP Request
┌──────────────┐
│ Cloud API    │
│  (云平台)    │
└──────────────┘
```

#### 数据流说明

1. **用户交互** → **页面组件**
2. **页面组件** → **调用 Pinia Store actions**
3. **Store actions** → **调用 API Service**
4. **API Service** → **通过 HTTP Client 发送请求**
5. **HTTP Client** → **拦截器处理 (Token, 错误)**
6. **请求发送** → **云平台 API**
7. **响应返回** → **拦截器处理错误**
8. **数据更新** → **Store state 更新**
9. **页面响应式** → **自动更新视图**

## 接口设计

### API 接口封装

#### 认证 API (auth.api.ts)

```typescript
// 登录
export interface LoginParams {
  username: string;  // 手机号/邮箱
  password: string;  // 密码
  tenantId?: string; // 企业序列号 (可选)
}

export interface LoginResult {
  token: string;
  refreshToken: string;
  expiresIn: number;
  user: UserInfo;
}

export const authApi = {
  // 登录
  login: (params: LoginParams) => request.post<LoginResult>('/api/auth/login', params),

  // 注册
  register: (params: RegisterParams) => request.post<LoginResult>('/api/auth/register', params),

  // 刷新 Token
  refreshToken: (refreshToken: string) =>
    request.post<{ token: string }>('/api/auth/refresh', { refreshToken }),

  // 登出
  logout: () => request.post('/api/auth/logout'),

  // 发送验证码
  sendCode: (phone: string) =>
    request.post('/api/auth/send-code', { phone }),

  // 验证验证码
  verifyCode: (phone: string, code: string) =>
    request.post('/api/auth/verify-code', { phone, code }),
};
```

#### 设备 API (device.api.ts)

```typescript
export interface DeviceListParams {
  page: number;
  pageSize: number;
  status?: DeviceStatus;
  keyword?: string;
}

export interface DeviceListResult {
  list: Device[];
  total: number;
}

export const deviceApi = {
  // 获取设备列表
  list: (params: DeviceListParams) =>
    request.get<DeviceListResult>('/api/devices', { params }),

  // 获取设备详情
  detail: (id: string) =>
    request.get<Device>(`/api/devices/${id}`),

  // 控制设备
  control: (id: string, command: DeviceCommand) =>
    request.post(`/api/devices/${id}/control`, command),

  // 获取设备状态
  status: (id: string) =>
    request.get<DeviceStatus>(`/api/devices/${id}/status`),
};
```

### 数据模型

#### 用户模型 (UserInfo)

```typescript
interface UserInfo {
  id: string;              // 用户 ID
  username: string;        // 用户名
  phone?: string;          // 手机号
  email?: string;          // 邮箱
  avatar?: string;         // 头像
  roles: Role[];           // 角色列表
  tenantId: string;        // 租户 ID
  tenantName: string;      // 租户名称
  createdAt: string;       // 创建时间
}
```

#### 设备模型 (Device)

```typescript
interface Device {
  id: string;              // 设备 ID
  name: string;            // 设备名称
  type: string;            // 设备类型
  status: DeviceStatus;    // 设备状态
  online: boolean;         // 在线状态
  location?: string;       // 位置
  lastOnline?: string;     // 最后在线时间
  properties: Record<string, any>; // 设备属性
  createdAt: string;       // 创建时间
}

enum DeviceStatus {
  Normal = 'normal',       // 正常
  Warning = 'warning',     // 警告
  Error = 'error',         // 故障
  Offline = 'offline',     // 离线
}
```

## 状态管理设计

### Pinia Store 结构

```typescript
// stores/app.store.ts - 应用状态
export const useAppStore = defineStore('app', {
  state: () => ({
    theme: 'light',        // 主题
    language: 'zh-CN',     // 语言
    networkStatus: true,   // 网络状态
  }),
  actions: {
    setTheme(theme: string) { ... },
    setLanguage(lang: string) { ... },
    setNetworkStatus(status: boolean) { ... },
  },
});

// stores/user.store.ts - 用户状态
export const useUserStore = defineStore('user', {
  state: () => ({
    token: '',
    userInfo: null as UserInfo | null,
    isLoggedIn: false,
  }),
  getters: {
    hasPermission: (state) => (permission: string) => {
      return state.userInfo?.roles.some(role =>
        role.permissions.includes(permission)
      );
    },
  },
  actions: {
    async login(params: LoginParams) { ... },
    async logout() { ... },
    async getUserInfo() { ... },
  },
  persist: {
    key: 'user-store',
    storage: {
      getItem: uni.getStorageSync,
      setItem: uni.setStorageSync,
    },
  },
});

// stores/tenant.store.ts - 租户状态
export const useTenantStore = defineStore('tenant', {
  state: () => ({
    currentTenant: null as Tenant | null,
    tenantList: [] as Tenant[],
  }),
  actions: {
    switchTenant(tenantId: string) { ... },
    fetchTenantList() { ... },
  },
});
```

## 实施计划

### 阶段1: 项目初始化 (2-3天)
- [ ] 创建 UniApp 项目
- [ ] 配置 TypeScript
- [ ] 配置 Vite
- [ ] 安装依赖 (Pinia, uView UI)
- [ ] 配置 ESLint + Prettier
- [ ] 创建目录结构
- [ ] 配置环境变量

### 阶段2: 基础架构搭建 (3-4天)
- [ ] 封装 HTTP Client
- [ ] 配置请求/响应拦截器
- [ ] 配置 Pinia 状态管理
- [ ] 创建全局 Store (app, user, tenant)
- [ ] 封装工具函数
- [ ] 创建通用组件 (7个)
- [ ] 配置路由和 TabBar

### 阶段3: 核心模块骨架 (4-5天)
- [ ] 登录模块 (Auth)
  - 登录页、注册页
  - Auth Service
  - Auth Store
- [ ] 设备模块 (Device)
  - 设备列表页、详情页
  - Device Service
  - Device Store
- [ ] 工作台模块 (Workspace)
  - 工作台页
  - Workspace Service
  - Workspace Store
- [ ] 看板模块 (Dashboard)
  - 看板页
  - Dashboard Service
- [ ] 消息模块 (Message)
  - 消息列表页、详情页
  - Message Service
- [ ] 我的模块 (Profile)
  - 个人中心页、设置页
  - Profile Service

### 阶段4: 第一个页面实现 (2-3天)
- [ ] 启动页/欢迎页
  - Logo 展示
  - 版本信息
  - 自动跳转
- [ ] 或登录页
  - 表单验证
  - API 调用 (Mock)
  - 登录成功跳转
- [ ] 多端测试 (iOS/Android/小程序)

### 阶段5: 优化和文档 (2-3天)
- [ ] 性能优化
- [ ] 多端兼容性测试
- [ ] 编写开发文档
- [ ] 编写组件文档
- [ ] 编写 API 文档

**总计**: 13-18天 (约2-3周)

## 风险和挑战

| 风险 | 影响 | 概率 | 缓解措施 | 责任人 |
|------|------|------|---------|--------|
| **UniApp 多端兼容性问题** | 高 | 中 | 提前测试各端差异,使用条件编译 | 开发团队 |
| **性能问题** | 中 | 中 | 代码分包、懒加载、图片优化 | 开发团队 |
| **第三方组件库兼容性** | 中 | 低 | 选择成熟的组件库,验证兼容性 | 开发团队 |
| **云平台 API 未就绪** | 低 | 中 | 使用 Mock 数据并行开发 | 开发团队 |
| **团队成员不熟悉 UniApp** | 中 | 低 | 提供培训、文档、最佳实践 | 技术负责人 |

## 影响分析

### 影响范围
- **模块**: 所有移动端模块
- **系统**: 移动端应用 (iOS/Android/小程序/H5)
- **功能**: FE-008 及后续所有移动端功能 (FE-009 ~ FE-012)

### 兼容性
- 本方案为全新项目,无向后兼容问题
- 设计考虑未来扩展性,支持新增模块和功能

### 迁移策略
- 无需迁移,为新项目初始化

## 架构决策记录 (ADR)

### 决策1: 采用 UniApp 框架

- **状态**: 已接受
- **日期**: 2026-01-28
- **上下文**: 需要实现 iOS/Android/小程序多端兼容的移动端应用
- **决策**: 选择 UniApp 作为跨平台框架
- **后果**:
  - **正面**:
    - 一次开发,多端运行
    - Vue 语法,学习成本低
    - 官方维护,生态完善
    - 多端兼容性好
  - **负面**:
    - 性能不如原生
    - 某些平台能力受限
  - **缓解措施**:
    - 关键功能使用原生插件
    - 性能优化(代码分包、懒加载)

### 决策2: 使用 Pinia 而非 Vuex

- **状态**: 已接受
- **日期**: 2026-01-28
- **上下文**: Vue 3 项目的状态管理方案
- **决策**: 选择 Pinia 作为状态管理库
- **后果**:
  - **正面**:
    - Vue 3 官方推荐
    - TypeScript 支持更好
    - API 更简洁
    - 支持 Composition API
  - **负面**:
    - 团队需要学习新 API
  - **缓解措施**:
    - 提供文档和培训

### 决策3: 使用 TypeScript

- **状态**: 已接受
- **日期**: 2026-01-28
- **上下文**: 提高代码质量和可维护性
- **决策**: 全面使用 TypeScript 开发
- **后果**:
  - **正面**:
    - 类型安全,减少错误
    - IDE 支持更好
    - 代码可读性更高
    - 重构更安全
  - **负面**:
    - 开发初期略繁琐
    - 学习成本
  - **缓解措施**:
    - 使用 strict 模式
    - 提供类型定义模板

### 决策4: 封装 uni.request 而非使用 Axios

- **状态**: 已接受
- **日期**: 2026-01-28
- **上下文**: HTTP 客户端方案选择
- **决策**: 封装 uni.request 作为 HTTP 客户端
- **后果**:
  - **正面**:
    - UniApp 内置,多端兼容
    - 轻量,无需额外依赖
    - 符合 UniApp 最佳实践
  - **负面**:
    - 功能不如 Axios 丰富
  - **缓解措施**:
    - 封装拦截器、请求取消等功能

### 决策5: 模块化架构设计

- **状态**: 已接受
- **日期**: 2026-01-28
- **上下文**: 项目架构和代码组织
- **决策**: 采用模块化架构,按业务模块组织代码
- **后果**:
  - **正面**:
    - 职责清晰,易于维护
    - 支持并行开发
    - 易于扩展新功能
    - 代码复用性高
  - **负面**:
    - 初期搭建成本高
  - **缓解措施**:
    - 提供模块模板和脚手架

## 性能考虑

### 性能指标
- **首屏加载时间**: < 2秒
- **页面切换响应**: < 300ms
- **API 请求响应**: < 1秒
- **应用启动时间**: < 3秒
- **内存占用**: < 150MB

### 优化策略

#### 1. 代码优化
- **代码分包**: 按模块分包,减少主包大小
- **懒加载**: 页面和组件使用动态导入
- **Tree Shaking**: 移除未使用的代码
- **压缩混淆**: 生产环境代码压缩

#### 2. 资源优化
- **图片优化**:
  - 使用 WebP 格式
  - 图片懒加载
  - 缩略图和原图分离
- **字体优化**:
  - 按需加载字体
  - 使用系统字体

#### 3. 网络优化
- **请求优化**:
  - 请求合并
  - 请求缓存
  - 预加载关键数据
- **CDN 加速**: 静态资源使用 CDN

#### 4. 渲染优化
- **虚拟列表**: 长列表使用虚拟滚动
- **防抖节流**: 滚动、输入等事件使用防抖节流
- **减少重排重绘**: 优化 CSS 和 DOM 操作

#### 5. 缓存策略
- **本地缓存**:
  - 使用 uni.storage 本地存储
  - 缓存静态数据
  - 缓存 Token
- **接口缓存**:
  - GET 请求缓存
  - 短时数据缓存

## 安全考虑

### 安全威胁
- **XSS 攻击**: 跨站脚本攻击
- **CSRF 攻击**: 跨站请求伪造
- **数据泄露**: Token、敏感数据泄露
- **中间人攻击**: HTTPS 证书问题

### 安全措施

#### 1. 通信安全
- **HTTPS**: 所有 API 请求使用 HTTPS
- **证书校验**: 严格校验 SSL 证书
- **请求签名**: 关键接口使用请求签名

#### 2. 认证授权
- **JWT Token**: 使用 JWT 进行身份认证
- **Token 刷新**: 自动刷新过期 Token
- **权限控制**: 基于角色的权限控制(RBAC)

#### 3. 数据安全
- **敏感数据加密**:
  - 密码使用 bcrypt 加密
  - Token 存储使用加密存储
  - 敏感信息脱敏显示
- **本地存储安全**:
  - Token 不存储在 localStorage
  - 使用 uni.storage 安全存储

#### 4. 输入验证
- **前端验证**:
  - 表单输入验证
  - XSS 过滤
  - SQL 注入防护
- **后端验证**:
  - 依赖后端二次验证
  - 不信任前端数据

#### 5. 防护机制
- **请求防重**: 防止重复提交
- **频率限制**: API 请求频率限制
- **异常检测**: 异常登录检测

## 测试策略

### 单元测试
- **覆盖范围**:
  - 工具函数 (utils/)
  - API Service (api/)
  - Store Actions (stores/)
- **测试工具**:
  - Vitest
  - @testing-library/vue
- **目标覆盖率**: 80%

### 集成测试
- **测试场景**:
  - 登录流程
  - 设备列表加载
  - 设备控制
  - 消息推送
- **测试工具**:
  - UniApp 自动化测试
  - 真机/模拟器测试

### 性能测试
- **测试指标**:
  - 首屏加载时间
  - 页面切换响应
  - 内存占用
  - CPU 占用
- **测试工具**:
  - Chrome DevTools
  - UniApp 性能分析工具

### 兼容性测试
- **测试平台**:
  - iOS (iPhone / iPad)
  - Android (主流设备)
  - 微信小程序
  - H5 (Chrome / Safari)
- **测试内容**:
  - UI 兼容性
  - 功能兼容性
  - 性能差异

## 多端兼容性

### 平台差异处理

#### 1. 条件编译
```typescript
// #ifdef H5
console.log('H5 平台');
// #endif

// #ifdef MP-WEIXIN
console.log('微信小程序');
// #endif

// #ifdef APP-PLUS
console.log('App 平台');
// #endif
```

#### 2. 样式适配
- **rpx 单位**: 响应式像素,自动适配屏幕
- **安全区域**: 适配刘海屏、底部指示器
- **主题适配**: 支持暗色模式

#### 3. API 兼容
- **uni API**: 优先使用 uni.* API
- **Polyfill**: 不支持的功能使用 Polyfill
- **平台检测**: 使用 uni.getSystemInfoSync() 检测平台

## 开发规范

### 命名规范

#### 文件命名
- **组件**: PascalCase (例: DeviceCard.vue)
- **页面**: kebab-case (例: device-list.vue)
- **工具/服务**: kebab-case (例: auth.service.ts)
- **类型文件**: kebab-case (例: auth.types.ts)

#### 变量命名
- **变量/函数**: camelCase (例: getUserInfo)
- **常量**: UPPER_SNAKE_CASE (例: API_BASE_URL)
- **类/接口**: PascalCase (例: UserInfo, DeviceService)
- **类型**: PascalCase (例: LoginParams, DeviceListResult)

#### 组件命名
- **组件文件名**: PascalCase
- **组件注册名**: PascalCase
- **组件使用**: kebab-case (例: <device-card />)

### 代码风格

#### TypeScript
- 使用 `strict` 模式
- 优先使用 `interface` 定义对象类型
- 使用 `type` 定义联合类型
- 避免使用 `any`,使用 `unknown` 代替

#### Vue 3
- 优先使用 Composition API
- 使用 `<script setup>` 语法
- Props 定义使用 TypeScript 类型
- Emits 定义使用 TypeScript 类型

#### 样式
- 优先使用 SCSS
- 使用 BEM 命名规范
- 使用 rpx 单位
- 避免使用内联样式

### 注释规范

#### 文件注释
```typescript
/**
 * 认证服务
 * 提供用户登录、注册、Token 刷新等功能
 */
```

#### 函数注释
```typescript
/**
 * 用户登录
 * @param params 登录参数
 * @returns 登录结果,包含 Token 和用户信息
 */
async login(params: LoginParams): Promise<LoginResult>
```

#### 复杂逻辑注释
```typescript
// 检查 Token 是否过期
// 过期时间 = 当前时间 - 登录时间
const isExpired = Date.now() - loginTime > expiresIn;
```

## 依赖关系

### 外部依赖
- **云平台 API**: FE-007 (弱依赖,可使用 Mock)
- **第三方服务**:
  - 云平台认证服务
  - 云平台设备服务
  - 云平台消息服务

### 内部依赖
- **模块间依赖**:
  - 所有模块依赖全局 Store
  - 所有模块依赖 API Service
  - 所有模块依赖通用组件

### 并行开发
- **与 FE-006 并行**: 无依赖,可并行开发
- **与 FE-007 并行**: 弱依赖,使用 Mock 数据先行开发

## 变更历史
| 日期 | 版本 | 变更内容 | 变更人 | 评审状态 |
|------|------|---------|--------|---------|
| 2026-01-28 | 1.0 | 初始创建 | Claude Code | 待评审 |

## 附录

### A. 技术栈版本
- **UniApp**: 3.0+
- **Vue**: 3.3+
- **TypeScript**: 5.0+
- **Pinia**: 2.1+
- **uView UI**: 2.0+
- **Vite**: 4.0+
- **ESLint**: 8.0+
- **Prettier**: 3.0+

### B. 参考文档
- [UniApp 官方文档](https://uniapp.dcloud.net.cn/)
- [Vue 3 官方文档](https://cn.vuejs.org/)
- [Pinia 官方文档](https://pinia.vuejs.org/zh/)
- [uView UI 文档](https://www.uviewui.com/)
- [TypeScript 官方文档](https://www.typescriptlang.org/zh/)

### C. 开发工具
- **IDE**: VS Code
- **VS Code 插件**:
  - Volar (Vue 3 支持)
  - TypeScript Vue Plugin
  - ESLint
  - Prettier
- **调试工具**:
  - Chrome DevTools (H5)
  - 微信开发者工具 (小程序)
  - Xcode (iOS)
  - Android Studio (Android)
