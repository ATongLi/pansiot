# SOL-007: 云平台账号系统 - 多租户组织管理与RBAC权限控制技术方案

## 元数据
- **方案ID**: SOL-007
- **关联功能**: FE-007-01 ~ FE-007-09
- **方案类型**: 系统架构设计
- **状态**: 草案 v1.0
- **创建日期**: 2026-01-27
- **设计人**: Claude Code
- **评审人**: 待指定
- **来源需求**: REQ-007

## 背景和目标

### 业务背景
云平台系统需要实现多租户SaaS架构，支持：
- **系统集成商**（一级租户）管理下游客户
- **下游客户企业**（二级租户）使用物联网服务
- **平台超管**管理整个平台

### 核心目标
1. **数据隔离**：严格的租户数据隔离，确保跨租户数据安全
2. **权限控制**：细粒度的RBAC权限模型，支持三级权限架构
3. **可扩展性**：支持多级组织层级，灵活的功能模块管理
4. **易用性**：根据租户类型动态调整界面，降低用户学习成本
5. **可审计性**：完整的操作审计日志，满足安全和合规要求

### 关键挑战
- 三层租户架构（平台超管 → 集成商 → 下游客户）的数据隔离
- 双字段设计（tenant_id + managed_tenant_id）的查询优化
- 租户级RBAC权限模型的高效验证
- 功能模块与配额管理的灵活扩展

## 问题陈述

当前需要解决的核心问题：

1. **多租户数据隔离**
   - 如何实现集成商查看所有下游数据？
   - 如何确保下游客户只能查看自己的数据？
   - 如何实现跨租户严格隔离？

2. **灵活的权限管理**
   - 如何实现租户级的RBAC权限模型？
   - 如何支持三级权限架构（角色 → 功能 → 操作）？
   - 如何实现高效的权限验证？

3. **组织层级管理**
   - 如何支持多级组织层级？
   - 如何区分管理租户和父租户？
   - 如何支持租户类型切换？

4. **功能模块与配额**
   - 如何实现灵活的功能模块管理？
   - 如何支持集成商为下游分配配额？
   - 如何实现配额使用统计？

5. **审计日志**
   - 如何记录所有关键操作？
   - 如何支持快速扩展到新模块？
   - 如何实现字段级变更记录？

## 方案概述

本方案采用**三层租户架构 + 双字段数据隔离 + 租户级RBAC权限模型**，实现：

1. **三层租户架构**
   - 平台超管（Platform Super Admin）：根管控主体
   - 集成商（Integrator）：一级管控主体，可以创建和管理下游租户
   - 终端租户（Terminal）：二级业务主体，最终使用用户

2. **双字段数据隔离设计**
   - `tenant_id`：归属租户ID，标识数据所有权
   - `managed_tenant_id`：管理租户ID，标识管控集成商
   - 集成商查询：`WHERE managed_tenant_id = {integrator_id}`
   - 下游查询：`WHERE tenant_id = {current_tenant_id}`

3. **租户级RBAC权限模型**
   - Level 1: 系统角色（Role）
   - Level 2: 功能权限（Feature Permission）
   - Level 3: 操作权限（Action Permission）
   - 每个租户独立管理自己的角色和权限

4. **功能模块与配额管理**
   - 9个预设功能模块（设备管理、数据查看、告警管理等）
   - 集成商为下游分配配额
   - 配额使用统计和监控

5. **系统审计日志**
   - JSON格式的action_detail字段记录before/after/changes
   - 配置化日志记录（audit_log_config.yml）
   - 3步快速扩展到新模块

## 技术选型

| 技术领域 | 选型方案 | 理由 | 替代方案 | 对比分析 |
|---------|---------|------|---------|---------|
| **后端框架** | Golang + Gin | 高性能、高并发、开发效率高、生态成熟 | Node.js (Express/NestJS), Python (Django/FastAPI), Java (Spring Boot) | Golang性能是Node.js的10-40倍，内存占用更低，并发模型更优 |
| **数据库** | PostgreSQL 14+ | 支持JSONB、高级索引、性能优秀、ACID完整 | MySQL 8.0+, MongoDB | PostgreSQL的JSONB性能优于MySQL的JSON，查询能力更强 |
| **ORM** | GORM | 功能强大、API友好、支持Hook、关联查询完善 | Ent, sqlx | GORM生态更好，文档完善，开发效率高 |
| **缓存** | Redis 7.0+ | 高性能、支持多种数据结构、持久化 | Memcached | Redis功能更丰富，支持持久化，性能更优 |
| **认证** | JWT (golang-jwt/jwt) | 无状态、跨平台、性能好 | Session, OAuth 2.0 | JWT更适合RESTful API，无需服务端存储会话 |
| **API文档** | Swagger/OpenAPI 3.0 (swaggo) | 自动生成、标准化、易维护 | 手写文档、RAML | Swagger自动从代码生成，保持一致性 |
| **日志** | zap | 高性能、结构化日志 | logrus, logrus | zap性能比logrus快很多，适合高并发场景 |
| **配置管理** | Viper | 支持多种格式、动态重载、环境变量 | 手动配置、env | Viper功能强大，易于管理复杂配置 |
| **前端框架** | React 18 | 生态成熟、性能优秀、Hooks API | Vue 3, Angular | React生态最丰富，社区最活跃 |
| **状态管理** | MobX | 简单易用、响应式、与Scada前端保持一致 | Redux, Zustand | MobX学习曲线低，代码简洁，性能好 |
| **UI组件库** | Ant Design | 组件丰富、设计规范、中文文档完善 | Material-UI, Chakra UI | Ant Design更适合企业级应用，中文支持好 |
| **路由** | React Router v6 | 官方推荐、支持嵌套路由、懒加载 | Vue Router, React Router v5 | React Router v6性能更好，API更简洁 |
| **HTTP客户端** | Axios | 拦截器、取消请求、跨平台 | Fetch API, SuperAgent | Axios功能丰富，API友好，生态好 |
| **构建工具** | Vite | 快速热更新、原生ESM、开箱即用 | Webpack, Turbopack | Vite比Webpack快10-100倍，开发体验更好 |
| **测试框架** | Vitest + React Testing Library | 快速、API友好、与Vite集成 | Jest, Cypress | Vitest比Jest快很多，与Vite无缝集成 |

## 系统架构设计

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         Cloud Platform                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Frontend Layer                         │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │  │
│  │  │   Login  │  │ Dashboard│  │  Org Mgmt│  │ User Mgmt│  │  │
│  │  │   Page   │  │   Page   │  │   Page   │  │   Page   │  │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │  │
│  │                                                               │  │
│  │  React 18 + TypeScript + MobX + Ant Design                  │  │
│  │  - AuthStore: 认证状态管理                                   │  │
│  │  - PermissionStore: 权限状态管理                            │  │
│  │  - TenantStore: 租户状态管理                                │  │
│  │  - UIStore: UI状态管理                                      │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              ↓ HTTPS                             │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                     API Gateway Layer                      │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │          Gin Middleware Pipeline                      │ │  │
│  │  │  1. CORS Middleware                                    │ │  │
│  │  │  2. Request Logging Middleware                         │ │  │
│  │  │  3. Rate Limit Middleware                              │ │  │
│  │  │  4. JWT Auth Middleware                                │ │  │
│  │  │  5. Permission Check Middleware                        │ │  │
│  │  │  6. Tenant Isolation Middleware                        │ │  │
│  │  │  7. Audit Log Middleware                               │ │  │
│  │  │  8. Quota Check Middleware                             │ │  │
│  │  └──────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              ↓                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Business Logic Layer                   │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │  │
│  │  │ Auth Service│  │ Tenant      │  │ User & Role │       │  │
│  │  │             │  │ Service     │  │ Service     │       │  │
│  │  │ - Register  │  │ - Create    │  │ - CRUD      │       │  │
│  │  │ - Login     │  │ - Upgrade   │  │ - Assign    │       │  │
│  │  │ - Logout    │  │ - Downgrade │  │ - Validate  │       │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │  │
│  │  │ Permission  │  │ Quota       │  │ Audit Log   │       │  │
│  │  │ Service     │  │ Service     │  │ Service     │       │  │
│  │  │ - Check     │  │ - Allocate  │  │ - Record    │       │  │
│  │  │ - Validate  │  │ - Check     │  │ - Query     │       │  │
│  │  │ - Cache     │  │ - Statistics│  │ - Export    │       │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              ↓                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Data Access Layer                      │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │  │
│  │  │ Tenant      │  │ User & Role │  │ Permission  │       │  │
│  │  │ Repository  │  │ Repository  │  │ Repository  │       │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │  │
│  │  │ Quota       │  │ Audit Log   │  │ Feature     │       │  │
│  │  │ Repository  │  │ Repository  │  │ Repository  │       │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │  │
│  │                                                               │  │
│  │  GORM ORM Layer                                              │  │
│  │  - Auto Tenant Isolation (via Hooks)                        │  │
│  │  - Soft Delete Support                                      │  │
│  │  - Transaction Management                                  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              ↓                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Data Storage Layer                      │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │              PostgreSQL 14+                          │  │  │
│  │  │  - tenants (租户表)                                   │  │  │
│  │  │  - users (用户表)                                     │  │  │
│  │  │  - roles (角色表)                                     │  │  │
│  │  │  - feature_permissions (功能权限表)                   │  │  │
│  │  │  - action_permissions (操作权限表)                    │  │  │
│  │  │  - role_feature_permissions (角色功能权限关联表)      │  │  │
│  │  │  - feature_action_permissions (功能操作权限关联表)    │  │  │
│  │  │  - user_roles (用户角色关联表)                        │  │  │
│  │  │  - tenant_quota_usage (配额使用表)                    │  │  │
│  │  │  - tenant_features (功能开通表)                       │  │  │
│  │  │  - audit_logs (审计日志表)                            │  │  │
│  │  │  - verification_codes (验证码表)                      │  │  │
│  │  │  - login_logs (登录日志表)                            │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │              Redis 7.0+                              │  │  │
│  │  │  - User Sessions (JWT Token Blacklist)               │  │  │
│  │  │  - Permission Cache (user_permissions:{user_id})     │  │  │
│  │  │  - Quota Cache (quota_usage:{tenant_id}:{module})    │  │  │
│  │  │  - Verification Code (verify_code:{target})          │  │  │
│  │  │  - Rate Limiting (rate_limit:{ip}:{endpoint})        │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 三层租户架构设计

```
Platform Super Admin (平台超管)
    │
    ├─ 管理所有集成商
    ├─ 为集成商开通功能模块
    ├─ 分配全局配额
    └─ 查看所有审计日志
         │
         ↓
    Integrator (集成商)
    │
    ├─ managed_tenant_id = NULL
    ├─ 可以创建和管理下游租户
    ├─ 为下游分配配额
    ├─ 查看所有下游数据 (WHERE managed_tenant_id = {self})
    └─ 管理子组织和用户
         │
         ↓
    Terminal Tenant (下游客户)
    │
    ├─ managed_tenant_id = {集成商ID}
    ├─ 只能查看自己的数据 (WHERE tenant_id = {self})
    ├─ 管理内部用户和子组织
    └─ 使用已开通的功能模块
```

### 租户类型与层级关系

```
Integrator A (tenant_type=INTEGRATOR, managed_tenant_id=NULL, parent_tenant_id=NULL)
  │
  ├─ 下游客户B (tenant_type=TERMINAL, managed_tenant_id=A, parent_tenant_id=A)
  │   │
  │   └─ 子组织C (tenant_type=TERMINAL, managed_tenant_id=A, parent_tenant_id=B)
  │       │
  │       └─ 子组织D (tenant_type=TERMINAL, managed_tenant_id=A, parent_tenant_id=C)
  │
  └─ 下游客户E (tenant_type=TERMINAL, managed_tenant_id=A, parent_tenant_id=A)
      │
      └─ 子组织F (tenant_type=TERMINAL, managed_tenant_id=A, parent_tenant_id=E)
```

**关键规则**：
- **managed_tenant_id** 总是指向集成商（用于数据隔离）
- **parent_tenant_id** 指向直接上级（用于组织层级）
- 集成商可以通过 `managed_tenant_id` 查看所有下游数据
- 下游客户只能通过 `tenant_id` 查看自己的数据

## 数据库设计

### 核心表设计

详见：`03-design/database-design/cloud-table-design-specs.md`

**核心表列表**：
1. **tenants** - 租户（组织）表
2. **users** - 用户表
3. **roles** - 角色表
4. **feature_permissions** - 功能权限表
5. **action_permissions** - 操作权限表
6. **role_feature_permissions** - 角色功能权限关联表
7. **feature_action_permissions** - 功能操作权限关联表
8. **user_roles** - 用户角色关联表
9. **tenant_quota_usage** - 租户配额使用统计表
10. **tenant_features** - 租户功能开通记录表
11. **audit_logs** - 审计日志表
12. **verification_codes** - 验证码表
13. **login_logs** - 登录日志表

### 租户隔离字段规范

所有业务表（设备、用户、告警等）必须包含：

```sql
-- 归属租户ID（必填）
tenant_id BIGINT NOT NULL

-- 管理租户ID（可选）
managed_tenant_id BIGINT
```

**数据隔离规则**：
- **下游客户查询**：`WHERE tenant_id = {current_tenant_id}`
- **集成商查询**：`WHERE managed_tenant_id = {integrator_id}`

## 后端API设计

### API模块划分

#### 1. 认证模块 (Auth Module)

**基础路径**: `/api/v1/auth`

| 接口 | 方法 | 描述 | 认证 |
|------|------|------|------|
| `/register/new-company` | POST | 新企业注册 | 否 |
| `/register/join-company` | POST | 加入已有企业 | 否 |
| `/send-code` | POST | 发送验证码 | 否 |
| `/verify-code` | POST | 验证验证码 | 否 |
| `/login` | POST | 用户登录 | 否 |
| `/logout` | POST | 用户登出 | 是 |
| `/refresh-token` | POST | 刷新Token | 是 |
| `/current-user` | GET | 获取当前用户 | 是 |
| `/reset-password` | POST | 重置密码 | 否 |
| `/change-password` | PUT | 修改密码 | 是 |

#### 2. 组织管理模块 (Organization Module)

**基础路径**: `/api/v1/organizations`

| 接口 | 方法 | 描述 | 认证 | 权限 |
|------|------|------|------|------|
| `/` | POST | 创建组织 | 是 | ORGANIZATION_MANAGEMENT:CREATE |
| `/` | GET | 获取组织列表 | 是 | ORGANIZATION_MANAGEMENT:VIEW |
| `/:id` | GET | 获取组织详情 | 是 | ORGANIZATION_MANAGEMENT:VIEW |
| `/:id` | PUT | 更新组织 | 是 | ORGANIZATION_MANAGEMENT:EDIT |
| `/:id` | DELETE | 删除组织 | 是 | ORGANIZATION_MANAGEMENT:DELETE |
| `/:id/users` | GET | 获取组织用户 | 是 | ORGANIZATION_MANAGEMENT:VIEW |
| `/:id/tree` | GET | 获取组织树 | 是 | ORGANIZATION_MANAGEMENT:VIEW |
| `/:id/upgrade-to-integrator` | POST | 升级为集成商 | 是 | SYSTEM_CONFIG |
| `/:id/downgrade-to-terminal` | POST | 降级为下游客户 | 是 | SYSTEM_CONFIG |

#### 3. 用户管理模块 (User Module)

**基础路径**: `/api/v1/users`

| 接口 | 方法 | 描述 | 认证 | 权限 |
|------|------|------|------|------|
| `/` | POST | 创建用户 | 是 | USER_MANAGEMENT:CREATE |
| `/` | GET | 获取用户列表 | 是 | USER_MANAGEMENT:VIEW |
| `/:id` | GET | 获取用户详情 | 是 | USER_MANAGEMENT:VIEW |
| `/:id` | PUT | 更新用户 | 是 | USER_MANAGEMENT:EDIT |
| `/:id` | DELETE | 删除用户 | 是 | USER_MANAGEMENT:DELETE |
| `/:id/status` | PUT | 更新用户状态 | 是 | USER_MANAGEMENT:EDIT |
| `/:id/roles` | POST | 分配角色 | 是 | ROLE_MANAGEMENT:EDIT |
| `/:id/roles/:roleId` | DELETE | 移除角色 | 是 | ROLE_MANAGEMENT:EDIT |
| `/:id/roles` | GET | 获取用户角色 | 是 | USER_MANAGEMENT:VIEW |

#### 4. 角色管理模块 (Role Module)

**基础路径**: `/api/v1/roles`

| 接口 | 方法 | 描述 | 认证 | 权限 |
|------|------|------|------|------|
| `/` | POST | 创建角色 | 是 | ROLE_MANAGEMENT:CREATE |
| `/` | GET | 获取角色列表 | 是 | ROLE_MANAGEMENT:VIEW |
| `/:id` | GET | 获取角色详情 | 是 | ROLE_MANAGEMENT:VIEW |
| `/:id` | PUT | 更新角色 | 是 | ROLE_MANAGEMENT:EDIT |
| `/:id` | DELETE | 删除角色 | 是 | ROLE_MANAGEMENT:DELETE |
| `/:id/permissions` | POST | 配置权限 | 是 | ROLE_MANAGEMENT:EDIT |
| `/:id/permissions` | GET | 获取角色权限 | 是 | ROLE_MANAGEMENT:VIEW |
| `/:id/users` | GET | 获取拥有该角色的用户 | 是 | ROLE_MANAGEMENT:VIEW |

#### 5. 权限管理模块 (Permission Module)

**基础路径**: `/api/v1/permissions`

| 接口 | 方法 | 描述 | 认证 |
|------|------|------|------|
| `/features` | GET | 获取功能权限列表 | 是 |
| `/actions` | GET | 获取操作权限列表 | 是 |
| `/tree` | GET | 获取权限树 | 是 |
| `/user-permissions` | GET | 获取用户所有权限 | 是 |
| `/check` | POST | 检查权限 | 是 |

#### 6. 功能模块与配额管理模块 (Feature & Quota Module)

**基础路径**: `/api/v1/features`

| 接口 | 方法 | 描述 | 认证 | 权限 |
|------|------|------|------|------|
| `/modules` | GET | 获取所有功能模块 | 是 | - |
| `/tenant/:tenantId` | GET | 获取租户已开通功能 | 是 | - |
| `/tenant/:tenantId/activate` | POST | 为租户开通功能 | 是 | SYSTEM_CONFIG |
| `/tenant/:tenantId/deactivate` | POST | 停用租户功能 | 是 | SYSTEM_CONFIG |
| `/quota/:tenantId` | GET | 获取租户配额使用情况 | 是 | - |
| `/quota/:tenantId/allocate` | POST | 为租户分配配额 | 是 | SYSTEM_CONFIG |
| `/quota/:tenantId/statistics` | GET | 获取配额统计 | 是 | - |

#### 7. 审计日志模块 (Audit Log Module)

**基础路径**: `/api/v1/audit-logs`

| 接口 | 方法 | 描述 | 认证 | 权限 |
|------|------|------|------|------|
| `/` | POST | 手动记录日志 | 是 | - |
| `/` | GET | 查询日志列表 | 是 | - |
| `/:id` | GET | 获取日志详情 | 是 | - |
| `/export` | GET | 导出日志 | 是 | - |
| `/:id` | DELETE | 删除日志（仅平台超管） | 是 | SYSTEM_CONFIG |

### API响应格式

#### 成功响应
```json
{
  "code": 200,
  "message": "success",
  "data": {
    // 业务数据
  },
  "timestamp": "2026-01-27T10:30:00Z"
}
```

#### 错误响应
```json
{
  "code": 400,
  "message": "Validation failed",
  "errors": [
    {
      "field": "email",
      "message": "Email is required"
    }
  ],
  "timestamp": "2026-01-27T10:30:00Z"
}
```

#### 分页响应
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 100,
      "totalPages": 5
    }
  },
  "timestamp": "2026-01-27T10:30:00Z"
}
```

## 前端架构设计

### 技术栈

- **框架**: React 18 + TypeScript
- **状态管理**: MobX (与Scada前端保持一致)
- **UI组件库**: Ant Design
- **路由**: React Router v6
- **HTTP客户端**: Axios
- **构建工具**: Vite
- **测试**: Vitest + React Testing Library

### MobX状态管理架构

#### AuthStore (认证状态管理)

```typescript
class AuthStore {
  // Observable State
  currentUser: User | null = null
  currentTenant: Tenant | null = null
  isAuthenticated = false
  token = localStorage.getItem('token')

  // Computed
  get isIntegrator(): boolean {
    return this.currentTenant?.tenantType === 'INTEGRATOR'
  }

  get isTerminal(): boolean {
    return this.currentTenant?.tenantType === 'TERMINAL'
  }

  // Actions
  async login(email: string, password: string) {
    // API调用
    // 更新状态
  }

  async logout() {
    // 清除状态
    // 清除token
  }

  async refreshPermissions() {
    // 重新加载权限
  }
}
```

#### PermissionStore (权限状态管理)

```typescript
class PermissionStore {
  // Observable State
  featurePermissions: Map<string, FeaturePermission> = new Map()
  actionPermissions: Map<string, ActionPermission> = new Map()

  // Computed
  get hasFeaturePermission(): (featureCode: string) => boolean {
    return (featureCode: string) => {
      return this.featurePermissions.has(featureCode)
    }
  }

  get hasActionPermission(): (featureCode: string, actionCode: string) => boolean {
    return (featureCode: string, actionCode: string) => {
      // 检查权限
    }
  }

  // Actions
  async loadPermissions(userId: string) {
    // 加载用户权限
  }

  checkPermission(featureCode: string, actionCode: string): boolean {
    // 检查权限
  }
}
```

#### TenantStore (租户状态管理)

```typescript
class TenantStore {
  // Observable State
  currentTenant: Tenant | null = null
  managedTenants: Tenant[] = []
  tenantFeatures: TenantFeature[] = []

  // Computed
  get isIntegrator(): boolean {
    return this.currentTenant?.tenantType === 'INTEGRATOR'
  }

  get hasFeature(): (moduleCode: string) => boolean {
    return (moduleCode: string) => {
      return this.tenantFeatures.some(
        f => f.moduleCode === moduleCode && f.isActive
      )
    }
  }

  // Actions
  async switchTenant(tenantId: string) {
    // 切换租户（模拟登录）
  }

  async loadManagedTenants() {
    // 加载管理的下游租户
  }
}
```

#### UIStore (UI状态管理)

```typescript
class UIStore {
  // Observable State
  menuConfig: MenuItem[] = []
  visibleFields: Map<string, string[]> = new Map()
  activeFilters: Map<string, any> = new Map()

  // Actions
  updateMenuConfig(config: MenuItem[]) {
    this.menuConfig = config
  }

  toggleFieldVisibility(page: string, fields: string[]) {
    this.visibleFields.set(page, fields)
  }
}
```

### 动态界面设计

#### 动态菜单系统

```typescript
// 根据用户角色和权限动态生成菜单
const generateMenuConfig = (user: User, permissions: Permission[]): MenuItem[] => {
  const menuItems: MenuItem[] = []

  // 系统设置（仅系统管理员）
  if (hasPermission(permissions, 'SYSTEM_CONFIG')) {
    menuItems.push({
      key: 'system-config',
      label: '系统设置',
      icon: <SettingOutlined />,
      path: '/system/config'
    })
  }

  // 子组织管理（仅集成商）
  if (user.currentTenant.tenantType === 'INTEGRATOR' &&
      hasPermission(permissions, 'ORGANIZATION_MANAGEMENT')) {
    menuItems.push({
      key: 'org-management',
      label: '子组织管理',
      icon: <ApartmentOutlined />,
      path: '/organizations'
    })
  }

  // 账号管理（所有租户）
  if (hasPermission(permissions, 'USER_MANAGEMENT')) {
    menuItems.push({
      key: 'user-management',
      label: '账号管理',
      icon: <UserOutlined />,
      path: '/users'
    })
  }

  return menuItems
}
```

#### 动态表单系统

```typescript
// 根据租户类型动态显示表单字段
const DeviceForm: React.FC = () => {
  const { currentTenant } = useTenantStore()
  const isIntegrator = currentTenant?.tenantType === 'INTEGRATOR'

  return (
    <Form>
      {/* 基础字段（所有租户） */}
      <Form.Item name="deviceName" label="设备名称" required>
        <Input />
      </Form.Item>

      <Form.Item name="deviceType" label="设备类型" required>
        <Select>
          <Option value="sensor">传感器</Option>
          <Option value="gateway">网关</Option>
        </Select>
      </Form.Item>

      {/* 归属组织字段（仅集成商） */}
      {isIntegrator && (
        <Form.Item name="tenantId" label="归属组织" required>
          <Select placeholder="请选择下游客户">
            {managedTenants.map(tenant => (
              <Option key={tenant.id} value={tenant.id}>
                {tenant.name}
              </Option>
            ))}
          </Select>
        </Form.Item>
      )}

      <Form.Item>
        <Button type="primary" htmlType="submit">保存</Button>
      </Form.Item>
    </Form>
  )
}
```

### 前端路由设计

```typescript
// 路由配置（与权限集成）
const routes = [
  {
    path: '/login',
    component: LoginPage,
    meta: { requiresAuth: false }
  },
  {
    path: '/',
    component: Layout,
    meta: { requiresAuth: true },
    children: [
      {
        path: 'dashboard',
        component: DashboardPage,
        meta: { permission: 'DATA_VIEW:VIEW' }
      },
      {
        path: 'organizations',
        component: OrganizationListPage,
        meta: {
          permission: 'ORGANIZATION_MANAGEMENT:VIEW',
          tenantType: 'INTEGRATOR'
        }
      },
      {
        path: 'users',
        component: UserListPage,
        meta: { permission: 'USER_MANAGEMENT:VIEW' }
      },
      {
        path: 'roles',
        component: RoleListPage,
        meta: { permission: 'ROLE_MANAGEMENT:VIEW' }
      },
      {
        path: 'devices',
        component: DeviceListPage,
        meta: { permission: 'DEVICE_MANAGEMENT:VIEW' }
      },
      {
        path: 'audit-logs',
        component: AuditLogListPage,
        meta: { permission: 'SYSTEM_CONFIG' }
      }
    ]
  }
]
```

## 安全设计

### 认证流程

```
┌──────────┐                  ┌──────────┐                  ┌──────────┐
│  Client  │                  │   API    │                  │   DB     │
└────┬─────┘                  └────┬─────┘                  └────┬─────┘
     │                             │                             │
     │  1. POST /login             │                             │
     │  {email, password}          │                             │
     │────────────────────────────>│                             │
     │                             │  2. 查询用户                 │
     │                             │────────────────────────────>│
     │                             │  3. 返回用户信息             │
     │                             │<────────────────────────────│
     │                             │                             │
     │                             │  4. 验证密码                 │
     │                             │  5. 生成JWT Token            │
     │                             │  6. 缓存权限到Redis          │
     │                             │                             │
     │  7. 返回Token               │                             │
     │  {token, user}              │                             │
     │<────────────────────────────│                             │
     │                             │                             │
     │  8. 保存Token到localStorage │                             │
     │                             │                             │
     │  9. 后续请求携带Token       │                             │
     │  Authorization: Bearer {token}                            │
     │────────────────────────────>│                             │
     │                             │  10. 验证Token               │
     │                             │  11. 检查权限                │
     │                             │  12. 租户隔离                │
     │                             │  13. 记录审计日志            │
     │                             │                             │
     │  14. 返回数据               │                             │
     │<────────────────────────────│                             │
```

### JWT Token结构

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "user_id": "12345",
    "email": "user@example.com",
    "tenant_id": "1001",
    "tenant_type": "INTEGRATOR",
    "role_ids": ["1", "2"],
    "exp": 1706379400,
    "iat": 1706293000
  }
}
```

### 权限验证流程

```
┌──────────┐                  ┌──────────┐                  ┌──────────┐
│  Client  │                  │   API    │                  │  Redis   │
└────┬─────┘                  └────┬─────┘                  └────┬─────┘
     │                             │                             │
     │  1. 请求API (携带Token)     │                             │
     │────────────────────────────>│                             │
     │                             │                             │
     │                             │  2. 提取user_id              │
     │                             │  3. 查询权限缓存             │
     │                             │────────────────────────────>│
     │                             │                             │
     │                             │  4. 返回权限数据             │
     │                             │<────────────────────────────│
     │                             │                             │
     │                             │  5. 验证权限                 │
     │                             │  if (hasPermission) {       │
     │                             │    next()                   │
     │                             │  } else {                   │
     │                             │    return 403               │
     │                             │  }                          │
     │                             │                             │
     │  6. 返回数据/403            │                             │
     │<────────────────────────────│                             │
```

### 数据隔离设计

#### 中间件实现

```go
// TenantIsolationMiddleware 租户隔离中间件
func TenantIsolationMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 1. 从JWT中提取租户信息
        userID := c.GetString("user_id")
        tenantID := c.GetString("tenant_id")
        tenantType := c.GetString("tenant_type")

        // 2. 设置到上下文
        c.Set("current_tenant_id", tenantID)
        c.Set("current_tenant_type", tenantType)

        // 3. GORM自动添加租户过滤条件
        if tenantType == "INTEGRATOR" {
            // 集成商：查看所有managed_tenant_id指向自己的数据
            db.Scopes(func(db *gorm.DB) *gorm.DB {
                return db.Where("managed_tenant_id = ?", tenantID)
            })
        } else {
            // 下游客户：仅查看tenant_id为自己的数据
            db.Scopes(func(db *gorm.DB) *gorm.DB {
                return db.Where("tenant_id = ?", tenantID)
            })
        }

        c.Next()
    }
}
```

### 安全措施

1. **密码安全**
   - 使用 bcrypt 加密（cost=10）
   - 密码强度验证（8位以上，包含大小写字母、数字）
   - 限制密码重试次数（5次/15分钟）

2. **Token安全**
   - JWT Token有效期：2小时
   - Refresh Token有效期：7天
   - Token黑名单（Redis存储）

3. **API安全**
   - HTTPS强制加密
   - CORS限制
   - 请求签名验证
   - SQL注入防护（GORM参数化查询）
   - XSS防护（前端输入转义）

4. **数据安全**
   - 敏感字段加密存储
   - 审计日志记录所有敏感操作
   - 定期安全审计

## 性能考虑

### 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| API响应时间 (P95) | < 200ms | 95%的请求在200ms内完成 |
| API响应时间 (P99) | < 500ms | 99%的请求在500ms内完成 |
| 登录响应时间 | < 500ms | 包含权限加载 |
| 权限验证时间 | < 50ms | 使用Redis缓存 |
| 数据库查询时间 | < 100ms | 单次查询 |
| 并发用户数 | 1000+ | 同时在线用户 |
| 数据库连接池 | 50-100 | 根据负载调整 |

### 性能优化策略

1. **数据库优化**
   - 索引优化（租户隔离字段、常用查询字段）
   - 查询优化（避免N+1查询）
   - 读写分离（主从复制）
   - 分区表（审计日志按月分区）

2. **缓存优化**
   - Redis缓存用户权限（TTL=1小时）
   - Redis缓存配额使用情况（TTL=5分钟）
   - Redis缓存租户功能开通情况（TTL=30分钟）
   - 本地缓存热点数据（如功能权限定义）

3. **应用优化**
   - 连接池管理（数据库、Redis）
   - 并发控制（Goroutine池）
   - 异步处理（审计日志、邮件发送）
   - 批量操作（减少数据库往返）

4. **前端优化**
   - 代码分割（React.lazy）
   - 组件懒加载
   - 虚拟列表（大数据渲染）
   - 防抖/节流（搜索、滚动事件）

## 部署架构设计

### 生产环境架构

```
                        ┌─────────────────┐
                        │   DNS (CloudFlare)   │
                        └────────┬────────┘
                                 │
                        ┌────────▼────────┐
                        │  Load Balancer  │
                        │   (Nginx/HAProxy) │
                        └────────┬────────┘
                                 │
            ┌────────────────────┼────────────────────┐
            │                    │                    │
    ┌───────▼───────┐    ┌──────▼───────┐    ┌──────▼───────┐
    │  API Server 1 │    │  API Server 2 │    │  API Server 3 │
    │  (Gin + Golang) │    │  (Gin + Golang) │    │  (Gin + Golang) │
    └───────┬───────┘    └──────┬───────┘    └──────┬───────┘
            │                    │                    │
            └────────────────────┼────────────────────┘
                                 │
            ┌────────────────────┼────────────────────┐
            │                    │                    │
    ┌───────▼───────┐    ┌──────▼───────┐    ┌──────▼───────┐
    │ PostgreSQL   │    │   Redis      │    │  Object Store │
    │ (Primary)    │◄──►│   (Cluster)  │    │   (S3/MinIO)  │
    └───────┬───────┘    └──────────────┘    └───────────────┘
            │
    ┌───────▼───────┐
    │ PostgreSQL   │
    │  (Replica)   │
    └──────────────┘
```

### Docker容器化部署

```yaml
version: '3.8'

services:
  # API服务
  api:
    image: cloud-platform-api:latest
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgres://user:pass@postgres:5432/cloud_db
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - postgres
      - redis
    deploy:
      replicas: 3

  # PostgreSQL
  postgres:
    image: postgres:14-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=cloud_db
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}

  # Redis
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

volumes:
  postgres_data:
  redis_data:
```

## 测试策略

### 单元测试

**目标覆盖率**: > 80%

**测试工具**: testify / ginkgo

**测试范围**:
- Service层业务逻辑
- Repository层数据访问
- 中间件逻辑
- 工具函数

**示例**:
```go
func TestTenantService_CreateTenant(t *testing.T) {
    // Setup
    service := NewTenantService(mockRepo)

    // Test
    tenant, err := service.CreateTenant(&CreateTenantRequest{
        Name:       "测试企业",
        TenantType: "TERMINAL",
    })

    // Assert
    assert.NoError(t, err)
    assert.NotNil(t, tenant)
    assert.Equal(t, "测试企业", tenant.Name)
}
```

### 集成测试

**测试工具**: httpexpect / testcontainers

**测试范围**:
- API接口测试
- 数据库集成
- Redis集成
- 中间件集成

**示例**:
```go
func TestAPI_CreateTenant(t *testing.T) {
    // Setup test server
    server := setupTestServer()
    defer server.Close()

    // Test
    expect := httpexpect.New(t, server.URL)
    obj := expect.POST("/api/v1/organizations").
        WithJSON(map[string]interface{}{
            "name":        "测试企业",
            "tenant_type": "TERMINAL",
        }).
        Expect().
        Status(200).
        JSON().Object()

    // Assert
    obj.Value("code").Equal(200)
    obj.Value("data").Object().Value("name").Equal("测试企业")
}
```

### 性能测试

**测试工具**: k6 / Vegeta

**测试场景**:
- 登录接口：1000并发
- 查询接口：5000并发
- 写入接口：500并发

**测试脚本**:
```javascript
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  stages: [
    { duration: '1m', target: 1000 },
    { duration: '3m', target: 1000 },
    { duration: '1m', target: 0 },
  ],
};

export default function() {
  let res = http.post('http://api.example.com/api/v1/auth/login', {
    email: 'test@example.com',
    password: 'password',
  });

  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });
}
```

## 风险和挑战

| 风险 | 影响 | 概率 | 缓解措施 | 责任人 |
|------|------|------|---------|--------|
| 多租户数据隔离不严格 | 高 | 中 | 严格测试、代码审查、自动化验证 | 后端Lead |
| 权限验证性能问题 | 高 | 中 | Redis缓存、异步加载、索引优化 | 后端Lead |
| 租户层级管理复杂度 | 中 | 高 | 限制层级深度（最多3级）、文档完善 | 后端Lead |
| 审计日志数据量爆炸 | 中 | 高 | 分区表、定期归档、异步写入 | 后端Lead |
| 配额管理并发冲突 | 中 | 中 | 乐观锁、分布式锁、事务隔离 | 后端Lead |
| 前端权限判断不一致 | 高 | 中 | 前后端双重验证、权限配置化 | 前端Lead |
| 企业序列号生成冲突 | 高 | 低 | 数据库唯一约束、重试机制 | 后端Lead |

## 实施计划

### 阶段1: 基础架构搭建（2周）
- [ ] 搭建项目脚手架（前后端）
- [ ] 配置开发环境（Docker Compose）
- [ ] 设计数据库表结构
- [ ] 实现基础中间件（认证、日志、错误处理）
- [ ] 搭建CI/CD流程

### 阶段2: 核心功能开发（4周）
- [ ] 实现用户注册与登录（FE-007-02）
- [ ] 实现多租户组织管理（FE-007-01）
- [ ] 实现RBAC权限模型（FE-007-03）
- [ ] 实现租户数据隔离（FE-007-04）
- [ ] 实现租户角色切换（FE-007-05）

### 阶段3: 高级功能开发（3周）
- [ ] 实现前端动态界面（FE-007-06）
- [ ] 实现后端API服务（FE-007-07）
- [ ] 实现功能模块与配额管理（FE-007-08）
- [ ] 实现系统审计日志（FE-007-09）

### 阶段4: 测试与优化（2周）
- [ ] 单元测试（覆盖率>80%）
- [ ] 集成测试
- [ ] 性能测试和优化
- [ ] 安全测试
- [ ] Bug修复

### 阶段5: 部署与文档（1周）
- [ ] 生产环境部署
- [ ] API文档生成（Swagger）
- [ ] 用户手册编写
- [ ] 运维文档编写

**总计**: 12周（约3个月）

## 架构决策记录 (ADR)

### 决策1: 采用Golang而非Node.js作为后端语言

- **状态**: 已接受
- **日期**: 2026-01-27
- **上下文**: 需要选择后端技术栈，候选方案包括Node.js、Python、Java、Golang
- **决策**: 采用Golang + Gin框架
- **理由**:
  - 性能优势：Golang性能是Node.js的10-40倍
  - 并发模型：Goroutine更轻量，支持更高并发
  - 内存占用：Golang内存占用更低
  - 开发效率：语法简洁，编译快速
  - 生态成熟：Gin、GORM等框架成熟
- **后果**:
  - 正面：性能更好，资源利用率更高
  - 正面：并发处理能力强
  - 负面：学习曲线（团队可能不熟悉）
  - 缓解措施：提供Golang培训，代码审查

### 决策2: 采用PostgreSQL而非MySQL

- **状态**: 已接受
- **日期**: 2026-01-27
- **上下文**: 需要选择关系型数据库，候选方案包括MySQL、PostgreSQL
- **决策**: 采用PostgreSQL 14+
- **理由**:
  - JSONB支持：PostgreSQL的JSONB性能优于MySQL的JSON
  - 高级索引：支持GIN索引、表达式索引等
  - 复杂查询：支持窗口函数、CTE等
  - 数据完整性：ACID支持更完善
- **后果**:
  - 正面：JSON查询性能更好
  - 正面：支持更复杂的查询场景
  - 负面：运维复杂度略高
  - 缓解措施：使用云数据库服务（如RDS）

### 决策3: 采用MobX而非Redux作为状态管理

- **状态**: 已接受
- **日期**: 2026-01-27
- **上下文**: 需要选择前端状态管理方案，候选方案包括Redux、MobX、Zustand
- **决策**: 采用MobX
- **理由**:
  - 学习曲线：MobX比Redux简单很多
  - 代码量：MobX代码更简洁
  - 性能：MobX自动追踪依赖，性能更好
  - 一致性：与Scada前端保持一致
- **后果**:
  - 正面：开发效率更高
  - 正面：代码更易维护
  - 负面：调试工具相对较少
  - 缓解措施：使用MobX DevTools

### 决策4: 采用双字段设计（tenant_id + managed_tenant_id）

- **状态**: 已接受
- **日期**: 2026-01-27
- **上下文**: 需要实现多租户数据隔离，候选方案包括单字段、双字段、行级安全
- **决策**: 采用双字段设计
- **理由**:
  - 灵活性：支持集成商查看所有下游数据
  - 查询效率：简单WHERE条件，性能好
  - 易理解：业务逻辑清晰
- **后果**:
  - 正面：支持复杂的租户层级
  - 正面：查询性能好
  - 负面：需要维护两个字段
  - 缓解措施：GORM Hook自动填充

### 决策5: 采用租户级RBAC而非全局RBAC

- **状态**: 已接受
- **日期**: 2026-01-27
- **上下文**: 需要设计权限模型，候选方案包括全局RBAC、租户级RBAC
- **决策**: 采用租户级RBAC
- **理由**:
  - 隔离性：每个租户独立管理角色和权限
  - 灵活性：支持租户自定义角色
  - 安全性：跨租户权限完全隔离
- **后果**:
  - 正面：租户自主管理权限
  - 正面：权限隔离更安全
  - 负面：权限验证稍复杂
  - 缓解措施：Redis缓存权限数据

### 决策6: 采用JSON格式存储审计日志action_detail

- **状态**: 已接受
- **日期**: 2026-01-27
- **上下文**: 需要记录操作详情，候选方案包括JSON格式、独立的变更表
- **决策**: 采用JSON格式存储在action_detail字段
- **理由**:
  - 灵活性：支持任意字段变更记录
  - 扩展性：新增字段无需修改表结构
  - 查询方便：PostgreSQL JSONB支持高效查询
- **后果**:
  - 正面：扩展性强
  - 正面：支持快速添加新模块
  - 负面：JSON解析稍慢
  - 缓解措施：使用JSONB而非JSON，性能更好

### 决策7: 采用8位企业序列号

- **状态**: 已接受
- **日期**: 2026-01-27
- **上下文**: 需要设计企业序列号格式，候选方案包括UUID、自增ID、随机字符串
- **决策**: 采用8位序列号（4位随机+4位自增）
- **理由**:
  - 易用性：8位长度便于用户输入
  - 唯一性：随机+自增保证唯一
  - 安全性：不易被猜测
- **后果**:
  - 正面：用户体验好
  - 正面：生成效率高
  - 负面：可能会被枚举
  - 缓解措施：限制验证码尝试次数

## 影响分析

### 影响范围

**模块**:
- 认证授权模块
- 组织管理模块
- 用户管理模块
- 权限管理模块
- 配额管理模块
- 审计日志模块

**系统**:
- 云平台（Cloud）
- 所有需要认证的业务系统

**功能**: FE-007-01 ~ FE-007-09

### 兼容性

**向后兼容性**:
- ✅ 新系统，无兼容性问题
- ✅ API版本化（/api/v1/），支持未来升级

### 迁移策略

**数据迁移**:
- 无需迁移（新系统）

**系统迁移**:
- 灰度发布：先切换10%用户，观察1周后全量切换
- 回滚方案：保留旧系统1个月，确保可以快速回滚

## 变更历史

| 日期 | 版本 | 变更内容 | 变更人 | 评审状态 |
|------|------|---------|--------|---------|
| 2026-01-27 | 1.0 | 初始创建，包含完整技术方案设计 | Claude Code | 待评审 |

---

## 附录

### 相关文档

- **需求文档**: `.claude-workflow/01-requirements/raw-requirements/REQ-007.md`
- **功能分解**: `.claude-workflow/01-requirements/functional-requirements/FE-007-01.md ~ FE-007-09.md`
- **数据库设计规范**: `.claude-workflow/03-design/database-design/cloud-table-design-specs.md`
- **需求映射表**: `.claude-workflow/01-requirements/requirement-mapping.md`

### 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 租户 | Tenant | 租户是系统中的企业组织，分为集成商和终端租户 |
| 集成商 | Integrator | 一级管控主体，可以创建和管理下游租户 |
| 终端租户 | Terminal | 二级业务主体，最终使用用户 |
| 管理租户ID | managed_tenant_id | 标识租户由哪个集成商管理 |
| 父租户ID | parent_tenant_id | 标识直接上级组织 |
| RBAC | Role-Based Access Control | 基于角色的访问控制 |
| 企业序列号 | Serial Number | 8位唯一标识，格式：XXXX XXXX |
| 功能模块 | Feature Module | 系统的功能单元，如设备管理、数据查看等 |
| 配额 | Quota | 租户可使用的资源限制 |
