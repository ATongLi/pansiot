# SOL-002: Scada工程管理功能技术方案

## 技术方案信息

**方案ID**: SOL-002
**方案标题**: Scada工程管理功能技术方案
**关联需求**: REQ-002, FE-002, US-002
**创建日期**: 2026-01-21
**目标平台**: Scada (前端 + 后端)
**状态**: ⏳ 待评审

## 方案概述

本方案描述Scada工程管理功能的完整技术实现，包括前端UI、后端API、数据存储、安全策略等。

### 技术栈

**前端**:
- React 18.3.1 + TypeScript
- MobX 6.12.0 (状态管理)
- Vite 5.4.2 (构建工具)
- Electron (文件系统访问)
- react-window (虚拟滚动)
- bcrypt-js (前端密码哈希)

**后端**:
- Golang 1.21+
- Fiber v2 (Web框架)
- GORM (ORM)
- SQLite (本地数据库)
- AES-256-GCM (加密)
- HMAC-SHA256 (签名)

**通信**:
- HTTP/JSON API
- Electron IPC (跨进程通信)

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     Scada Desktop App                        │
├─────────────────────────────────────────────────────────────┤
│  Frontend (React + MobX)                                    │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  UI Layer                                            │  │
│  │  - NewProjectDialog (新建工程对话框)                  │  │
│  │  - PasswordDialog (密码对话框)                        │  │
│  │  - RecentProjectsList (最近工程列表)                  │  │
│  │  - CategoryFilter (分类筛选器)                        │  │
│  │  - SearchBox (搜索框)                                │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  State Layer (MobX Stores)                           │  │
│  │  - projectStore (工程状态管理)                        │  │
│  │  - uiStore (UI状态管理)                              │  │
│  │  - recentProjectsStore (最近工程状态)                 │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  API Layer                                           │  │
│  │  - projectApi.ts (工程API客户端)                     │  │
│  │  - electronApi.ts (Electron IPC封装)                │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↕ HTTP/IPC
┌─────────────────────────────────────────────────────────────┐
│  Backend (Golang + Fiber)                                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  API Layer                                           │  │
│  │  - POST /api/projects/create                         │  │
│  │  - POST /api/projects/open                           │  │
│  │  - POST /api/projects/save                           │  │
│  │  - POST /api/projects/validate-password              │  │
│  │  - GET  /api/projects/recent                         │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Service Layer                                       │  │
│  │  - ProjectService (工程业务逻辑)                      │  │
│  │  - EncryptionService (加密服务)                       │  │
│  │  - FileService (文件操作服务)                        │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Data Layer                                          │  │
│  │  - SQLite (最近工程数据库)                           │  │
│  │  - FileSystem (.pant工程文件)                        │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 数据存储架构

### 存储隔离设计原则

**核心原则**: PanTool软件数据库与工程文件完全隔离，各自独立存储和管理。

```
┌─────────────────────────────────────────────────────────────┐
│                    PanTool Desktop App                        │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ PanTool软件数据库 (SQLite)                            │   │
│  │ 存储位置: ~/.pansiot/pantool.db                       │   │
│  │ 用途: 管理PanTool软件自身的配置和状态                   │   │
│  │                                                         │   │
│  │ 数据表:                                                │   │
│  │  1. app_config (应用配置)                              │   │
│  │     - 软件版本                                         │   │
│  │     - 窗口位置和大小                                   │   │
│  │     - 主题设置                                         │   │
│  │     - 语言设置                                         │   │
│  │                                                         │   │
│  │  2. user_preferences (用户偏好)                        │   │
│  │     - 最近使用的分类                                   │   │
│  │     - 默认硬件平台                                     │   │
│  │     - 默认保存位置                                     │   │
│  │     - 界面布局设置                                     │   │
│  │                                                         │   │
│  │  3. recent_projects (最近工程列表)                     │   │
│  │     - project_id (TEXT, 主键)                          │   │
│  │     - name (TEXT)                                      │   │
│  │     - category (TEXT)                                  │   │
│  │     - file_path (TEXT)                                │   │
│  │     - last_opened (DATETIME)                           │   │
│  │     - is_encrypted (BOOLEAN)                           │   │
│  │     - created_at (DATETIME)                            │   │
│  │                                                         │   │
│  │  4. custom_categories (自定义分类)                      │   │
│  │     - category_id (TEXT, 主键)                         │   │
│  │     - name (TEXT)                                      │   │
│  │     - color (TEXT)                                     │   │
│  │     - created_at (DATETIME)                             │   │
│  │                                                         │   │
│  │  5. audit_logs (审计日志)                               │   │
│  │     - id (INTEGER, 主键, 自增)                          │   │
│  │     - timestamp (DATETIME)                              │   │
│  │     - operator (TEXT)                                   │   │
│  │     - operation (TEXT)                                  │   │
│  │     - target_id (TEXT)                                 │   │
│  │     - details (JSON)                                    │   │
│  │     - result (TEXT)                                    │   │
│  │                                                         │   │
│  │  6. kek_versions (KEK版本管理)                          │   │
│  │     - version_id (TEXT, 主键)                           │   │
│  │     - version (TEXT)                                   │   │
│  │     - created_at (DATETIME)                             │   │
│  │     - status (TEXT) - active/rotated/expired            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 工程文件存储 (用户文件系统)                            │   │
│  │ 存储: 用户自定义位置                                   │   │
│  │ 格式: .pant文件                                       │   │
│  │ 用途: 存储工程实际内容                                 │   │
│  │                                                         │   │
│  │ 工程文件1: C:\Projects\factory.pant                      │   │
│  │ 工程文件2: D:\Work\production-line.pant                  │   │
│  │ 工程文件3: /home/user/data/hmi-project.pant              │   │
│  │ ... (用户可自由选择存储位置)                           │   │
│  │                                                         │   │
│  │ 每个工程文件包含:                                     │   │
│  │  - version (文件格式版本)                              │   │
│  │  - projectId (工程唯一ID)                              │   │
│  │  - metadata (工程元数据)                               │   │
│  │  - security (加密配置)                                 │   │
│  │  - canvas (画布配置)                                   │   │
│  │  - components (组件列表)                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 存储隔离的好处

1. **数据独立性**
   - PanTool数据库损坏不影响工程文件
   - 工程文件损坏不影响PanTool软件运行
   - 用户可以轻松备份工程文件（直接复制.pant文件）

2. **便于管理**
   - 工程文件可以单独分享、传输
   - 用户可以自由组织工程文件目录结构
   - 便于版本控制（工程文件可以加入Git）

3. **安全性**
   - 敏感信息分散存储
   - PanTool数据库不包含工程内容，降低泄露风险
   - 加密工程文件独立保护

4. **性能优化**
   - PanTool数据库轻量，启动快速
   - 工程文件按需加载，不占用软件内存
   - 最近工程列表查询快速（SQLite索引）

### 数据交互流程

```
用户操作流程:

1. 创建新工程
   用户填写表单 → ProjectService创建工程对象 →
   工程内容保存到文件系统(用户指定路径)/>
   工程元数据保存到PanTool数据库(recent_projects表)

2. 打开工程
   用户选择工程文件 → ProjectService从文件系统读取.pant文件 →
   解密和验证工程内容 →>
   更新PanTool数据库(recent_projects表的last_opened时间)

3. 最近工程列表
   前端请求 → Query PanTool数据库(recent_projects表) →
   返回最近50个工程元数据 →>
   用户点击打开某个工程 → 从文件系统读取对应的.pant文件

4. 删除工程
   用户删除 → 从PanTool数据库删除记录 →
   提示用户是否删除工程文件 →>
   如果用户确认 → 删除文件系统中的.pant文件
```

### 数据库详细设计

#### PanTool数据库表结构

```sql
-- 1. 应用配置表
CREATE TABLE app_config (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 初始化数据
INSERT INTO app_config (key, value) VALUES
    ('version', '1.0.0'),
    ('theme', 'light'),
    ('language', 'zh-CN');

-- 2. 用户偏好表
CREATE TABLE user_preferences (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 3. 最近工程表
CREATE TABLE recent_projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    category TEXT,
    file_path TEXT NOT NULL,
    last_opened DATETIME NOT NULL,
    is_encrypted BOOLEAN DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_last_opened ON recent_projects(last_opened DESC);
CREATE INDEX idx_category ON recent_projects(category);

-- 4. 自定义分类表
CREATE TABLE custom_categories (
    category_id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    color TEXT DEFAULT '#2196F3',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 5. 审计日志表
CREATE TABLE audit_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp DATETIME NOT NULL,
    operator TEXT NOT NULL,
    operation TEXT NOT NULL,
    target_id TEXT,
    details TEXT,
    result TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_timestamp ON audit_logs(timestamp DESC);
CREATE INDEX idx_operator ON audit_logs(operator);

-- 6. KEK版本管理表
CREATE TABLE kek_versions (
    version_id TEXT PRIMARY KEY,
    version TEXT NOT NULL,
    created_at DATETIME NOT NULL,
    rotated_at DATETIME,
    status TEXT NOT NULL DEFAULT 'active'
);
```

### 工程文件与数据库的关联

**关联方式**: 通过`project_id`和`file_path`

- PanTool数据库存储工程元数据（轻量级信息）
- 工程文件存储完整内容（重量级数据）
- 通过`file_path`字段建立关联

**查询示例**:
```sql
-- 查询最近工程列表（轻量级）
SELECT project_id, name, category, file_path, last_opened, is_encrypted
FROM recent_projects
ORDER BY last_opened DESC
LIMIT 50;

-- 根据project_id查询文件路径（用于打开工程）
SELECT file_path
FROM recent_projects
WHERE project_id = '550e8400-e29b-41d4-a716-446655440000';
```

### 数据备份策略

**PanTool数据库备份**:
- 自动备份：每周备份一次到 `~/.pansiot/backups/pantool.db.YYYYMMDD`
- 手动备份：用户可通过设置菜单触发备份
- 云端同步：未来支持同步用户配置到云端

**工程文件备份**:
- 用户手动备份：直接复制.pant文件
- 自动备份：未来可选功能，定期备份到指定目录
- 云端同步：未来支持上传工程文件到云端

### 数据清理策略

**PanTool数据库**:
- 最近工程：自动清理超过90天的记录
- 审计日志：保留最近1年，超过1年的归档
- 自定义分类：永久保留，除非用户手动删除

**工程文件**:
- 完全由用户控制，PanTool不自动删除
- 仅在用户明确授权时删除工程文件

---

## 前端设计

### 1. 数据模型设计

#### TypeScript类型定义

```typescript
// src/types/project.ts

/**
 * 工程分类枚举
 */
export enum ProjectCategory {
  CATEGORY_1 = '分类1',
  CATEGORY_2 = '分类2',
  CUSTOM = '自定义分类'
}

/**
 * 硬件平台枚举
 */
export enum HardwarePlatform {
  HMI_MODEL_1 = 'HMI型号1',
  HMI_MODEL_2 = 'HMI型号2',
  GATEWAY_MODEL_1 = '网关型号1'
}

/**
 * 工程元数据
 */
export interface ProjectMetadata {
  name: string              // 工程名称 (必填)
  author?: string           // 工程作者 (可选)
  description?: string      // 工程描述 (可选)
  category: ProjectCategory // 工程分类 (可选)
  platform: HardwarePlatform // 硬件平台 (必选)
  createdAt: string         // 创建时间 (ISO 8601)
  updatedAt: string         // 更新时间 (ISO 8601)
}

/**
 * 工程安全配置
 */
export interface ProjectSecurity {
  encrypted: boolean        // 是否加密
  passwordHash?: string     // 密码哈希（bcrypt，加密时存储）
  fileSignature: string     // 文件签名（HMAC-SHA256）
}

/**
 * 工程数据结构
 */
export interface Project {
  version: string           // 文件格式版本 "1.0.0"
  projectId: string         // UUID v4
  metadata: ProjectMetadata
  security: ProjectSecurity
  canvas: CanvasConfig
  components: Component[]
}

/**
 * 最近工程记录
 */
export interface RecentProject {
  projectId: string
  name: string
  category: ProjectCategory
  filePath: string
  lastOpened: string        // ISO 8601
  isEncrypted: boolean
}
```

### 2. MobX状态管理

```typescript
// src/store/projectStore.ts

import { makeAutoObservable, observable, runInAction } from 'mobx'
import { Project, ProjectMetadata } from '@/types/project'
import { projectApi } from '@/api/projectApi'

export class ProjectStore {
  // 当前打开的工程
  currentProject: Project | null = null

  // 工程状态
  projectStatus: 'new' | 'opened' | 'modified' | 'saved' = 'new'

  // 加载状态
  isLoading: boolean = false

  // 错误信息
  error: string | null = null

  constructor() {
    makeAutoObservable(this)
  }

  /**
   * 创建新工程
   */
  async createProject(metadata: ProjectMetadata, security: {
    encrypted: boolean
    password?: string
    savePath: string
  }) {
    runInAction(() => {
      this.isLoading = true
      this.error = null
    })

    try {
      const result = await projectApi.createProject({
        metadata,
        security: {
          encrypted: security.encrypted,
          // 密码在前端进行bcrypt哈希
          passwordHash: security.encrypted
            ? await this.hashPassword(security.password!)
            : undefined,
          fileSignature: '' // 将由后端生成
        },
        savePath: security.savePath
      })

      runInAction(() => {
        this.currentProject = result.project
        this.projectStatus = 'saved'
        this.isLoading = false
      })

      return result.project
    } catch (error) {
      runInAction(() => {
        this.error = error.message
        this.isLoading = false
      })
      throw error
    }
  }

  /**
   * 打开工程
   */
  async openProject(filePath: string, password?: string) {
    runInAction(() => {
      this.isLoading = true
      this.error = null
    })

    try {
      const result = await projectApi.openProject({
        filePath,
        password
      })

      runInAction(() => {
        this.currentProject = result.project
        this.projectStatus = 'opened'
        this.isLoading = false
      })

      return result.project
    } catch (error) {
      runInAction(() => {
        this.error = error.message
        this.isLoading = false
      })
      throw error
    }
  }

  /**
   * 保存工程
   */
  async saveProject() {
    if (!this.currentProject) {
      throw new Error('没有打开的工程')
    }

    runInAction(() => {
      this.isLoading = true
      this.error = null
    })

    try {
      await projectApi.saveProject(this.currentProject)

      runInAction(() => {
        this.projectStatus = 'saved'
        this.isLoading = false
      })
    } catch (error) {
      runInAction(() => {
        this.error = error.message
        this.isLoading = false
      })
      throw error
    }
  }

  /**
   * 密码哈希（前端）
   */
  private async hashPassword(password: string): Promise<string> {
    const bcrypt = await import('bcryptjs')
    const salt = await bcrypt.genSalt(10)
    return bcrypt.hash(password, salt)
  }
}

export const projectStore = new ProjectStore()
```

```typescript
// src/store/recentProjectsStore.ts

import { makeAutoObservable, runInAction } from 'mobx'
import { RecentProject, ProjectCategory } from '@/types/project'
import { recentProjectsManager } from '@/utils/recentProjectsManager'

export class RecentProjectsStore {
  // 最近工程列表
  recentProjects: RecentProject[] = []

  // 当前选中的分类筛选
  selectedCategory: ProjectCategory | '全部' = '全部'

  // 搜索关键词
  searchQuery: string = ''

  // 排序方式
  sortBy: 'lastOpened' | 'name' | 'createdAt' = 'lastOpened'

  // 排序方向
  sortOrder: 'asc' | 'desc' = 'desc'

  constructor() {
    makeAutoObservable(this)
    this.loadRecentProjects()
  }

  /**
   * 加载最近工程
   */
  async loadRecentProjects() {
    try {
      const projects = await recentProjectsManager.getAll()
      runInAction(() => {
        this.recentProjects = projects
      })
    } catch (error) {
      console.error('加载最近工程失败:', error)
    }
  }

  /**
   * 添加或更新最近工程
   */
  async addOrUpdateRecentProject(project: RecentProject) {
    await recentProjectsManager.addOrUpdate(project)
    await this.loadRecentProjects()
  }

  /**
   * 从列表中移除工程
   */
  async removeRecentProject(projectId: string) {
    await recentProjectsManager.remove(projectId)
    await this.loadRecentProjects()
  }

  /**
   * 计算属性：过滤后的列表
   */
  get filteredProjects(): RecentProject[] {
    let filtered = [...this.recentProjects]

    // 分类筛选
    if (this.selectedCategory !== '全部') {
      filtered = filtered.filter(
        p => p.category === this.selectedCategory
      )
    }

    // 搜索过滤
    if (this.searchQuery) {
      const query = this.searchQuery.toLowerCase()
      filtered = filtered.filter(p =>
        p.name.toLowerCase().includes(query)
      )
    }

    // 排序
    filtered = this.sortProjects(filtered)

    return filtered
  }

  /**
   * 计算属性：分类统计
   */
  get categoryStats(): Map<ProjectCategory | '全部', number> {
    const stats = new Map<ProjectCategory | '全部', number>()
    stats.set('全部', this.recentProjects.length)

    this.recentProjects.forEach(project => {
      const count = stats.get(project.category) || 0
      stats.set(project.category, count + 1)
    })

    return stats
  }

  /**
   * 排序工程
   */
  private sortProjects(projects: RecentProject[]): RecentProject[] {
    return projects.sort((a, b) => {
      let comparison = 0

      switch (this.sortBy) {
        case 'lastOpened':
          comparison = new Date(b.lastOpened).getTime() -
                       new Date(a.lastOpened).getTime()
          break
        case 'name':
          comparison = a.name.localeCompare(b.name)
          break
        case 'createdAt':
          comparison = new Date(b.lastOpened).getTime() -
                       new Date(a.lastOpened).getTime()
          break
      }

      return this.sortOrder === 'asc' ? -comparison : comparison
    })
  }

  /**
   * 设置分类筛选
   */
  setSelectedCategory(category: ProjectCategory | '全部') {
    this.selectedCategory = category
  }

  /**
   * 设置搜索关键词
   */
  setSearchQuery(query: string) {
    this.searchQuery = query
  }

  /**
   * 设置排序方式
   */
  setSortBy(sortBy: 'lastOpened' | 'name' | 'createdAt') {
    this.sortBy = sortBy
  }

  /**
   * 切换排序方向
   */
  toggleSortOrder() {
    this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc'
  }
}

export const recentProjectsStore = new RecentProjectsStore()
```

### 3. UI组件设计

#### NewProjectDialog组件

```typescript
// src/components/project/NewProjectDialog.tsx

import React, { useState } from 'react'
import { observer } from 'mobx-react-lite'
import { projectStore } from '@/store/projectStore'
import { ProjectCategory, HardwarePlatform } from '@/types/project'
import './NewProjectDialog.css'

interface NewProjectDialogProps {
  onClose: () => void
  onProjectCreated: (project: Project) => void
}

const NewProjectDialog: React.FC<NewProjectDialogProps> = observer(
  ({ onClose, onProjectCreated }) => {
    // 表单状态
    const [formData, setFormData] = useState({
      name: '',
      author: '',
      description: '',
      category: ProjectCategory.CATEGORY_1,
      platform: HardwarePlatform.HMI_MODEL_1,
      encrypted: false,
      password: '',
      confirmPassword: '',
      savePath: ''
    })

    // 验证错误
    const [errors, setErrors] = useState<Record<string, string>>({})

    // 自定义分类输入
    const [customCategory, setCustomCategory] = useState('')
    const [showCustomCategory, setShowCustomCategory] = useState(false)

    /**
     * 验证表单
     */
    const validateForm = (): boolean => {
      const newErrors: Record<string, string> = {}

      if (!formData.name.trim()) {
        newErrors.name = '工程名称不能为空'
      } else if (formData.name.length > 50) {
        newErrors.name = '工程名称不能超过50个字符'
      }

      if (formData.author && formData.author.length > 30) {
        newErrors.author = '作者名称不能超过30个字符'
      }

      if (formData.description && formData.description.length > 500) {
        newErrors.description = '工程描述不能超过500个字符'
      }

      if (!formData.savePath) {
        newErrors.savePath = '请选择工程保存位置'
      }

      if (formData.encrypted) {
        if (!formData.password) {
          newErrors.password = '请设置密码'
        } else if (formData.password.length < 6) {
          newErrors.password = '密码至少6个字符'
        } else if (formData.password !== formData.confirmPassword) {
          newErrors.confirmPassword = '两次输入的密码不一致'
        }
      }

      setErrors(newErrors)
      return Object.keys(newErrors).length === 0
    }

    /**
     * 选择保存位置
     */
    const handleSelectPath = async () => {
      try {
        const result = await window.electronAPI.showSaveDialog({
          title: '选择工程保存位置',
          defaultPath: `${formData.name}.pant`,
          filters: [
            { name: 'PanTools工程', extensions: ['pant'] }
          ]
        })

        if (result.filePath) {
          setFormData(prev => ({
            ...prev,
            savePath: result.filePath
          }))
        }
      } catch (error) {
        console.error('选择路径失败:', error)
      }
    }

    /**
     * 创建工程
     */
    const handleCreate = async () => {
      if (!validateForm()) {
        return
      }

      try {
        // 处理自定义分类
        let category = formData.category
        if (showCustomCategory && customCategory) {
          category = customCategory as any
        }

        const project = await projectStore.createProject(
          {
            name: formData.name,
            author: formData.author || undefined,
            description: formData.description || undefined,
            category,
            platform: formData.platform,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          },
          {
            encrypted: formData.encrypted,
            password: formData.password || undefined,
            savePath: formData.savePath
          }
        )

        onProjectCreated(project)
        onClose()
      } catch (error) {
        setErrors({ form: error.message })
      }
    }

    /**
     * 计算密码强度
     */
    const getPasswordStrength = (): 'weak' | 'medium' | 'strong' => {
      if (!formData.password) return 'weak'

      let strength = 0
      if (formData.password.length >= 8) strength++
      if (formData.password.length >= 12) strength++
      if (/[A-Z]/.test(formData.password)) strength++
      if (/[a-z]/.test(formData.password)) strength++
      if (/[0-9]/.test(formData.password)) strength++
      if (/[^A-Za-z0-9]/.test(formData.password)) strength++

      if (strength <= 2) return 'weak'
      if (strength <= 4) return 'medium'
      return 'strong'
    }

    return (
      <div className="dialog-overlay" onClick={onClose}>
        <div className="dialog new-project-dialog" onClick={e => e.stopPropagation()}>
          {/* 对话框头部 */}
          <div className="dialog-header">
            <h2 className="dialog-title">新建工程</h2>
            <button className="dialog-close" onClick={onClose}>✕</button>
          </div>

          {/* 表单内容 */}
          <div className="dialog-body">
            {errors.form && (
              <div className="alert alert-error">{errors.form}</div>
            )}

            {/* 基本信息 */}
            <div className="form-section">
              <h3 className="form-section-title">基本信息</h3>

              <div className="form-field">
                <label className="form-label required">
                  工程名称
                </label>
                <input
                  type="text"
                  className="form-input"
                  value={formData.name}
                  onChange={e => setFormData(prev => ({
                    ...prev,
                    name: e.target.value
                  }))}
                  maxLength={50}
                  placeholder="请输入工程名称"
                />
                {errors.name && (
                  <span className="form-error">{errors.name}</span>
                )}
              </div>

              <div className="form-field">
                <label className="form-label">工程作者</label>
                <input
                  type="text"
                  className="form-input"
                  value={formData.author}
                  onChange={e => setFormData(prev => ({
                    ...prev,
                    author: e.target.value
                  }))}
                  maxLength={30}
                  placeholder="请输入作者名称（可选）"
                />
                {errors.author && (
                  <span className="form-error">{errors.author}</span>
                )}
              </div>

              <div className="form-field">
                <label className="form-label">工程描述</label>
                <textarea
                  className="form-textarea"
                  value={formData.description}
                  onChange={e => setFormData(prev => ({
                    ...prev,
                    description: e.target.value
                  }))}
                  maxLength={500}
                  rows={3}
                  placeholder="请输入工程描述（可选）"
                />
                {errors.description && (
                  <span className="form-error">{errors.description}</span>
                )}
              </div>
            </div>

            {/* 技术配置 */}
            <div className="form-section">
              <h3 className="form-section-title">技术配置</h3>

              <div className="form-field">
                <label className="form-label required">
                  工程分类
                </label>
                <select
                  className="form-select"
                  value={showCustomCategory ? 'custom' : formData.category}
                  onChange={e => {
                    if (e.target.value === 'custom') {
                      setShowCustomCategory(true)
                    } else {
                      setShowCustomCategory(false)
                      setFormData(prev => ({
                        ...prev,
                        category: e.target.value as ProjectCategory
                      }))
                    }
                  }}
                >
                  <option value={ProjectCategory.CATEGORY_1}>分类1</option>
                  <option value={ProjectCategory.CATEGORY_2}>分类2</option>
                  <option value="custom">自定义分类...</option>
                </select>
              </div>

              {showCustomCategory && (
                <div className="form-field">
                  <label className="form-label">自定义分类名称</label>
                  <input
                    type="text"
                    className="form-input"
                    value={customCategory}
                    onChange={e => setCustomCategory(e.target.value)}
                    placeholder="请输入分类名称"
                  />
                </div>
              )}

              <div className="form-field">
                <label className="form-label required">
                  硬件平台
                </label>
                <select
                  className="form-select"
                  value={formData.platform}
                  onChange={e => setFormData(prev => ({
                    ...prev,
                    platform: e.target.value as HardwarePlatform
                  }))}
                >
                  <option value={HardwarePlatform.HMI_MODEL_1}>HMI型号1</option>
                  <option value={HardwarePlatform.HMI_MODEL_2}>HMI型号2</option>
                  <option value={HardwarePlatform.GATEWAY_MODEL_1}>网关型号1</option>
                </select>
              </div>

              <div className="form-field">
                <label className="form-label required">
                  工程保存位置
                </label>
                <div className="form-input-group">
                  <input
                    type="text"
                    className="form-input"
                    value={formData.savePath}
                    readOnly
                    placeholder="请选择保存位置"
                  />
                  <button
                    type="button"
                    className="btn btn-secondary"
                    onClick={handleSelectPath}
                  >
                    浏览...
                  </button>
                </div>
                {errors.savePath && (
                  <span className="form-error">{errors.savePath}</span>
                )}
              </div>
            </div>

            {/* 安全配置 */}
            <div className="form-section">
              <h3 className="form-section-title">安全配置</h3>

              <div className="form-field">
                <label className="form-checkbox">
                  <input
                    type="checkbox"
                    checked={formData.encrypted}
                    onChange={e => setFormData(prev => ({
                      ...prev,
                      encrypted: e.target.checked
                    }))}
                  />
                  <span>启用工程加密</span>
                </label>
              </div>

              {formData.encrypted && (
                <>
                  <div className="form-field">
                    <label className="form-label required">
                      密码
                    </label>
                    <input
                      type="password"
                      className="form-input"
                      value={formData.password}
                      onChange={e => setFormData(prev => ({
                        ...prev,
                        password: e.target.value
                      }))}
                      placeholder="请输入密码（至少6个字符）"
                    />
                    {formData.password && (
                      <div className={`password-strength strength-${getPasswordStrength()}`}>
                        密码强度: {
                          getPasswordStrength() === 'weak' ? '弱' :
                          getPasswordStrength() === 'medium' ? '中' : '强'
                        }
                      </div>
                    )}
                    {errors.password && (
                      <span className="form-error">{errors.password}</span>
                    )}
                  </div>

                  <div className="form-field">
                    <label className="form-label required">
                      确认密码
                    </label>
                    <input
                      type="password"
                      className="form-input"
                      value={formData.confirmPassword}
                      onChange={e => setFormData(prev => ({
                        ...prev,
                        confirmPassword: e.target.value
                      }))}
                      placeholder="请再次输入密码"
                    />
                    {errors.confirmPassword && (
                      <span className="form-error">{errors.confirmPassword}</span>
                    )}
                  </div>
                </>
              )}
            </div>
          </div>

          {/* 对话框底部 */}
          <div className="dialog-footer">
            <button
              type="button"
              className="btn btn-secondary"
              onClick={onClose}
            >
              取消
            </button>
            <button
              type="button"
              className="btn btn-primary"
              onClick={handleCreate}
              disabled={projectStore.isLoading}
            >
              {projectStore.isLoading ? '创建中...' : '确定'}
            </button>
          </div>
        </div>
      </div>
    )
  }
)

export default NewProjectDialog
```

#### RecentProjectsList组件

```typescript
// src/components/workspace/RecentProjectsList.tsx

import React, { useState, useEffect, useRef } from 'react'
import { observer } from 'mobx-react-lite'
import { FixedSizeList as List } from 'react-window'
import { recentProjectsStore } from '@/store/recentProjectsStore'
import { projectStore } from '@/store/projectStore'
import { RecentProject, ProjectCategory } from '@/types/project'
import { formatRelativeTime } from '@/utils/dateFormat'
import ProjectListItem from './ProjectListItem'
import CategoryFilter from './CategoryFilter'
import SearchBox from './SearchBox'
import './RecentProjectsList.css'

const RecentProjectsList: React.FC = observer(() => {
  const [contextMenu, setContextMenu] = useState<{
    visible: boolean
    x: number
    y: number
    project: RecentProject | null
  }>({
    visible: false,
    x: 0,
    y: 0,
    project: null
  })

  const listRef = useRef<List>(null)

  /**
   * 打开工程
   */
  const handleOpenProject = async (project: RecentProject) => {
    try {
      if (project.isEncrypted) {
        // 显示密码对话框
        const password = await showPasswordDialog(project.name)
        await projectStore.openProject(project.filePath, password)
      } else {
        await projectStore.openProject(project.filePath)
      }

      // 更新最后打开时间
      await recentProjectsStore.addOrUpdateRecentProject({
        ...project,
        lastOpened: new Date().toISOString()
      })
    } catch (error) {
      console.error('打开工程失败:', error)
    }
  }

  /**
   * 显示密码对话框
   */
  const showPasswordDialog = (projectName: string): Promise<string> => {
    return new Promise((resolve, reject) => {
      // TODO: 实现密码对话框
      const password = prompt(`请输入工程"${projectName}"的密码:`)
      if (password) {
        resolve(password)
      } else {
        reject(new Error('未输入密码'))
      }
    })
  }

  /**
   * 显示右键菜单
   */
  const handleContextMenu = (
    e: React.MouseEvent,
    project: RecentProject
  ) => {
    e.preventDefault()
    setContextMenu({
      visible: true,
      x: e.clientX,
      y: e.clientY,
      project
    })
  }

  /**
   * 关闭右键菜单
   */
  const handleCloseContextMenu = () => {
    setContextMenu({
      visible: false,
      x: 0,
      y: 0,
      project: null
    })
  }

  /**
   * 在文件管理器中显示
   */
  const handleShowInExplorer = async (filePath: string) => {
    try {
      await window.electronAPI.showItemInFolder(filePath)
    } catch (error) {
      console.error('打开文件管理器失败:', error)
    }
    handleCloseContextMenu()
  }

  /**
   * 从列表中移除
   */
  const handleRemoveFromList = async (projectId: string) => {
    try {
      await recentProjectsStore.removeRecentProject(projectId)
    } catch (error) {
      console.error('移除失败:', error)
    }
    handleCloseContextMenu()
  }

  /**
   * 复制工程路径
   */
  const handleCopyPath = async (filePath: string) => {
    try {
      await navigator.clipboard.writeText(filePath)
      // TODO: 显示复制成功提示
    } catch (error) {
      console.error('复制路径失败:', error)
    }
    handleCloseContextMenu()
  }

  // 渲染列表项
  const Row = ({ index, style }: { index: number; style: React.CSSProperties }) => {
    const project = recentProjectsStore.filteredProjects[index]

    return (
      <div style={style}>
        <ProjectListItem
          project={project}
          onOpen={handleOpenProject}
          onContextMenu={handleContextMenu}
        />
      </div>
    )
  }

  const filteredProjects = recentProjectsStore.filteredProjects

  return (
    <div className="recent-projects-list">
      {/* 顶部工具栏 */}
      <div className="recent-projects-toolbar">
        <CategoryFilter
          selectedCategory={recentProjectsStore.selectedCategory}
          categoryStats={recentProjectsStore.categoryStats}
          onCategoryChange={category =>
            recentProjectsStore.setSelectedCategory(category)
          }
        />
        <SearchBox
          value={recentProjectsStore.searchQuery}
          onChange={query => recentProjectsStore.setSearchQuery(query)}
        />
      </div>

      {/* 工程列表 */}
      {filteredProjects.length === 0 ? (
        <div className="empty-state">
          <p>没有找到最近工程</p>
        </div>
      ) : (
        <List
          ref={listRef}
          height={600}
          itemCount={filteredProjects.length}
          itemSize={80}
          width="100%"
        >
          {Row}
        </List>
      )}

      {/* 右键菜单 */}
      {contextMenu.visible && contextMenu.project && (
        <div
          className="context-menu"
          style={{
            left: contextMenu.x,
            top: contextMenu.y
          }}
          onClick={handleCloseContextMenu}
        >
          <div
            className="context-menu-item"
            onClick={() => handleOpenProject(contextMenu.project!)}
          >
            打开工程
          </div>
          <div
            className="context-menu-item"
            onClick={() => handleShowInExplorer(contextMenu.project!.filePath)}
          >
            在文件管理器中显示
          </div>
          <div
            className="context-menu-item"
            onClick={() => handleCopyPath(contextMenu.project!.filePath)}
          >
            复制工程路径
          </div>
          <div className="context-menu-divider" />
          <div
            className="context-menu-item context-menu-item-danger"
            onClick={() => handleRemoveFromList(contextMenu.project!.projectId)}
          >
            从列表中移除
          </div>
        </div>
      )}
    </div>
  )
})

export default RecentProjectsList
```

---

## 后端设计

### 1. API端点设计

#### 创建工程API

```go
// platform/scada/backend/internal/api/project_api.go

package api

import (
    "github.com/gofiber/fiber/v2"
    "pansiot-scada/internal/service"
)

type ProjectApi struct {
    projectService *service.ProjectService
}

func NewProjectApi(projectService *service.ProjectService) *ProjectApi {
    return &ProjectApi{
        projectService: projectService,
    }
}

// CreateProjectRequest 创建工程请求
type CreateProjectRequest struct {
    Metadata  service.ProjectMetadata   `json:"metadata"`
    Security  service.ProjectSecurity   `json:"security"`
    SavePath  string                    `json:"savePath"`
}

// CreateProjectResponse 创建工程响应
type CreateProjectResponse struct {
    Success   bool                      `json:"success"`
    Data      CreateProjectData         `json:"data,omitempty"`
    Error     string                    `json:"error,omitempty"`
}

type CreateProjectData struct {
    ProjectId string   `json:"projectId"`
    FilePath  string   `json:"filePath"`
}

// CreateProject 创建新工程
func (api *ProjectApi) CreateProject(c *fiber.Ctx) error {
    var req CreateProjectRequest
    if err := c.BodyParser(&req); err != nil {
        return c.Status(400).JSON(fiber.Map{
            "success": false,
            "error":   "Invalid request body",
        })
    }

    // 验证必填字段
    if req.Metadata.Name == "" {
        return c.Status(400).JSON(fiber.Map{
            "success": false,
            "error":   "Project name is required",
        })
    }

    if req.Metadata.Platform == "" {
        return c.Status(400).JSON(fiber.Map{
            "success": false,
            "error":   "Hardware platform is required",
        })
    }

    if req.SavePath == "" {
        return c.Status(400).JSON(fiber.Map{
            "success": false,
            "error":   "Save path is required",
        })
    }

    // 调用服务层创建工程
    project, err := api.projectService.CreateProject(
        req.Metadata,
        req.Security,
        req.SavePath,
    )

    if err != nil {
        return c.Status(500).JSON(fiber.Map{
            "success": false,
            "error":   err.Error(),
        })
    }

    return c.JSON(CreateProjectResponse{
        Success: true,
        Data: CreateProjectData{
            ProjectId: project.ProjectId,
            FilePath:  req.SavePath,
        },
    })
}

// OpenProjectRequest 打开工程请求
type OpenProjectRequest struct {
    FilePath string  `json:"filePath"`
    Password string  `json:"password,omitempty"`
}

// OpenProject 打开工程
func (api *ProjectApi) OpenProject(c *fiber.Ctx) error {
    var req OpenProjectRequest
    if err := c.BodyParser(&req); err != nil {
        return c.Status(400).JSON(fiber.Map{
            "success": false,
            "error":   "Invalid request body",
        })
    }

    // 调用服务层打开工程
    project, err := api.projectService.OpenProject(
        req.FilePath,
        req.Password,
    )

    if err != nil {
        if err == service.ErrInvalidPassword {
            return c.Status(401).JSON(fiber.Map{
                "success": false,
                "error":   "INVALID_PASSWORD",
                "message": "密码错误",
            })
        }

        return c.Status(500).JSON(fiber.Map{
            "success": false,
            "error":   err.Error(),
        })
    }

    return c.JSON(fiber.Map{
        "success": true,
        "data": fiber.Map{
            "project": project,
        },
    })
}

// SaveProject 保存工程
func (api *ProjectApi) SaveProject(c *fiber.Ctx) error {
    var project model.Project
    if err := c.BodyParser(&project); err != nil {
        return c.Status(400).JSON(fiber.Map{
            "success": false,
            "error":   "Invalid request body",
        })
    }

    err := api.projectService.SaveProject(&project)
    if err != nil {
        return c.Status(500).JSON(fiber.Map{
            "success": false,
            "error":   err.Error(),
        })
    }

    return c.JSON(fiber.Map{
        "success": true,
    })
}

// RegisterRoutes 注册路由
func (api *ProjectApi) RegisterRoutes(app *fiber.App) {
    apiGroup := app.Group("/api/projects")

    apiGroup.Post("/create", api.CreateProject)
    apiGroup.Post("/open", api.OpenProject)
    apiGroup.Post("/save", api.SaveProject)
}
```

### 2. 服务层设计

```go
// platform/scada/backend/internal/service/project_service.go

package service

import (
    "crypto/rand"
    "encoding/hex"
    "encoding/json"
    "errors"
    "fmt"
    "io/ioutil"
    "os"
    "path/filepath"
    "time"

    "pansiot-scada/internal/model"
    "pansiot-scada/internal/security"
)

var (
    ErrInvalidPassword = errors.New("invalid password")
    ErrFileCorrupted   = errors.New("file signature verification failed")
)

type ProjectService struct {
    encryptionService *security.EncryptionService
    fileService       *FileService
}

type ProjectMetadata struct {
    Name        string    `json:"name"`
    Author      string    `json:"author,omitempty"`
    Description string    `json:"description,omitempty"`
    Category    string    `json:"category"`
    Platform    string    `json:"platform"`
    CreatedAt   string    `json:"createdAt"`
    UpdatedAt   string    `json:"updatedAt"`
}

type ProjectSecurity struct {
    Encrypted    bool   `json:"encrypted"`
    PasswordHash string `json:"passwordHash,omitempty"`
}

func NewProjectService(
    encryptionService *security.EncryptionService,
    fileService *FileService,
) *ProjectService {
    return &ProjectService{
        encryptionService: encryptionService,
        fileService:       fileService,
    }
}

// CreateProject 创建新工程
func (s *ProjectService) CreateProject(
    metadata ProjectMetadata,
    securityConfig ProjectSecurity,
    savePath string,
) (*model.Project, error) {
    // 生成UUID
    projectId, err := generateUUID()
    if err != nil {
        return nil, err
    }

    // 创建工程对象
    project := &model.Project{
        Version:   "1.0.0",
        ProjectId: projectId,
        Metadata: model.ProjectMetadata{
            Name:        metadata.Name,
            Author:      metadata.Author,
            Description: metadata.Description,
            Category:    metadata.Category,
            Platform:    metadata.Platform,
            CreatedAt:   time.Now().Format(time.RFC3339),
            UpdatedAt:   time.Now().Format(time.RFC3339),
        },
        Security: model.ProjectSecurity{
            Encrypted: securityConfig.Encrypted,
        },
        Canvas:     model.CanvasConfig{},
        Components: []model.Component{},
    }

    // 如果启用加密，哈希密码
    if securityConfig.Encrypted {
        if securityConfig.PasswordHash == "" {
            return nil, errors.New("password is required for encryption")
        }
        project.Security.PasswordHash = securityConfig.PasswordHash
    }

    // 生成文件签名
    signature, err := s.encryptionService.GenerateSignature(project)
    if err != nil {
        return nil, err
    }
    project.Security.FileSignature = signature

    // 序列化工程数据
    data, err := json.MarshalIndent(project, "", "  ")
    if err != nil {
        return nil, err
    }

    // 如果启用加密，加密数据
    if securityConfig.Encrypted {
        encryptedData, err := s.encryptionService.Encrypt(
            data,
            securityConfig.PasswordHash,
        )
        if err != nil {
            return nil, err
        }
        data = encryptedData
    }

    // 写入文件
    if err := s.fileService.WriteFile(savePath, data, 0644); err != nil {
        return nil, err
    }

    return project, nil
}

// OpenProject 打开工程
func (s *ProjectService) OpenProject(
    filePath string,
    password string,
) (*model.Project, error) {
    // 读取文件
    data, err := s.fileService.ReadFile(filePath)
    if err != nil {
        return nil, err
    }

    var project model.Project

    // 尝试解密（如果是加密文件）
    if s.encryptionService.IsEncrypted(data) {
        if password == "" {
            return nil, errors.New("password required for encrypted project")
        }

        decryptedData, err := s.encryptionService.Decrypt(data, password)
        if err != nil {
            // 验证密码是否正确
            return nil, ErrInvalidPassword
        }

        if err := json.Unmarshal(decryptedData, &project); err != nil {
            return nil, err
        }

        // 验证文件签名
        if !s.encryptionService.VerifySignature(&project) {
            return nil, ErrFileCorrupted
        }
    } else {
        // 未加密文件
        if err := json.Unmarshal(data, &project); err != nil {
            return nil, err
        }

        // 验证文件签名
        if !s.encryptionService.VerifySignature(&project) {
            return nil, ErrFileCorrupted
        }
    }

    return &project, nil
}

// SaveProject 保存工程
func (s *ProjectService) SaveProject(project *model.Project) error {
    // 更新修改时间
    project.Metadata.UpdatedAt = time.Now().Format(time.RFC3339)

    // 重新生成文件签名
    signature, err := s.encryptionService.GenerateSignature(project)
    if err != nil {
        return err
    }
    project.Security.FileSignature = signature

    // 序列化
    data, err := json.MarshalIndent(project, "", "  ")
    if err != nil {
        return err
    }

    // 如果加密，加密数据
    if project.Security.Encrypted {
        // TODO: 从某处获取密码
        // encryptedData, err := s.encryptionService.Encrypt(data, password)
        // if err != nil {
        //     return err
        // }
        // data = encryptedData
    }

    // 写入文件
    filePath := filepath.Join(project.Metadata.SavePath, project.Metadata.Name + ".pant")
    return s.fileService.WriteFile(filePath, data, 0644)
}

// generateUUID 生成UUID v4
func generateUUID() (string, error) {
    bytes := make([]byte, 16)
    if _, err := rand.Read(bytes); err != nil {
        return "", err
    }

    bytes[6] = (bytes[6] & 0x0f) | 0x40 // Version 4
    bytes[8] = (bytes[8] & 0x3f) | 0x80 // Variant 10

    return hex.EncodeToString(bytes), nil
}
```

### 3. 加密服务设计

```go
// platform/scada/backend/internal/security/encryption.go

package security

import (
    "crypto/aes"
    "crypto/cipher"
    "crypto/hmac"
    "crypto/rand"
    "crypto/sha256"
    "encoding/base64"
    "encoding/json"
    "errors"
    "fmt"
    "io"

    "golang.org/x/crypto/pbkdf2"

    "pansiot-scada/internal/model"
)

const (
    // PBKDF2参数
    pbkdf2Iterations = 100000
    saltSize        = 32
    keySize         = 32

    // AES-GCM参数
    gcmNonceSize = 12
    gcmTagSize   = 16
)

type EncryptionService struct{}

func NewEncryptionService() *EncryptionService {
    return &EncryptionService{}
}

// EncryptedData 加密数据结构
type EncryptedData struct {
    Salt      string `json:"salt"`
    Nonce     string `json:"nonce"`
    Ciphertext string `json:"ciphertext"`
}

// Encrypt 加密数据
func (s *EncryptionService) Encrypt(
    plaintext []byte,
    password string,
) ([]byte, error) {
    // 生成盐值
    salt := make([]byte, saltSize)
    if _, err := io.ReadFull(rand.Reader, salt); err != nil {
        return nil, err
    }

    // 派生密钥
    key := pbkdf2.Key([]byte(password), salt, pbkdf2Iterations, keySize, sha256.New)

    // 创建AES cipher
    block, err := aes.NewCipher(key)
    if err != nil {
        return nil, err
    }

    // 创建GCM模式
    gcm, err := cipher.NewGCM(block)
    if err != nil {
        return nil, err
    }

    // 生成nonce
    nonce := make([]byte, gcmNonceSize)
    if _, err := io.ReadFull(rand.Reader, nonce); err != nil {
        return nil, err
    }

    // 加密
    ciphertext := gcm.Seal(nil, nonce, plaintext, nil)

    // 构建加密数据结构
    encryptedData := EncryptedData{
        Salt:      base64.StdEncoding.EncodeToString(salt),
        Nonce:     base64.StdEncoding.EncodeToString(nonce),
        Ciphertext: base64.StdEncoding.EncodeToString(ciphertext),
    }

    return json.Marshal(encryptedData)
}

// Decrypt 解密数据
func (s *EncryptionService) Decrypt(
    ciphertext []byte,
    password string,
) ([]byte, error) {
    // 解析加密数据
    var encryptedData EncryptedData
    if err := json.Unmarshal(ciphertext, &encryptedData); err != nil {
        return nil, err
    }

    // 解码Base64
    salt, err := base64.StdEncoding.DecodeString(encryptedData.Salt)
    if err != nil {
        return nil, err
    }

    nonce, err := base64.StdEncoding.DecodeString(encryptedData.Nonce)
    if err != nil {
        return nil, err
    }

    ciphertextRaw, err := base64.StdEncoding.DecodeString(encryptedData.Ciphertext)
    if err != nil {
        return nil, err
    }

    // 派生密钥
    key := pbkdf2.Key([]byte(password), salt, pbkdf2Iterations, keySize, sha256.New)

    // 创建AES cipher
    block, err := aes.NewCipher(key)
    if err != nil {
        return nil, err
    }

    // 创建GCM模式
    gcm, err := cipher.NewGCM(block)
    if err != nil {
        return nil, err
    }

    // 解密
    plaintext, err := gcm.Open(nil, nonce, ciphertextRaw, nil)
    if err != nil {
        return nil, err
    }

    return plaintext, nil
}

// IsEncrypted 检查数据是否已加密
func (s *EncryptionService) IsEncrypted(data []byte) bool {
    var encryptedData EncryptedData
    return json.Unmarshal(data, &encryptedData) == nil
}

// GenerateSignature 生成文件签名
func (s *EncryptionService) GenerateSignature(
    project *model.Project,
) (string, error) {
    // 将工程数据序列化（不包括签名字段）
    data := map[string]interface{}{
        "version":   project.Version,
        "projectId": project.ProjectId,
        "metadata":  project.Metadata,
        "canvas":    project.Canvas,
        "components": project.Components,
    }

    jsonData, err := json.Marshal(data)
    if err != nil {
        return "", err
    }

    // 生成HMAC-SHA256签名
    h := hmac.New(sha256.New, []byte("pansiot-secret-key"))
    h.Write(jsonData)

    return fmt.Sprintf("%x", h.Sum(nil)), nil
}

// VerifySignature 验证文件签名
func (s *EncryptionService) VerifySignature(project *model.Project) bool {
    // 重新生成签名
    signature, err := s.GenerateSignature(project)
    if err != nil {
        return false
    }

    // 比对签名
    return signature == project.Security.FileSignature
}
```

---

## 文件格式设计

### 工程文件格式 (.pant)

```json
{
  "version": "1.0.0",
  "projectId": "550e8400-e29b-41d4-a716-446655440000",
  "metadata": {
    "name": "工厂生产线监控",
    "author": "张三",
    "description": "用于监控工厂生产线的HMI界面",
    "category": "工业监控",
    "platform": "HMI型号1",
    "createdAt": "2026-01-21T10:00:00Z",
    "updatedAt": "2026-01-21T10:00:00Z"
  },
  "security": {
    "encrypted": false,
    "fileSignature": "a3d8f7c4b2e1..."
  },
  "canvas": {
    "width": 1920,
    "height": 1080,
    "backgroundColor": "#1a1a1a"
  },
  "components": [
    {
      "id": "comp_001",
      "type": "gauge",
      "x": 100,
      "y": 100,
      "width": 200,
      "height": 200,
      "properties": {
        "minValue": 0,
        "maxValue": 100,
        "dataBinding": "DV-PLC001-TEMP01"
      }
    }
  ]
}
```

### 加密工程文件格式

```json
{
  "salt": "base64_encoded_salt",
  "nonce": "base64_encoded_nonce",
  "ciphertext": "base64_encoded_encrypted_data"
}
```

---

## 安全策略

### 1. 密码存储

- 使用bcrypt算法哈希密码（10轮）
- 哈希后的密码存储在工程文件中
- 验证时比对哈希值

### 2. 文件加密

- 算法：AES-256-GCM
- 密钥派生：PBKDF2 (100,000轮)
- 认证加密：防止篡改
- 随机Nonce：每次加密不同

### 3. 文件签名

- 算法：HMAC-SHA256
- 签名内容：工程核心数据（不含签名字段）
- 防篡改检测：打开时验证签名

### 4. 密码强度

- 最小长度：6个字符
- 强度评估：长度、大小写、数字、特殊字符
- 实时强度指示

---

## 性能优化

### 前端优化

1. **虚拟滚动**
   - 使用react-window
   - 只渲染可见区域
   - 支持50+工程列表流畅滚动

2. **搜索防抖**
   - 100ms延迟
   - 避免频繁过滤

3. **状态缓存**
   - MobX computed缓存
   - 避免重复计算

### 后端优化

1. **流式读写**
   - 大文件分块处理
   - 避免内存占用过高

2. **异步处理**
   - 长时间操作异步化
   - 进度回调

3. **数据库索引**
   - 最近工程按时间索引
   - 快速查询

---

## 错误处理

### 错误码定义

| 错误码 | 描述 | HTTP状态码 |
|-------|------|-----------|
| INVALID_PARAMS | 参数错误 | 400 |
| PROJECT_EXISTS | 工程已存在 | 409 |
| PROJECT_NOT_FOUND | 工程不存在 | 404 |
| INVALID_PASSWORD | 密码错误 | 401 |
| FILE_CORRUPTED | 文件损坏 | 422 |
| SIGNATURE_FAILED | 签名验证失败 | 422 |
| INTERNAL_ERROR | 内部错误 | 500 |

---

## 测试策略

### 单元测试

- [ ] 工程序列化/反序列化
- [ ] 加密/解密功能
- [ ] 签名生成/验证
- [ ] MobX Store操作
- [ ] 表单验证逻辑

### 集成测试

- [ ] 创建工程API
- [ ] 打开工程API
- [ ] 保存工程API
- [ ] 密码验证流程

### E2E测试

- [ ] 完整创建工程流程
- [ ] 完整打开工程流程
- [ ] 最近工程筛选
- [ ] 最近工程搜索

---

## 部署方案

### 开发环境

```bash
# 前端
cd platforms/scada/packages/renderer
pnpm install
pnpm dev

# 后端
cd platforms/scada/backend
go mod download
go run main.go
```

### 生产构建

```bash
# 前端打包
pnpm build

# 后端编译
go build -o scada-server main.go

# Electron打包
pnpm --filter desktop build
```

---

## 未来扩展

### 云端同步

1. **工程上传**
   - API: POST /api/cloud/upload
   - 上传.pant文件到云端
   - 记录云端版本ID

2. **工程下载**
   - API: GET /api/cloud/download/:projectId
   - 从云端下载工程
   - 合并本地和云端版本

3. **冲突解决**
   - 时间戳比较
   - 三方合并策略
   - 用户手动选择

### 协作编辑

1. **实时同步**
   - WebSocket连接
   - 操作转换（OT）
   - 冲突解决

2. **权限管理**
   - 所有者/编辑者/查看者
   - 权限验证

---

## 相关文档

- 需求文档: REQ-002, FE-002, US-002
- 实施计划: IMP-002 (待创建)
- 架构决策: ADR-002 (待创建)

---

**文档版本**: 1.0
**最后更新**: 2026-01-21
**审批人**: 待审批
